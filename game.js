// è´ç‰Œã§ GO! - ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯

const translations = {
    ja: {
        gameTitle: "ğŸ€„ è´ç‰Œã§ GO! ğŸ€„",
        gameSubtitle: "éº»é›€ å¾…ã¡å½“ã¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°",
        selectMode: "ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„",
        casualMode: "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«",
        casualDesc: "å…¨ 9 å• + BOSS ã‚¹ãƒ†ãƒ¼ã‚¸\nå„å• 45 ç§’ / 3 ãƒ©ã‚¤ãƒ•åˆ¶",
        storyMode: "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼",
        storyDesc: "åˆç´š â†’ ä¸­ç´š â†’ ä¸Šç´šã®å„ 3 å• + BOSS\nå„å• 30 ç§’ / 3ãƒ©ã‚¤ãƒ•åˆ¶",
        survivalMode: "ã‚µãƒã‚¤ãƒãƒ«",
        survivalDesc: "60 ç§’ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ\næ­£è§£ã§ã‚¿ã‚¤ãƒ å›å¾© / ãƒ©ã‚¤ãƒ•ãªã—",
        selectDifficulty: "é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„",
        easy: "åˆç´š",
        easyDesc: "æœ€å¤§ 3 é¢å¼µã¾ã§",
        medium: "ä¸­ç´š",
        mediumDesc: "æœ€å¤§ 6 é¢å¼µã¾ã§",
        hard: "ä¸Šç´š",
        hardDesc: "æœ€å¤§ 9 é¢å¼µã¾ã§",
        handTitle: "ğŸ´ æ‰‹ç‰Œ ğŸ´",
        selectWaiting: "ğŸ¯ å¾…ã¡ç‰Œã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„ ğŸ¯",
        submitAnswer: "âœ¨ å›ç­”ã™ã‚‹ âœ¨",
        correct: "ğŸ‰ æ­£è§£ï¼ãƒŠã‚¤ã‚¹ã‚¢ã‚¬ãƒªï¼ ğŸ‰",
        incorrect: "âŒ ä¸æ­£è§£ã§ã™...",
        timeUp: "â° æ™‚é–“åˆ‡ã‚Œï¼",
        correctAnswer: "ğŸ’¡ æ­£è§£ã®å¾…ã¡ï¼š",
        nextQuestion: "â¡ï¸ æ¬¡ã®å•é¡Œã¸",
        question: "ç¬¬",
        bossStage: "ğŸ”¥ BOSS ã‚¹ãƒ†ãƒ¼ã‚¸ ğŸ”¥",
        bossChallenge: "è²¯ã‚ãŸã‚¿ã‚¤ãƒ ã§æŒ‘æˆ¦ï¼",
        bossComplete: "BOSS æ’ƒç ´ï¼ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼",
        victory: "ğŸŠ å®Œå…¨åˆ¶è¦‡ï¼ ğŸŠ",
        gameOver: "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼",
        finalQuestions: "åˆ°é”å•é¡Œæ•°ï¼š",
        finalScore: "åˆè¨ˆæ­£è§£æ•°ï¼š",
        timeLeftLabel: "æ®‹ã‚Šæ™‚é–“ï¼š",
        answerTimeLabel: "è§£ç­”æ™‚é–“ï¼š",
        secondsUnit: "ç§’",
        livesLeftLabel: "æ®‹ã‚Šãƒ©ã‚¤ãƒ•ï¼š",
        modeLabel: "ãƒ¢ãƒ¼ãƒ‰ï¼š",
        playAgain: "ã‚‚ã†ä¸€åº¦éŠã¶",
        backToMenu: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹",
        back: "æˆ»ã‚‹",
        footer: "è´ç‰Œã§ GO!",
        selectLanguage: "è¨€èªã‚’é¸æŠ / Select Language",
        japanese: "æ—¥æœ¬èª",
        english: "English",
        chinese: "ç¹é«”ä¸­æ–‡",
        allBreakdown: "ğŸ“‹ å¾…ã¡ç‰Œã®æ§‹æˆï¼ˆã‚¢ã‚¬ãƒªå½¢ï¼‰ï¼š",
        winningTile: "ğŸ¯ å¾…ã¡ï¼š",
        head: "é›€é ­",
        meld: "é¢å­",
        pair: "å¯¾å­",
        triplet: "åˆ»å­",
        sequence: "é †å­",
        pin: "ç­’å­",
        man: "è¬å­",
        sou: "ç´¢å­",
        lives: "ãƒ©ã‚¤ãƒ•ï¼š",
        loseLife: "ãƒ©ã‚¤ãƒ•æ¸›å°‘",
        continue: "ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼",
        giveUp: "ã‚ãã‚‰ã‚ã‚‹",
        stage: "ã‚¹ãƒ†ãƒ¼ã‚¸",
        difficulty: "é›£æ˜“åº¦",
        maxWaits: "æœ€å¤§å¾…ã¡æ•°ï¼š",
        correctCount: "æ­£è§£æ•°ï¼š",
        paused: "â¸ï¸ ä¸€æ™‚åœæ­¢ä¸­",
        tapToResume: "ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å†é–‹",
        timeExtension: "â±ï¸ é•·è€ƒï¼ˆã‚¿ã‚¤ãƒ å»¶é•·ï¼‰",
        timeExtensionDesc: "+30 ç§’",
        extensionsLeft: "ã‚ã¨",
        ok: "OK",

        tutorial: "ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«",
        tutorialTitle: "éŠã³æ–¹",
        tutorialPrev: "æˆ»ã‚‹",
        tutorialNext: "æ¬¡ã¸",
        tutorialClose: "é–‰ã˜ã‚‹",
        tutorialFinish: "å®Œäº†",

        tutorialP1Title: "ã‚²ãƒ¼ãƒ ã®ç›®çš„",
        tutorialP1Body: "è¡¨ç¤ºã•ã‚ŒãŸè´ç‰Œï¼ˆãƒ†ãƒ³ãƒ‘ã‚¤ï¼‰ã®æ‰‹ç‰Œã‹ã‚‰ã€ã‚¢ã‚¬ãƒªç‰Œï¼ˆå¾…ã¡ç‰Œï¼‰ã‚’ã™ã¹ã¦è¦‹ã¤ã‘å‡ºã—ã¾ã—ã‚‡ã†ã€‚\n\nãƒã‚¤ãƒ³ãƒˆï¼š\nãƒ»å¾…ã¡ã¯è¤‡æ•°ã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™\nãƒ»æ‰‹ç‰Œã§ 4 æšä½¿ã£ã¦ã„ã‚‹ç‰Œã¯ã€å¾…ã¡ç‰Œã«ã¯ãªã‚Šã¾ã›ã‚“",

        tutorialP2Title: "æ“ä½œæ–¹æ³•",
        tutorialP2Body: "1) ç”»é¢ä¸‹ã® 1 ã€œ 9 ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã€å¾…ã¡ç‰Œã‚’ã™ã¹ã¦é¸æŠ\n2) ã€Œå›ç­”ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§åˆ¤å®š\n\nãƒ’ãƒ³ãƒˆï¼š\nãƒ»ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨é¸æŠè§£é™¤ã§ãã¾ã™\nãƒ»æ™‚é–“åˆ‡ã‚Œã«ãªã£ã¦ã‚‚ã€ç‰Œã‚’ä¸€æšã§ã‚‚é¸æŠã—ã¦ã„ã‚Œã°è‡ªå‹•çš„ã«æå‡ºã•ã‚Œã¾ã™",

        tutorialP3Title: "é›£æ˜“åº¦ã«ã¤ã„ã¦",
        tutorialP3Body: "åˆç´šï¼šæœ€å¤§ 3 é¢å¼µ\nä¸­ç´šï¼šæœ€å¤§ 6 é¢å¼µ\nä¸Šç´šï¼šæœ€å¤§ 9 é¢å¼µ\n\nã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ã‚¹ãƒ†ãƒ¼ã‚¸ãŒé€²ã‚€ã”ã¨ã«é›£æ˜“åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚",

        tutorialP4Title: "é•·è€ƒï¼ˆã‚¿ã‚¤ãƒ å»¶é•·ï¼‰",
        tutorialP4Body: "ã€Œé•·è€ƒã€ãƒœã‚¿ãƒ³ã§æ™‚é–“ã‚’å¢—ã‚„ã›ã¾ã™ã€‚\nãƒ»1 å›ã«ã¤ã +30 ç§’\nãƒ»æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªããªã‚‹ã¨è¿·ã‚ãšä½¿ã£ã¦ã—ã¾ã„ã¾ã—ã‚‡ã†\n\nâ€» BOSS ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ãŒã€æ®‹ã£ãŸå›æ•°åˆ†ãŒ BOSS ã‚¹ãƒ†ãƒ¼ã‚¸ã®åˆ¶é™æ™‚é–“ã«åŠ ç®—ã•ã‚Œã¾ã™ã€‚",

        tutorialP5Title: "BOSS ã‚¹ãƒ†ãƒ¼ã‚¸",
        tutorialP5Body: "ã‚¹ãƒ†ãƒ¼ã‚¸ 10 ã¯ BOSS æˆ¦ã§ã™ã€‚\nã“ã‚Œã¾ã§ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã§ä½™ã£ãŸã€Œæ®‹ã‚Šæ™‚é–“ã®åˆè¨ˆã€ãŒåˆ¶é™æ™‚é–“ã«ãªã‚Šã¾ã™ã€‚æ­£è§£ã™ã‚Œã°ã‚¯ãƒªã‚¢ã§ã™ï¼"
    },
    en: {
        gameTitle: "ğŸ€„ Tenpai de GO! ğŸ€„",
        gameSubtitle: "Mahjong Waiting Tile Trainer",
        selectMode: "Select Mode",
        casualMode: "Casual",
        casualDesc: "9 Questions + BOSS\n45s per tile / 3 Lives",
        storyMode: "Story",
        storyDesc: "Easy â†’ Med â†’ Hard (3 levels each) + BOSS\n30s per tile / 3 Lives",
        survivalMode: "Survival",
        survivalDesc: "Start with 60s\nCorrect answers restore time / No lives",
        selectDifficulty: "Select Difficulty",
        easy: "Easy",
        easyDesc: "Up to 3-way waits",
        medium: "Medium",
        mediumDesc: "Up to 6-way waits",
        hard: "Hard",
        hardDesc: "Up to 9-way waits",
        handTitle: "ğŸ´ Your Hand ğŸ´",
        selectWaiting: "ğŸ¯ Select ALL Winning Tiles (Waits) ğŸ¯",
        submitAnswer: "âœ¨ Submit âœ¨",
        correct: "ğŸ‰ Correct! Nice Hand! ğŸ‰",
        incorrect: "âŒ Wrong Answer...",
        timeUp: "â° Time's Up!",
        correctAnswer: "ğŸ’¡ Correct Waits:",
        nextQuestion: "â¡ï¸ Next Question",
        question: "Stage",
        bossStage: "ğŸ”¥ BOSS STAGE ğŸ”¥",
        bossChallenge: "Use your saved time!",
        bossComplete: "BOSS Defeated! Congratulations!",
        victory: "ğŸŠ ALL CLEARED! ğŸŠ",
        gameOver: "GAME OVER",
        finalQuestions: "Stages Completed:",
        finalScore: "Total Correct:",
        timeLeftLabel: "Time Left:",
        answerTimeLabel: "Answer Time:",
        secondsUnit: "s",
        livesLeftLabel: "Lives:",
        modeLabel: "Mode:",
        playAgain: "Play Again",
        backToMenu: "Main Menu",
        back: "Back",
        footer: "Tenpai de GO!",
        selectLanguage: "Select Language",
        japanese: "Japanese",
        english: "English",
        chinese: "ç¹é«”ä¸­æ–‡",
        allBreakdown: "ğŸ“‹ Hand Structure for each wait:",
        winningTile: "ğŸ¯ Wait:",
        head: "Pair",
        meld: "Meld",
        pair: "Pair",
        triplet: "Pung (Triplet)",
        sequence: "Chow (Sequence)",
        pin: "Circles (Pin)",
        man: "Characters (Man)",
        sou: "Bamboos (Sou)",
        lives: "Lives:",
        loseLife: "Life Lost",
        continue: "Continue",
        giveUp: "Give Up",
        stage: "Stage",
        difficulty: "Difficulty",
        maxWaits: "Max Waits:",
        correctCount: "Correct:",
        paused: "â¸ï¸ PAUSED",
        tapToResume: "Tap to Resume",
        timeExtension: "â±ï¸ Think Time (+30s)",
        timeExtensionDesc: "+30s",
        extensionsLeft: "Left:",
        ok: "OK",

        tutorial: "Tutorial",
        tutorialTitle: "How to Play",
        tutorialPrev: "Back",
        tutorialNext: "Next",
        tutorialClose: "Close",
        tutorialFinish: "Finish",

        tutorialP1Title: "Goal",
        tutorialP1Body: "Your hand is in 'Tenpai' (one tile away from winning).\nFind and select ALL possible winning tiles (waits).\n\nKey Points:\n- There may be multiple different winning tiles.\n- Tiles already used 4 times in your hand cannot be waits.",

        tutorialP2Title: "Controls",
        tutorialP2Body: "1) Tap the tile icons (1-9) to select your waits.\n2) Tap 'Submit' to check your answer.\n\nTips:\n- Tap a selected tile again to unselect it.\n- If time runs out, your current selection will be auto-submitted.",

        tutorialP3Title: "Difficulty Levels",
        tutorialP3Body: "Easy: Up to 3-way waits.\nMedium: Up to 6-way waits.\nHard: Up to 9-way waits.\n\nIn Story Mode, the difficulty increases every 3 stages.",

        tutorialP4Title: "Think Time (+30s)",
        tutorialP4Body: "Use 'Think Time' to extend 30 seconds to your current stage.\n- Use it when the timer turns red.\n\nNote: Cannot be used during the BOSS Stage, but unused charges will be converted into extra time for the BOSS battle.",

        tutorialP5Title: "The BOSS Stage",
        tutorialP5Body: "Stage 10 is the BOSS stage.\nYour time limit is the sum of all remaining time from previous stages. If you answer correctly, you win this game!"
    },
    zh: {
        gameTitle: "ğŸ€„ è½ç‰Œ GO! ğŸ€„",
        gameSubtitle: "éº»é›€è½ç‰Œå¼·åŒ–è¨“ç·´",
        selectMode: "è«‹é¸æ“‡éŠæˆ²æ¨¡å¼",
        casualMode: "ä¼‘é–’æ¨¡å¼",
        casualDesc: "å…¨ 9 é¡Œ + BOSSé—œå¡\næ¯é¡Œ 45 ç§’ / 3 æ¢ç”Ÿå‘½",
        storyMode: "é—–é—œæ¨¡å¼",
        storyDesc: "åˆç´š â†’ ä¸­ç´š â†’ é«˜ç´šå„ 3 é¡Œ + BOSS\næ¯é¡Œ 30 ç§’ / 3 æ¢ç”Ÿå‘½",
        survivalMode: "ç”Ÿå­˜æ¨¡å¼",
        survivalDesc: "60 ç§’é–‹å§‹\nç­”å°å¯å›å¾©æ™‚é–“ / ç„¡ç”Ÿå‘½é™åˆ¶",
        selectDifficulty: "è«‹é¸æ“‡é›£åº¦",
        easy: "åˆç´š",
        easyDesc: "æœ€å¤š 3 é¢è½",
        medium: "ä¸­ç´š",
        mediumDesc: "æœ€å¤š 6 é¢è½",
        hard: "é«˜ç´š",
        hardDesc: "æœ€å¤š 9 é¢è½",
        handTitle: "ğŸ´ ç›®å‰æ‰‹ç‰Œ ğŸ´",
        selectWaiting: "ğŸ¯ è«‹é¸å‡ºæ‰€æœ‰è½çš„ç‰Œ ğŸ¯",
        submitAnswer: "âœ¨ ç¢ºèªç­”æ¡ˆ âœ¨",
        correct: "ğŸ‰ æ­£ç¢ºï¼é«˜æ‰‹ï¼ ğŸ‰",
        incorrect: "âŒ ç­”éŒ¯äº†...",
        timeUp: "â° æ™‚é–“åˆ°ï¼",
        correctAnswer: "ğŸ’¡ æ­£ç¢ºè½ç‰Œï¼š",
        nextQuestion: "â¡ï¸ ä¸‹ä¸€é¡Œ",
        question: "ç¬¬",
        bossStage: "ğŸ”¥ BOSS é—œå¡ ğŸ”¥",
        bossChallenge: "ä½¿ç”¨ç´¯ç©æ™‚é–“æŒ‘æˆ°ï¼",
        bossComplete: "æ“Šæ•— BOSSï¼æ­å–œé€šé—œï¼",
        victory: "ğŸŠ å…¨éƒ¨é€šé—œï¼ ğŸŠ",
        gameOver: "éŠæˆ²çµæŸ",
        finalQuestions: "åˆ°é”é¡Œç›®æ•¸ï¼š",
        finalScore: "ç¸½æ­£ç¢ºæ•¸ï¼š",
        timeLeftLabel: "å‰©é¤˜æ™‚é–“ï¼š",
        answerTimeLabel: "ç­”é¡Œæ™‚é–“ï¼š",
        secondsUnit: "ç§’",
        livesLeftLabel: "å‰©é¤˜ç”Ÿå‘½ï¼š",
        modeLabel: "æ¨¡å¼ï¼š",
        playAgain: "å†ç©ä¸€æ¬¡",
        backToMenu: "è¿”å›é¸å–®",
        back: "è¿”å›",
        footer: "è½ç‰Œ GO!",
        selectLanguage: "é¸æ“‡èªè¨€ / Select Language",
        japanese: "æ—¥æœ¬èª",
        english: "English",
        chinese: "ç¹é«”ä¸­æ–‡",
        allBreakdown: "ğŸ“‹ è½ç‰Œæ‹†è§£ï¼ˆé£Ÿèƒ¡ç‰Œå‹ï¼‰ï¼š",
        winningTile: "ğŸ¯ è½ï¼š",
        head: "å°‡çœ¼",
        meld: "é¢å­",
        pair: "å°å­",
        triplet: "åˆ»å­",
        sequence: "é †å­",
        pin: "ç­’å­",
        man: "è¬å­",
        sou: "ç´¢å­",
        lives: "ç”Ÿå‘½å€¼ï¼š",
        loseLife: "ç”Ÿå‘½æ¸›å°‘",
        continue: "ç¹¼çºŒéŠæˆ²",
        giveUp: "æ”¾æ£„",
        stage: "é—œå¡",
        difficulty: "é›£åº¦",
        maxWaits: "æœ€å¤§è½ç‰Œæ•¸ï¼š",
        correctCount: "æ­£ç¢ºæ•¸ï¼š",
        paused: "â¸ï¸ å·²æš«åœ",
        tapToResume: "é»æ“Šè¢å¹•ç¹¼çºŒ",
        timeExtension: "â±ï¸ é•·è€ƒï¼ˆå¢åŠ æ™‚é–“ï¼‰",
        timeExtensionDesc: "+30 ç§’",
        extensionsLeft: "å‰©é¤˜",
        ok: "ç¢ºèª",

        tutorial: "æ•™å­¸",
        tutorialTitle: "éŠæˆ²ç©æ³•",
        tutorialPrev: "ä¸Šä¸€é ",
        tutorialNext: "ä¸‹ä¸€é ",
        tutorialClose: "é—œé–‰",
        tutorialFinish: "å®Œæˆ",

        tutorialP1Title: "éŠæˆ²ç›®æ¨™",
        tutorialP1Body: "æ ¹æ“šé¡¯ç¤ºçš„æ‰‹ç‰Œï¼ˆè½ç‰Œç‹€æ…‹ï¼‰ï¼Œæ‰¾å‡ºæ‰€æœ‰å¯ä»¥é£Ÿèƒ¡çš„ã€Œè½ç‰Œã€ã€‚\n\næ³¨æ„é»ï¼š\nãƒ»è½ç‰Œå¯èƒ½ä¸åªä¸€å¼µï¼ˆå¤šé¢è½ï¼‰\nãƒ»æ‰‹ç‰Œä¸­å·²ç¶“ä½¿ç”¨äº† 4 å¼µçš„ç‰Œï¼Œä¸èƒ½ä½œç‚ºè½ç‰Œ",

        tutorialP2Title: "æ“ä½œæ–¹å¼",
        tutorialP2Body: "1) é»æ“Šä¸‹æ–¹ 1 ï½ 9 çš„æŒ‰éˆ•ï¼Œé¸å‡ºæ‰€æœ‰è½ç‰Œ\n2) é»æ“Šã€Œç¢ºèªç­”æ¡ˆã€é€²è¡Œåˆ¤å®š\n\næç¤ºï¼š\nãƒ»å†æ¬¡é»æ“Šå·²é¸ä¸­çš„ç‰Œå¯å–æ¶ˆé¸æ“‡\nãƒ»æ™‚é–“çµæŸæ™‚ï¼Œè‹¥å·²æœ‰é¸ç‰Œæœƒè‡ªå‹•æäº¤",

        tutorialP3Title: "é›£åº¦èªªæ˜",
        tutorialP3Body: "åˆç´šï¼šæœ€å¤š 3 é¢è½\nä¸­ç´šï¼šæœ€å¤š 6 é¢è½\né«˜ç´šï¼šæœ€å¤š 9 é¢è½\n\nåœ¨ã€Œé—–é—œæ¨¡å¼ã€ä¸­ï¼Œé›£åº¦æœƒéš¨è‘—é—œå¡é€²åº¦æå‡ã€‚",

        tutorialP4Title: "é•·è€ƒï¼ˆå¢åŠ æ™‚é–“ï¼‰",
        tutorialP4Body: "å¯ä½¿ç”¨ã€Œé•·è€ƒã€æŒ‰éˆ•ã€‚\nãƒ»æ¯æ¬¡ä½¿ç”¨å¯å¢åŠ  30 ç§’\nãƒ»æ™‚é–“å¿«çµæŸæ™‚ï¼ŒæŒ‰éˆ•æœƒé–ƒçˆæç¤º\n\nâ€» BOSS é—œå¡ä¸èƒ½ä½¿ç”¨ï¼Œä½†å‰©é¤˜æ¬¡æ•¸æœƒè‡ªå‹•è½‰åŒ–ç‚º BOSS é—œå¡çš„é¡å¤–æ™‚é–“ã€‚",

        tutorialP5Title: "BOSS é—œå¡",
        tutorialP5Body: "ç¬¬ 10 é—œç‚º BOSS é—œå¡ã€‚\nä½ çš„æŒ‘æˆ°æ™‚é–“ç­‰æ–¼ä¹‹å‰é—œå¡ã€Œç¯€çœä¸‹ä¾†çš„ç¸½æ™‚é–“ã€ã€‚ç­”å°å³å¯é€šé—œï¼"
    }
};

let tutorialPageIndex = 0;

function getTutorialPages() {
    return [
        { title: t('tutorialP1Title'), body: t('tutorialP1Body') },
        { title: t('tutorialP2Title'), body: t('tutorialP2Body') },
        { title: t('tutorialP3Title'), body: t('tutorialP3Body') },
        { title: t('tutorialP4Title'), body: t('tutorialP4Body') },
        { title: t('tutorialP5Title'), body: t('tutorialP5Body') }
    ];
}

function renderTutorialPage() {
    const screen = document.getElementById('tutorial-screen');
    if (!screen || screen.classList.contains('hidden')) return;

    const pages = getTutorialPages();
    const total = pages.length;
    const idx = Math.min(Math.max(0, tutorialPageIndex), total - 1);
    tutorialPageIndex = idx;

    const indicator = document.getElementById('tutorial-page-indicator');
    const titleEl = document.getElementById('tutorial-page-title');
    const bodyEl = document.getElementById('tutorial-page-body');
    const prevBtn = document.getElementById('tutorial-prev-btn');
    const nextBtn = document.getElementById('tutorial-next-btn');
    const closeBtn = document.getElementById('tutorial-close-btn');
    const prevText = document.getElementById('tutorial-prev-text');
    const nextText = document.getElementById('tutorial-next-text');
    const closeText = document.getElementById('tutorial-close-text');

    if (indicator) indicator.textContent = `${idx + 1}/${total}`;
    if (titleEl) titleEl.textContent = pages[idx].title || '';
    if (bodyEl) bodyEl.textContent = pages[idx].body || '';

    if (prevText) prevText.textContent = t('tutorialPrev');
    if (nextText) nextText.textContent = (idx === total - 1) ? t('tutorialFinish') : t('tutorialNext');
    if (closeText) closeText.textContent = t('tutorialClose');

    if (prevBtn) prevBtn.disabled = idx === 0;
    if (nextBtn) nextBtn.disabled = false;
    if (closeBtn) closeBtn.disabled = false;
}

let currentLang = 'ja';
const t = (key) => translations[currentLang][key] || key;

let stageIntroTimeoutId = null;

function getDifficultyBadgeHtml(diffKey) {
    const key = diffKey || 'easy';
    const diffName = t(key);
    const diffBadgeClass = key === 'easy'
        ? 'difficulty-badge difficulty-badge--easy'
        : key === 'medium'
            ? 'difficulty-badge difficulty-badge--medium'
            : 'difficulty-badge difficulty-badge--hard';
    return `<span class="${diffBadgeClass}">${diffName}</span>`;
}

function getModeDisplayText(modeKey) {
    if (!modeKey) return '';
    const map = {
        casual: 'casualMode',
        story: 'storyMode',
        survival: 'survivalMode'
    };
    const i18nKey = map[modeKey] || modeKey;
    return t(i18nKey);
}

function hideStageIntro({ immediate = false } = {}) {
    const overlay = document.getElementById('stage-intro');
    if (!overlay) return;

    if (stageIntroTimeoutId) {
        clearTimeout(stageIntroTimeoutId);
        stageIntroTimeoutId = null;
    }

    if (immediate) {
        overlay.classList.add('hidden');
        overlay.classList.remove('is-leaving');
        overlay.setAttribute('aria-hidden', 'true');
        return;
    }

    overlay.classList.add('is-leaving');
    stageIntroTimeoutId = setTimeout(() => {
        overlay.classList.add('hidden');
        overlay.classList.remove('is-leaving');
        overlay.setAttribute('aria-hidden', 'true');
        stageIntroTimeoutId = null;
    }, 460);
}

function showStageIntro({ titleText, subtitleHtml, durationMs }) {
    const overlay = document.getElementById('stage-intro');
    const titleEl = document.getElementById('stage-intro-title');
    const subtitleEl = document.getElementById('stage-intro-subtitle');
    if (!overlay || !titleEl || !subtitleEl) return Promise.resolve();

    if (stageIntroTimeoutId) {
        clearTimeout(stageIntroTimeoutId);
        stageIntroTimeoutId = null;
    }

    // å®‰å…¨ã®ãŸã‚ï¼šã‚¤ãƒ³ãƒˆãƒ­è¡¨ç¤ºä¸­ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹
    stopTimer();

    titleEl.textContent = titleText || '';
    subtitleEl.innerHTML = subtitleHtml || '';

    overlay.classList.remove('hidden');
    overlay.classList.remove('is-leaving');
    overlay.setAttribute('aria-hidden', 'false');

    const ms = Math.min(5000, Math.max(3000, durationMs ?? 3800));

    return new Promise((resolve) => {
        stageIntroTimeoutId = setTimeout(() => {
            hideStageIntro();
            resolve();
        }, ms);
    });
}

function isDebugScaleEnabled() {
    try {
        return new URLSearchParams(window.location.search).get('debug') === '1';
    } catch {
        return false;
    }
}

function ensureScaleDebugOverlay() {
    if (!isDebugScaleEnabled()) return null;
    let overlay = document.getElementById('scale-debug');
    if (overlay) return overlay;

    overlay = document.createElement('div');
    overlay.id = 'scale-debug';
    overlay.className = 'scale-debug';
    document.body.appendChild(overlay);
    return overlay;
}

function applyUiScale() {
    const stage = document.getElementById('scale-stage');
    if (!stage) return;

    const baseWidth = 1280;
    const baseHeight = 720;

    const viewportWidth = window.visualViewport?.width ?? window.innerWidth;
    const viewportHeight = window.visualViewport?.height ?? window.innerHeight;

    // ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã®è¡¨ç¤ºãƒãƒ¼ã‚„ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã€å°‘ã—ä½™ç™½ã‚’ç¢ºä¿
    const safetyPadding = 8;
    const availableWidth = Math.max(0, viewportWidth - safetyPadding * 2);
    const availableHeight = Math.max(0, viewportHeight - safetyPadding * 2);

    // å¸¸ã«ã€Œ16:9 ã®è¨­è¨ˆç”»é¢ï¼ˆ1280x720ï¼‰ã‚’æ­ªã‚ãšã€ãã®ã¾ã¾ç”»é¢å†…ã«åã‚ã‚‹ã€
    // ï¼ç¸¦æ¨ªã©ã¡ã‚‰ã‹å°ã•ã„æ–¹ã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆè£åˆ‡ã‚Šã¯ã—ãªã„ï¼‰
    const scale = Math.min(availableWidth / baseWidth, availableHeight / baseHeight);
    // æ¥µå°ç”»é¢å‘ã‘ã«æœ€å°å€¤ã¯ç¶­æŒ
    const clamped = Math.max(0.05, scale);

    document.documentElement.style.setProperty('--ui-scale', clamped.toFixed(4));

    // è¡¨ç¤ºå€ç‡/ã‚µã‚¤ã‚ºå•é¡Œã®èª¿æŸ»ç”¨ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
    const overlay = ensureScaleDebugOverlay();
    if (overlay) {
        stage.classList.add('debug-outline');
        const rect = stage.getBoundingClientRect();
        overlay.textContent = [
            `visualViewport: ${Math.round(viewportWidth)}x${Math.round(viewportHeight)} (css px)`,
            `available: ${Math.round(availableWidth)}x${Math.round(availableHeight)} (padding ${safetyPadding}*2)`,
            `scale: ${clamped.toFixed(4)}  DPR: ${window.devicePixelRatio || 1}`,
            `stage rect: ${Math.round(rect.width)}x${Math.round(rect.height)} (px)`,
            `stage base: ${baseWidth}x${baseHeight} (design)`,
        ].join('\n');
    } else {
        stage.classList.remove('debug-outline');
    }
}

function hideResultActions() {
    const actions = document.getElementById('result-actions');
    if (!actions) return;

    actions.classList.add('hidden');

    const title = document.getElementById('result-actions-title');
    const body = document.getElementById('result-actions-body');
    if (title) title.textContent = '';
    if (body) body.textContent = '';

    const continueBtn = document.getElementById('result-continue-btn');
    const backBtn = document.getElementById('result-back-btn');
    const okBtn = document.getElementById('result-ok-btn');
    if (continueBtn) continueBtn.classList.add('hidden');
    if (backBtn) backBtn.classList.add('hidden');
    if (okBtn) okBtn.classList.add('hidden');
}

let pendingOkAction = null;

function showResultOkAction({ titleText, titleClassName, bodyText = '', okText = null, onOk }) {
    const actions = document.getElementById('result-actions');
    if (!actions) return;

    const title = document.getElementById('result-actions-title');
    const body = document.getElementById('result-actions-body');
    const continueBtn = document.getElementById('result-continue-btn');
    const backBtn = document.getElementById('result-back-btn');
    const okBtn = document.getElementById('result-ok-btn');
    const okTextSpan = document.getElementById('result-ok-text');

    pendingOkAction = typeof onOk === 'function' ? onOk : null;

    if (title) {
        title.textContent = titleText || '';
        title.className = titleClassName || 'text-3xl font-black mb-3 text-center';
    }
    if (body) body.textContent = bodyText || '';

    if (continueBtn) continueBtn.classList.add('hidden');
    if (backBtn) backBtn.classList.add('hidden');

    if (okTextSpan) okTextSpan.textContent = okText || t('ok');
    if (okBtn) {
        okBtn.classList.remove('hidden');
        okBtn.disabled = false;
        okBtn.onclick = () => {
            if (!pendingOkAction) return;
            okBtn.disabled = true;
            const action = pendingOkAction;
            pendingOkAction = null;
            action();
        };
    }

    actions.classList.remove('hidden');
}

function showResultLifeAction() {
    const actions = document.getElementById('result-actions');
    if (!actions) return;

    const title = document.getElementById('result-actions-title');
    const body = document.getElementById('result-actions-body');
    if (title) {
        title.textContent = t('loseLife');
        title.className = 'text-3xl font-black mb-3 text-yellow-300 text-center';
    }
    if (body) {
        const lives = Math.max(0, gameState.lives);
        const maxLives = Math.max(0, gameState.maxLives || 3);

        let heartsHtml = '<div class="result-lives" aria-label="lives">';
        for (let i = 0; i < maxLives; i++) {
            if (i < lives) {
                heartsHtml += '<span class="life-heart">â¤ï¸</span>';
                continue;
            }

            // â¤ï¸/ğŸ–¤ ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€å¤±ã£ãŸåˆ†ã‚’åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹
            if (i === lives) {
                heartsHtml += '<span id="result-pending-loss-heart" class="life-heart heart-toggle pending-loss">'
                    + '<span class="heart-on">â¤ï¸</span>'
                    + '<span class="heart-off">ğŸ–¤</span>'
                    + '</span>';
                continue;
            }

            heartsHtml += '<span class="life-heart">ğŸ–¤</span>';
        }
        heartsHtml += '</div>';

        body.innerHTML = heartsHtml;
    }

    const continueBtn = document.getElementById('result-continue-btn');
    const backBtn = document.getElementById('result-back-btn');
    const okBtn = document.getElementById('result-ok-btn');
    const continueText = document.getElementById('result-continue-text');
    const backText = document.getElementById('result-back-text');
    if (continueText) continueText.textContent = t('continue');
    if (backText) backText.textContent = t('giveUp');

    if (okBtn) okBtn.classList.add('hidden');

    if (continueBtn) {
        continueBtn.classList.remove('hidden');
        continueBtn.disabled = false;
        continueBtn.onclick = () => {
            playSound('continue');
            // ç¶šè¡Œå‰ã«ã€å¤±ã£ãŸãƒ©ã‚¤ãƒ•ãŒæ¶ˆãˆã‚‹æ¼”å‡ºã‚’å…¥ã‚Œã‚‹
            continueBtn.disabled = true;
            const pending = document.getElementById('result-pending-loss-heart');
            if (!pending) {
                continueGame();
                return;
            }
            pending.classList.remove('pending-loss');
            pending.classList.add('removing');
            setTimeout(() => {
                pending.className = 'life-heart';
                pending.textContent = 'ğŸ–¤';
                continueGame();
            }, 360);
        };
    }
    if (backBtn) {
        backBtn.classList.remove('hidden');
        backBtn.disabled = false;
        backBtn.onclick = () => {
            giveUpGame();
        };
    }

    actions.classList.remove('hidden');
}

function showResultGameOverAction(timeUp) {
    showResultOkAction({
        titleText: t('gameOver'),
        titleClassName: 'text-3xl font-black mb-3 text-red-300 text-center',
        bodyText: '',
        onOk: () => {
            playSound('gameover');
            showGameOverOverlay(timeUp);
        }
    });
}

const tileImages = {
    pin: {
        1: 'Pin1.png',
        2: 'Pin2.png',
        3: 'Pin3.png',
        4: 'Pin4.png',
        5: 'Pin5.png',
        6: 'Pin6.png',
        7: 'Pin7.png',
        8: 'Pin8.png',
        9: 'Pin9.png'
    },
    man: {
        1: 'Man1.png',
        2: 'Man2.png',
        3: 'Man3.png',
        4: 'Man4.png',
        5: 'Man5.png',
        6: 'Man6.png',
        7: 'Man7.png',
        8: 'Man8.png',
        9: 'Man9.png'
    },
    sou: {
        1: 'Sou1.png',
        2: 'Sou2.png',
        3: 'Sou3.png',
        4: 'Sou4.png',
        5: 'Sou5.png',    
        6: 'Sou6.png',
        7: 'Sou7.png',
        8: 'Sou8.png',
        9: 'Sou9.png'
    }
};
const tileNames = {
    ja: {
        pin: { 1: 'ä¸€ç­’ï¼ˆã‚¤ãƒ¼ãƒ”ãƒ³ï¼‰', 2: 'äºŒç­’ï¼ˆãƒªãƒ£ãƒ³ãƒ”ãƒ³ï¼‰', 3: 'ä¸‰ç­’ï¼ˆã‚µãƒ³ãƒ”ãƒ³ï¼‰', 4: 'å››ç­’ï¼ˆã‚¹ãƒ¼ãƒ”ãƒ³ï¼‰', 5: 'äº”ç­’ï¼ˆã‚¦ãƒ¼ãƒ”ãƒ³ï¼‰', 6: 'å…­ç­’ï¼ˆãƒ­ãƒ¼ãƒ”ãƒ³ï¼‰', 7: 'ä¸ƒç­’ï¼ˆãƒãƒ¼ãƒ”ãƒ³ï¼‰', 8: 'å…«ç­’ï¼ˆãƒ‘ãƒ¼ãƒ”ãƒ³ï¼‰', 9: 'ä¹ç­’ï¼ˆã‚­ãƒ¥ãƒ¼ãƒ”ãƒ³ï¼‰' },
        man: { 1: 'ä¸€è¬ï¼ˆã‚¤ãƒ¼ãƒãƒ³ï¼‰', 2: 'äºŒè¬ï¼ˆãƒªãƒ£ãƒ³ãƒãƒ³ï¼‰', 3: 'ä¸‰è¬ï¼ˆã‚µãƒ³ãƒãƒ³ï¼‰', 4: 'å››è¬ï¼ˆã‚¹ãƒ¼ãƒãƒ³ï¼‰', 5: 'äº”è¬ï¼ˆã‚¦ãƒ¼ãƒãƒ³ï¼‰', 6: 'å…­è¬ï¼ˆãƒ­ãƒ¼ãƒãƒ³ï¼‰', 7: 'ä¸ƒè¬ï¼ˆãƒãƒ¼ãƒãƒ³ï¼‰', 8: 'å…«è¬ï¼ˆãƒ‘ãƒ¼ãƒãƒ³ï¼‰', 9: 'ä¹è¬ï¼ˆã‚­ãƒ¥ãƒ¼ãƒãƒ³ï¼‰' },
        sou: { 1: 'ä¸€ç´¢ï¼ˆã‚¤ãƒ¼ã‚½ãƒ¼ï¼‰', 2: 'äºŒç´¢ï¼ˆãƒªãƒ£ãƒ³ã‚½ãƒ¼ï¼‰', 3: 'ä¸‰ç´¢ï¼ˆã‚µãƒ³ã‚½ãƒ¼ï¼‰', 4: 'å››ç´¢ï¼ˆã‚¹ãƒ¼ã‚½ãƒ¼ï¼‰', 5: 'äº”ç´¢ï¼ˆã‚¦ãƒ¼ã‚½ãƒ¼ï¼‰', 6: 'å…­ç´¢ï¼ˆãƒ­ãƒ¼ã‚½ãƒ¼ï¼‰', 7: 'ä¸ƒç´¢ï¼ˆãƒãƒ¼ã‚½ãƒ¼ï¼‰', 8: 'å…«ç´¢ï¼ˆãƒ‘ãƒ¼ã‚½ãƒ¼ï¼‰', 9: 'ä¹ç´¢ï¼ˆã‚­ãƒ¥ãƒ¼ã‚½ãƒ¼ï¼‰' }
    },
    en: {
        pin: { 1: '1-Pin', 2: '2-Pin', 3: '3-Pin', 4: '4-Pin', 5: '5-Pin', 6: '6-Pin', 7: '7-Pin', 8: '8-Pin', 9: '9-Pin' },
        man: { 1: '1-Man', 2: '2-Man', 3: '3-Man', 4: '4-Man', 5: '5-Man', 6: '6-Man', 7: '7-Man', 8: '8-Man', 9: '9-Man' },
        sou: { 1: '1-Sou', 2: '2-Sou', 3: '3-Sou', 4: '4-Sou', 5: '5-Sou', 6: '6-Sou', 7: '7-Sou', 8: '8-Sou', 9: '9-Sou' }
    },
    zh: {
        pin: { 1: 'ä¸€ç­’', 2: 'äºŒç­’', 3: 'ä¸‰ç­’', 4: 'å››ç­’', 5: 'äº”ç­’', 6: 'å…­ç­’', 7: 'ä¸ƒç­’', 8: 'å…«ç­’', 9: 'ä¹ç­’' },
        man: { 1: 'ä¸€è¬', 2: 'äºŒè¬', 3: 'ä¸‰è¬', 4: 'å››è¬', 5: 'äº”è¬', 6: 'å…­è¬', 7: 'ä¸ƒè¬', 8: 'å…«è¬', 9: 'ä¹è¬' },
        sou: { 1: 'ä¸€ç´¢', 2: 'äºŒç´¢', 3: 'ä¸‰ç´¢', 4: 'å››ç´¢', 5: 'äº”ç´¢', 6: 'å…­ç´¢', 7: 'ä¸ƒç´¢', 8: 'å…«ç´¢', 9: 'ä¹ç´¢' }
    }
};

// ã‚¢ã‚»ãƒƒãƒˆï¼ˆassets/ï¼‰é…ä¸‹ã‚’äº‹å‰ã«ã™ã¹ã¦ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒ—ãƒ¬ã‚¤ä¸­ã®å¼•ã£ã‹ã‹ã‚Šã‚’é˜²ã
//ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã¯å®Ÿè¡Œæ™‚ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€è¦§ã‚’å–å¾—ã§ããªã„ãŸã‚ã€é™çš„ãƒªã‚¹ãƒˆã«ã™ã‚‹ï¼‰
const ASSET_FILES = [
    'Back.png', 'Blank.png', 'Chun.png', 'continue.mp3', 'correct.mp3',
    'Front.png', 'gameover.mp3', 'Haku.png', 'Hatsu.png', 'incorrect.mp3',
    'Man1.png', 'Man2.png', 'Man3.png', 'Man4.png', 'Man5-Dora.png', 'Man5.png', 'Man6.png', 'Man7.png', 'Man8.png', 'Man9.png',
    'Nan.png', 'Pei.png',
    'Pin1.png', 'Pin2.png', 'Pin3.png', 'Pin4.png', 'Pin5-Dora.png', 'Pin5.png', 'Pin6.png', 'Pin7.png', 'Pin8.png', 'Pin9.png',
    'select.mp3', 'Shaa.png',
    'Sou1.png', 'Sou2.png', 'Sou3.png', 'Sou4.png', 'Sou5-Dora.png', 'Sou5.png', 'Sou6.png', 'Sou7.png', 'Sou8.png', 'Sou9.png',
    'tap.mp3', 'timer.mp3', 'timeup.mp3', 'Ton.png', 'victory.mp3'
];

function preloadImage(url) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve();
        img.onerror = () => resolve();
        img.src = url;
    });
}

async function preloadAssets({ onProgress } = {}) {
    const urls = ASSET_FILES.map((f) => `assets/${f}`);
    const total = urls.length;
    let loaded = 0;

    const report = () => {
        if (typeof onProgress === 'function') onProgress({ loaded, total });
    };
    report();

    // ç”»é¢æ“ä½œã®åå¿œã‚’è½ã¨ã•ãªã„ç¨‹åº¦ã®ä¸¦åˆ—æ•°ã«æŠ‘ãˆã‚‹
    const concurrency = 6;
    const queue = urls.slice();

    const worker = async () => {
        while (queue.length) {
            const url = queue.shift();
            try {
                if (url.endsWith('.png')) {
                    await preloadImage(url);
                } else {
                    // å–å¾—ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¸©ã‚ã‚‹
                    const res = await fetch(url, { cache: 'force-cache' });
                    if (res && res.ok) {
                        await res.blob();
                    }
                }
            } catch {
                // å€‹åˆ¥ã®ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¤±æ•—ã¯ç„¡è¦–ã—ã¦ã€ã‚²ãƒ¼ãƒ è‡ªä½“ã¯ç¶šè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            } finally {
                loaded++;
                report();
            }
        }
    };

    const workers = Array.from({ length: concurrency }, () => worker());
    await Promise.all(workers);
}

const getTileInfo = (type, number) => {
    const safeType = tileImages[type] ? type : 'pin';
    const src = tileImages[safeType]?.[number] || tileImages.pin[number];
    const name = tileNames[currentLang]?.[safeType]?.[number] || `${number}-${t(safeType)}`;
    return {
        imgSrc: `assets/${src}`,
        name
    };
};

function pickRandomTileType() {
    // è‹±èªUIã§ã¯ç‰Œé¢ãŒæ¼¢å­—ã®ã€Œè¬å­ã€ã‚’é¿ã‘ã‚‹
    const types = currentLang === 'en' ? ['pin', 'sou'] : ['pin', 'man', 'sou'];
    return types[Math.floor(Math.random() * types.length)];
}

// ========== ã‚µã‚¦ãƒ³ãƒ‰ ==========
const soundConfig = {
    // é‡ã­å†ç”Ÿã‚’è¨±å¯ã™ã‚‹å ´åˆã€ãƒ—ãƒ¼ãƒ«ãŒåŸ‹ã¾ã£ã¦ã„ã‚Œã°ä¸€æ™‚çš„ã«è¿½åŠ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¦åŒæ™‚ã«é³´ã‚‰ã™
    // å‹åˆ©/æ•—åŒ—ç³»ã®éŸ³ã¯é‡ã­ãªã„ï¼ˆæ··ã–ã‚Šã‚’é˜²ãï¼‰
    select: { src: 'assets/select.mp3', pool: 4, allowOverlap: true, maxExtra: 6 },
    tap: { src: 'assets/tap.mp3', pool: 6, allowOverlap: true, maxExtra: 8 },
    correct: { src: 'assets/correct.mp3', pool: 2, allowOverlap: true, maxExtra: 2 },
    incorrect: { src: 'assets/incorrect.mp3', pool: 2, allowOverlap: true, maxExtra: 2 },
    continue: { src: 'assets/continue.mp3', pool: 2, allowOverlap: true, maxExtra: 2 },
    gameover: { src: 'assets/gameover.mp3', pool: 2, allowOverlap: false },
    victory: { src: 'assets/victory.mp3', pool: 2, allowOverlap: false },
    timeup: { src: 'assets/timeup.mp3', pool: 2, allowOverlap: false }
};

const soundPools = new Map();
const extraSoundInstances = new Map();

let audioUnlocked = false;

function unlockAudioOnce() {
    if (audioUnlocked) return;

    // ä»•æ§˜ï¼šiOSï¼ˆSafari/Chromeï¼‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œèµ·ç‚¹ã§ãªã„éŸ³å£°å†ç”Ÿã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹
    // æœ€åˆã®æ“ä½œæ™‚ã«å…¨ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’ç©ºå†ç”Ÿã—ã¦è§£é™¤ã—ã€ã‚¿ã‚¤ãƒãƒ¼é§†å‹•ã®éŸ³ã‚‚é³´ã‚‹ã‚ˆã†ã«ã™ã‚‹
    const audiosToPrime = [];
    for (const pool of soundPools.values()) {
        for (const audio of pool) audiosToPrime.push(audio);
    }
    if (timerAudio) audiosToPrime.push(timerAudio);

    let anySucceeded = false;

    for (const audio of audiosToPrime) {
        try {
            const originalVolume = audio.volume;
            audio.volume = 0;
            audio.currentTime = 0;
            const p = audio.play();

            // ã™ãåœæ­¢/ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã€‚ã“ã“ã§ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå†…ã§ play() ãŒæˆåŠŸã™ã‚‹ã€ã“ã¨ã ã‘ãŒå¿…è¦
            audio.pause();
            audio.currentTime = 0;
            audio.volume = originalVolume;

            if (p && typeof p.then === 'function') {
                anySucceeded = true;
                // æœªå‡¦ç†ã® Promise rejection ã‚’é¿ã‘ã‚‹
                p.catch(() => {});
            } else {
                anySucceeded = true;
            }
        } catch {
            // ç„¡è¦–
        }
    }

    if (anySucceeded) audioUnlocked = true;
}

function initSounds() {
    for (const [name, cfg] of Object.entries(soundConfig)) {
        const poolSize = Math.max(1, cfg.pool || 1);
        const pool = [];
        for (let i = 0; i < poolSize; i++) {
            const audio = new Audio(cfg.src);
            audio.preload = 'auto';
            pool.push(audio);
        }
        soundPools.set(name, pool);
        extraSoundInstances.set(name, []);
    }
}

function playSound(name) {
    const pool = soundPools.get(name);
    if (!pool || pool.length === 0) return;

    const cfg = soundConfig[name] || {};
    const allowOverlap = cfg.allowOverlap !== false;

    if (!allowOverlap) {
        // ã™ã§ã«å†ç”Ÿä¸­ã®ã‚‚ã®ãŒã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
        if (pool.some(a => !a.paused && !a.ended)) return;
    }

    let audio = pool.find(a => a.paused || a.ended);

    if (!audio) {
        if (allowOverlap) {
            const extras = extraSoundInstances.get(name) || [];
            const maxExtra = Math.max(0, cfg.maxExtra || 0);
            if (extras.length < maxExtra) {
                try {
                    const extra = new Audio(cfg.src);
                    extra.preload = 'auto';
                    extra.addEventListener('ended', () => {
                        const arr = extraSoundInstances.get(name);
                        if (!arr) return;
                        const idx = arr.indexOf(extra);
                        if (idx >= 0) arr.splice(idx, 1);
                    }, { once: true });
                    extras.push(extra);
                    extraSoundInstances.set(name, extras);
                    audio = extra;
                } catch {
                    audio = null;
                }
            } else {
                // ä¸Šé™ã«é”ã—ãŸå ´åˆã¯å…ˆé ­ã®ãƒ—ãƒ¼ãƒ«ã‚’ä½¿ã„å›ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                audio = pool[0];
            }
        } else {
            audio = pool[0];
        }
    }

    if (!audio) return;

    try {
        audio.currentTime = 0;
        const p = audio.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
    } catch {
        // ç„¡è¦–
    }
}

// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ï¼ˆassets/timer.mp3ï¼‰ã¯ã€Œæ®‹ã‚Š 5 ç§’ä»¥å†…ã§ãƒ«ãƒ¼ãƒ—å†ç”Ÿã€ã™ã‚‹å°‚ç”¨éŸ³
let timerAudio = null;

function initTimerSound() {
    timerAudio = new Audio('assets/timer.mp3');
    timerAudio.preload = 'auto';
    timerAudio.loop = true;
}

function startTimerSound() {
    if (!timerAudio) return;
    if (!timerAudio.paused) return;
    try {
        const p = timerAudio.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
    } catch {
        // ç„¡è¦–
    }
}

function pauseTimerSound() {
    if (!timerAudio) return;
    if (!timerAudio.paused) timerAudio.pause();
}

function stopTimerSound() {
    if (!timerAudio) return;
    timerAudio.pause();
    timerAudio.currentTime = 0;
}

function createTileImage(tileInfo) {
    const img = document.createElement('img');
    img.src = tileInfo.imgSrc;
    img.alt = tileInfo.name;
    img.draggable = false;
    img.className = 'tile-img';
    return img;
}

function createInlineHandTile(tileInfo) {
    const tile = document.createElement('span');
    tile.className = 'hand-tile tile-inline-hand rounded-lg tile-shadow';
    tile.title = tileInfo.name;
    tile.appendChild(createTileImage(tileInfo));
    return tile;
}

const gameState = {
    mode: null, difficulty: null, currentQuestion: 0, currentStage: 0, correctCount: 0,
    hand: [], counts: {}, waitingTiles: [], selectedTiles: new Set(), tileType: 'pin',
    timeLeft: 0, maxTime: 0, timeBonus: 0, timerInterval: null, isBossStage: false, isAnswered: false,
    lives: 3, maxLives: 3, isPaused: false,
    timeExtensions: 3, maxTimeExtensions: 3, extendedTime: 0, // é•·è€ƒï¼ˆã‚¿ã‚¤ãƒ å»¶é•·ï¼‰ã®ä»•çµ„ã¿
    timerCuePlayed: false
};

// æ­£ç¢ºãªå’Œäº†åˆ¤å®šï¼ˆ4é¢å­1é›€é ­ï¼‰
function isWinningHand(counts) {
    for (let head = 1; head <= 9; head++) {
        if (counts[head] >= 2) {
            const newCounts = {...counts};
            newCounts[head] -= 2;
            if (canFormMentsu(newCounts)) {
                return true;
            }
        }
    }
    return false;
}

// é¢å­ï¼ˆåˆ»å­/é †å­ï¼‰ã‚’çµ„ã‚ã‚‹ã‹åˆ¤å®š
function canFormMentsu(counts) {
    let totalTiles = 0;
    for (let i = 1; i <= 9; i++) {
        totalTiles += counts[i];
    }
    
    if (totalTiles === 0) return true;
    if (totalTiles % 3 !== 0) return false;
    
    let firstTile = 0;
    for (let i = 1; i <= 9; i++) {
        if (counts[i] > 0) {
            firstTile = i;
            break;
        }
    }
    
    if (firstTile === 0) return true;
    
    const newCounts = { ...counts };
    
    // ã¾ãšåˆ»å­ï¼ˆåŒç‰Œ3æšï¼‰ã‚’è©¦ã™
    if (newCounts[firstTile] >= 3) {
        newCounts[firstTile] -= 3;
        if (canFormMentsu(newCounts)) {
            return true;
        }
        newCounts[firstTile] += 3;
    }
    
    // æ¬¡ã«é †å­ï¼ˆé€£ç¶š3æšï¼‰ã‚’è©¦ã™
    if (firstTile <= 7 && newCounts[firstTile] > 0 && newCounts[firstTile + 1] > 0 && newCounts[firstTile + 2] > 0) {
        newCounts[firstTile]--;
        newCounts[firstTile + 1]--;
        newCounts[firstTile + 2]--;
        if (canFormMentsu(newCounts)) {
            return true;
        }
    }
    
    return false;
}

// è´ç‰Œï¼ˆå¾…ã¡ç‰Œï¼‰ã‚’è¨ˆç®—
function calculateWinningTiles(counts) {
    const winningTiles = [];
    
    for (let tile = 1; tile <= 9; tile++) {
        if (counts[tile] >= 4) continue;
        const newCounts = {...counts};
        newCounts[tile]++;
        
        if (isWinningHand(newCounts)) {
            winningTiles.push(tile);
        }
    }
    return winningTiles;
}

// é›£æ˜“åº¦ã«å¿œã˜ã¦å¾…ã¡ã®æ•°ãŒæ¡ä»¶ã‚’æº€ãŸã™ã‹åˆ¤å®š
function isValidWinningTilesCount(count, difficulty, attempts) {
    if (difficulty === 'easy') {
        if (attempts <= 4) return count === 3;
        if (attempts <= 8) return count >= 2 && count <= 3;
        return count >= 1 && count <= 3;
    } else if (difficulty === 'medium') {
        if (attempts <= 16) return count === 6;
        if (attempts <= 32) return count >= 5 && count <= 6;
        if (attempts <= 64) return count >= 4 && count <= 6;
        if (attempts <= 256) return count >= 3 && count <= 6;
        if (attempts <= 1024) return count >= 2 && count <= 6;
        return count >= 1 && count <= 6;
    } else { // ä¸Šç´š
        if (attempts <= 16) return count === 9;
        if (attempts <= 32) return count >= 8 && count <= 9;
        if (attempts <= 64) return count >= 7 && count <= 9;
        if (attempts <= 256) return count >= 6 && count <= 9;
        if (attempts <= 1024) return count >= 5 && count <= 9;
        if (attempts <= 4096) return count >= 4 && count <= 9;
        if (attempts <= 8192) return count >= 3 && count <= 9;
        if (attempts <= 16384) return count >= 2 && count <= 9;
        return count >= 1 && count <= 9;
    }
}

// è´ç‰Œæ‰‹ç‰Œã‚’ç”Ÿæˆ
function generateTenpaiHand(difficulty) {
    let attempts = 0;
    
    do {
        attempts++;
        
        // ç‰Œã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        gameState.counts = {};
        for (let i = 1; i <= 9; i++) {
            gameState.counts[i] = 0;
        }
        gameState.hand = [];
        
        // 13æšã‚’ç”Ÿæˆï¼ˆå„ç‰Œã¯æœ€å¤§4æšï¼‰
        while (gameState.hand.length < 13) {
            const tile = Math.floor(Math.random() * 9) + 1;
            if (gameState.counts[tile] < 4) {
                gameState.hand.push(tile);
                gameState.counts[tile]++;
            }
        }
        
        // è´ç‰Œã‚’è¨ˆç®—
        const winningTiles = calculateWinningTiles(gameState.counts);
        
        // é›£æ˜“åº¦æ¡ä»¶ã‚’æº€ãŸã™ã‹ç¢ºèª
        if (isValidWinningTilesCount(winningTiles.length, difficulty, attempts)) {
            return { hand: gameState.hand, waiting: winningTiles, counts: gameState.counts };
        }
        
        // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
        if (attempts > 1000000) {
            console.warn('æ¡ä»¶ã«åˆã†æ‰‹ç‰Œã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç¾åœ¨ã®çµæœã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
            return { hand: gameState.hand, waiting: winningTiles, counts: gameState.counts };
        }
        
    } while (true);
}

function startTimer() {
    stopTimer();
    // ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸ã®æœ€å¤§æ™‚é–“ã‚’ä¿å­˜
    gameState.maxTime = gameState.isBossStage ? Math.max(0, gameState.timeLeft) : getMaxTime();
    gameState.isPaused = false;
    updateTimerDisplay();
    gameState.timerInterval = setInterval(() => {
        if (!gameState.isPaused) {
            gameState.timeLeft--;
            updateTimerDisplay();
            if (gameState.timeLeft <= 0) {
                stopTimer();
                handleTimeUp();
            }
        }
    }, 1000);

    // ç”»é¢ã‚’è¦‹ã¦ã„ãªã„ï¼ˆã‚¿ãƒ–éè¡¨ç¤º/åˆ¥ã‚¢ãƒ—ãƒª/æœ€å°åŒ–ãªã©ï¼‰çŠ¶æ…‹ã§é–‹å§‹ã—ãŸå ´åˆã¯ã€å³æ™‚ã«ä¸€æ™‚åœæ­¢ã¸
    // â€» ã‚¹ãƒ†ãƒ¼ã‚¸æ¼”å‡ºä¸­ã«é›¢è„± â†’ æ¼”å‡ºå¾Œã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã€ã¨ã„ã†ã‚±ãƒ¼ã‚¹ã§ã‚‚æ®‹ã‚Šæ™‚é–“ãŒæ¸›ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
    const isVisible = !document.hidden && document.visibilityState === 'visible';
    const hasFocus = typeof document.hasFocus === 'function' ? document.hasFocus() : true;
    if (!isVisible || !hasFocus) {
        pauseTimer();
    }

    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹å¾Œã«æ“ä½œçŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹ï¼ˆå…ˆã«æ›´æ–°ã™ã‚‹ã¨é¸æŠç‰ŒãŒãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ï¼‰
    updateInteractionState();
}

function stopTimer() {
    if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
    }

    // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢æ™‚ã¯ä¸€æ—¦ã€Œä¸€æ™‚åœæ­¢ã€ã€‚å›ç­”é€ä¿¡æ™‚ï¼ˆisAnswered=trueï¼‰ã¯å®Œå…¨åœæ­¢ã€‚
    if (gameState.isAnswered) {
        stopTimerSound();
    } else {
        pauseTimerSound();
    }

    gameState.isPaused = false;
    // æ™‚é–“åˆ‡è¿«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è§£é™¤
    document.body.classList.remove('time-critical');
    hidePauseOverlay();
    updateInteractionState();
}

function pauseTimer() {
    if (!gameState.timerInterval || gameState.isAnswered) return;
    gameState.isPaused = true;
    pauseTimerSound();
    showPauseOverlay();
    updateInteractionState();
}

function resumeTimer() {
    if (!gameState.timerInterval) return;
    gameState.isPaused = false;
    hidePauseOverlay();
    if (gameState.timerCuePlayed && gameState.timeLeft <= 5 && !gameState.isAnswered) {
        startTimerSound();
    }
    updateInteractionState();
}

function isActiveQuestion() {
    return !!gameState.timerInterval && !gameState.isAnswered && !gameState.isPaused;
}

function updateInteractionState() {
    const submitBtn = document.getElementById('submit-btn');
    const nextBtn = document.getElementById('next-btn');
    const possibleTiles = document.getElementById('possible-tiles');
    const resultSection = document.getElementById('result-section');

    const active = isActiveQuestion();
    const hasSelection = gameState.selectedTiles && gameState.selectedTiles.size > 0;

    if (submitBtn) {
        submitBtn.disabled = !active || !hasSelection;
    }

    if (nextBtn) {
        const nextVisible = !nextBtn.classList.contains('hidden');
        nextBtn.disabled = !nextVisible || !gameState.isAnswered || gameState.isBossStage;
    }

    if (possibleTiles) {
        possibleTiles.style.pointerEvents = active ? '' : 'none';
    }

    updateTimeExtensionButton();
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('timer-display');
    const timerBar = document.getElementById('timer-bar');
    if (!timerElement || !timerBar) return;
    
    // ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸ã® maxTime ã‚’ä½¿ã£ã¦å‰²åˆã‚’è¨ˆç®—
    const percentage = (gameState.timeLeft / gameState.maxTime) * 100;
    timerElement.textContent = gameState.timeLeft;
    
    // å¹…ã®å¤‰åŒ–ã‚’æ»‘ã‚‰ã‹ã«è¦‹ã›ã‚‹
    timerBar.style.transition = 'width 1s linear';
    timerBar.style.width = `${Math.max(0, percentage)}%`;
    
    timerElement.className = 'timer-value';
    timerBar.className = 'timer-bar';
    
    // æ™‚é–“ãŒå°‘ãªã„ã¨ãã«èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
    if (gameState.timeLeft <= 5) {
        timerElement.classList.add('timer-danger');
        timerBar.classList.add('timer-bar-danger');
        document.body.classList.add('time-critical');

        if (!gameState.timerCuePlayed && gameState.timeLeft === 5) {
            gameState.timerCuePlayed = true;
            if (!gameState.isPaused && !gameState.isAnswered) startTimerSound();
        }
    } else {
        // 5ç§’ä»¥ä¸Šã«æˆ»ã£ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ã¯åœæ­¢ï¼ˆå»¶é•·ãªã©ï¼‰
        if (gameState.timerCuePlayed) {
            gameState.timerCuePlayed = false;
            stopTimerSound();
        }
        document.body.classList.remove('time-critical');
        if (gameState.timeLeft <= 10) {
            timerElement.classList.add('timer-warning');
            timerBar.classList.add('timer-bar-warning');
        }
    }

    // æ®‹ã‚Šæ™‚é–“ã«å¿œã˜ã¦å»¶é•·ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚‚è¿½éšã•ã›ã‚‹ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
    updateTimeExtensionButton();
}

function getMaxTime() {
    if (gameState.mode === 'casual') return 45;
    if (gameState.mode === 'story') return 30;
    if (gameState.mode === 'survival') return 60;
    return 0;
}

function handleTimeUp() {
    if (gameState.isAnswered) return;

    // 1æšã§ã‚‚é¸ã‚“ã§ã„ã‚Œã°ã€Œè‡ªå‹•æå‡ºã€ã¨ã—ã¦æ‰±ã†ï¼ˆselect éŸ³ã¯é³´ã‚‰ã•ãªã„ï¼‰
    if (gameState.selectedTiles && gameState.selectedTiles.size > 0) {
        checkAnswer({ force: true });
        return;
    }

    gameState.isAnswered = true;
    updateInteractionState();

    // æ™‚é–“åˆ‡ã‚Œç¢ºå®šï¼šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ã¯åœæ­¢
    stopTimerSound();

    // æœªæå‡ºã®æ™‚é–“åˆ‡ã‚Œï¼šincorrect ã§ã¯ãªã timeup ã‚’é³´ã‚‰ã™
    playSound('timeup');
    
    // ã‚µãƒã‚¤ãƒãƒ«ã¯æ™‚é–“åˆ‡ã‚Œã§å³çµ‚äº†
    if (gameState.mode === 'survival') {
        highlightAnswers();
        const section = document.getElementById('result-section');
        const message = document.getElementById('result-message');
        const nextBtn = document.getElementById('next-btn');
        if (section) {
            section.classList.remove('hidden');
            section.classList.add('slide-down');
        }
        if (message) {
            message.textContent = t('timeUp');
            message.className = 'text-3xl font-bold text-red-300 mb-6';
        }
        if (nextBtn) nextBtn.classList.add('hidden');
        hideResultActions();
        showGameOver(true);
        return;
    }
    
    // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ãƒ©ã‚¤ãƒ•åˆ¶
    if (gameState.mode === 'casual' || gameState.mode === 'story') {
        gameState.lives--;
        updateLivesDisplay();
        
        if (gameState.lives <= 0) {
            highlightAnswers();
            const section = document.getElementById('result-section');
            const message = document.getElementById('result-message');
            const nextBtn = document.getElementById('next-btn');
            if (section) {
                section.classList.remove('hidden');
                section.classList.add('slide-down');
            }
            if (message) {
                message.textContent = t('timeUp');
                message.className = 'text-3xl font-bold text-red-300 mb-6';
            }
            if (nextBtn) nextBtn.classList.add('hidden');
            hideResultActions();
            showGameOver(true);
        } else {
            // æ­£è§£è¡¨ç¤ºå¾Œã« Continue ã‚’å‡ºã™
            highlightAnswers();
            const section = document.getElementById('result-section');
            const message = document.getElementById('result-message');
            const nextBtn = document.getElementById('next-btn');
            section.classList.remove('hidden');
            section.classList.add('slide-down');
            message.textContent = t('timeUp');
            message.className = 'text-3xl font-bold text-red-300 mb-6';
            if (nextBtn) nextBtn.classList.add('hidden');
            showContinueOption();
        }
    }
}

function backToMenu() {
    resetGame();
}

function restartCurrentRun() {
    // ãƒ¢ãƒ¼ãƒ‰æœªé¸æŠãªã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
    if (!gameState.mode) {
        resetGame();
        return;
    }

    stopTimer();
    // å¿µã®ãŸã‚ï¼šå†é–‹æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ãŒæ®‹ã‚‰ãªã„ã‚ˆã†å®Œå…¨åœæ­¢
    stopTimerSound();

    const mode = gameState.mode;
    const previousDifficulty = gameState.difficulty;

    // ç”»é¢çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    document.getElementById('victory-screen').classList.add('hidden');
    document.getElementById('gameover-screen').classList.add('hidden');
    document.getElementById('mode-screen').classList.add('hidden');
    document.getElementById('difficulty-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.body.classList.remove('boss-stage');
    document.body.classList.add('in-game');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    const resultSection = document.getElementById('result-section');
    resultSection.classList.add('hidden');
    hideResultActions();

    // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆmode ã¯ä¿æŒã€casual/survival ã¯ difficulty ã‚’ä¿æŒã€‚story ã¯å¿…ãš easy ã‹ã‚‰ï¼‰
    gameState.currentQuestion = 0;
    gameState.currentStage = 0;
    gameState.correctCount = 0;
    gameState.timeBonus = 0;
    gameState.hand = [];
    gameState.counts = {};
    gameState.waitingTiles = [];
    gameState.selectedTiles.clear();
    gameState.isBossStage = false;
    gameState.isAnswered = false;
    gameState.isPaused = false;
    gameState.lives = 3;
    gameState.timeExtensions = gameState.maxTimeExtensions;
    gameState.extendedTime = 0;
    gameState.timerCuePlayed = false;

    if (mode === 'story') {
        gameState.difficulty = 'easy';
    } else {
        gameState.difficulty = previousDifficulty;
    }

    // SURVIVAL ã¯ã‚¹ãƒ†ãƒ¼ã‚¸é–“ã§ timeLeft ã‚’å¼•ãç¶™ãä»•æ§˜ãªã®ã§ã€ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«æ˜ç¤ºçš„ã«åˆæœŸå€¤ã¸æˆ»ã™
    // ï¼ˆtime up / incorrect ã§ timeLeft ãŒ 0 ã®ã¾ã¾ã ã¨ã€æ¬¡å›é–‹å§‹ãŒå³ GAME OVER ã«ãªã‚‹ï¼‰
    gameState.timeLeft = getMaxTime();
    gameState.maxTime = getMaxTime();
    updateTimerDisplay();

    document.getElementById('submit-btn').disabled = false;
    updateLivesDisplay();
    updateInteractionState();
    startNewQuestion();
}

function startGameMode(mode) {
    gameState.mode = mode;
    gameState.lives = 3; // ãƒ©ã‚¤ãƒ•ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('mode-screen').classList.add('hidden');
    if (mode === 'story') {
        gameState.difficulty = 'easy';
        gameState.currentQuestion = 0;
        gameState.currentStage = 0;
        gameState.correctCount = 0;
        gameState.timeBonus = 0;
        gameState.timeExtensions = gameState.maxTimeExtensions; // ã‚¿ã‚¤ãƒ å»¶é•·ã‚’ãƒªã‚»ãƒƒãƒˆ
        gameState.extendedTime = 0;
        document.getElementById('difficulty-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.body.classList.add('in-game');
        updateLivesDisplay();
        startNewQuestion();
    } else {
        document.getElementById('difficulty-screen').classList.remove('hidden');
    }
}

function startGameWithDifficulty(difficulty) {
    gameState.difficulty = difficulty;
    gameState.currentQuestion = 0;
    gameState.currentStage = 0;
    gameState.correctCount = 0;
    gameState.timeBonus = 0;
    gameState.lives = 3; // ãƒ©ã‚¤ãƒ•ã‚’ãƒªã‚»ãƒƒãƒˆ
    gameState.timeExtensions = gameState.maxTimeExtensions; // ã‚¿ã‚¤ãƒ å»¶é•·ã‚’ãƒªã‚»ãƒƒãƒˆ
    gameState.extendedTime = 0;
    document.getElementById('difficulty-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.body.classList.add('in-game');
    if (gameState.mode === 'survival') gameState.timeLeft = 60; // ã‚µãƒã‚¤ãƒãƒ«ã®åˆæœŸæ™‚é–“
    updateLivesDisplay();
    startNewQuestion();
}

async function startNewQuestion() {
    // å•é¡Œé€²è¡Œä¸­ï¼ˆã¾ãŸã¯ä¸€æ™‚åœæ­¢ä¸­ï¼‰ã®èª¤æ“ä½œã§æ¬¡ã¸é€²ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹
    if (gameState.timerInterval && !gameState.isAnswered) return;

    // æ¬¡ã¸ç§»ã‚‹å‰ã«çµæœè¡¨ç¤ºã‚’é–‰ã˜ã‚‹
    const resultSection = document.getElementById('result-section');
    if (resultSection) resultSection.classList.add('hidden');
    hideResultActions();

    // ã™ã¹ã¦ã®ãƒ¢ãƒ¼ãƒ‰ã§ currentStage ã‚’é€²ã‚ã‚‹
    gameState.currentStage++;
    
    const isBossEntry = (gameState.mode === 'casual' || gameState.mode === 'story') && gameState.currentStage === 10;

    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦é›£æ˜“åº¦ã‚’èª¿æ•´ï¼ˆéå ´è¡¨ç¤ºã«ã‚‚åæ˜ ï¼‰
    if (gameState.mode === 'story' && !isBossEntry) {
        if (gameState.currentStage <= 3) gameState.difficulty = 'easy';
        else if (gameState.currentStage <= 6) gameState.difficulty = 'medium';
        else gameState.difficulty = 'hard';
    }

    gameState.isBossStage = !!isBossEntry;
    updateQuestionDisplay();

    const stageTitle = isBossEntry
        ? t('bossStage')
        : `${t('stage')} ${gameState.currentStage}`;
    const subtitle = `${t('difficulty')} ${getDifficultyBadgeHtml(gameState.difficulty)} <span class="opacity-80">(${t(`${gameState.difficulty}Desc`)})</span>`;

    await showStageIntro({ titleText: stageTitle, subtitleHtml: subtitle, durationMs: 3800 });

    // ãƒœã‚¹ï¼ˆç¬¬10ã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰ã«å…¥ã‚‹ã‹åˆ¤å®š
    if (isBossEntry) {
        startBossStage();
        return;
    }

    // æ–°ã—ã„å•é¡Œã‚’ç”Ÿæˆ
    generateAndShowQuestion();
}

// å•é¡Œã‚’ç”Ÿæˆã—ã¦è¡¨ç¤ºï¼ˆstartNewQuestion / continueGame å…±é€šï¼‰
function generateAndShowQuestion() {
    gameState.selectedTiles.clear();
    gameState.isAnswered = false;
    gameState.extendedTime = 0; // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®å»¶é•·æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
    gameState.timerCuePlayed = false;
    stopTimerSound();
    
    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦é›£æ˜“åº¦ã‚’èª¿æ•´
    if (gameState.mode === 'story') {
        if (gameState.currentStage <= 3) gameState.difficulty = 'easy';
        else if (gameState.currentStage <= 6) gameState.difficulty = 'medium';
        else gameState.difficulty = 'hard';
    }
    
    // ãƒ©ãƒ³ãƒ€ãƒ èŠ±è‰²ï¼ˆç­’/è¬/ç´¢ï¼‰
    gameState.tileType = pickRandomTileType();

    const result = generateTenpaiHand(gameState.difficulty);
    if (!result) { 
        alert('å•é¡Œã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        resetGame();
        return; 
    }
    
    gameState.hand = result.hand;
    gameState.counts = result.counts;
    gameState.waitingTiles = result.waiting;
    
    document.body.classList.remove('boss-stage');
    document.getElementById('boss-indicator').classList.add('hidden');
    const resultSection = document.getElementById('result-section');
    resultSection.classList.add('hidden');
    hideResultActions();
      
    updateQuestionDisplay();
    renderHand();
    renderPossibleTiles();
    
    // ã‚µãƒã‚¤ãƒãƒ«ã¯ç¬¬9å•ã§æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆã€‚ãã‚Œä»¥å¤–ã¯æ—¢å®šã®æœ€å¤§æ™‚é–“ã‚’ä½¿ç”¨
    if (gameState.mode !== 'survival' || gameState.currentQuestion === 9) {
        gameState.timeLeft = getMaxTime();
    }
    startTimer();
}

function startBossStage() {
    gameState.isBossStage = true;
    gameState.isAnswered = false;
    gameState.selectedTiles.clear();

    // æœªä½¿ç”¨ã®å»¶é•·å›æ•°ã¯ã€BOSS ã®æŒ‘æˆ¦æ™‚é–“ã«ã¾ã¨ã‚ã¦åŠ ç®—ã™ã‚‹
    // ï¼ˆBOSS ã§ã¯å»¶é•·ã‚’ä½¿ãˆãªã„è¨­è¨ˆã®ãŸã‚ã€ã“ã“ã§è‡ªå‹•å¤‰æ›ã—ã¦å…¬å¹³ã«ã™ã‚‹ï¼‰
    if (gameState.mode === 'casual' || gameState.mode === 'story') {
        const unusedExtensions = Math.max(0, gameState.timeExtensions || 0);
        if (unusedExtensions > 0) {
            gameState.timeBonus += unusedExtensions * 30;
            gameState.timeExtensions = 0;
        }
    }

    generateAndShowBossQuestion({ resetTime: true });
}

function generateAndShowBossQuestion({ resetTime = false } = {}) {
    gameState.selectedTiles.clear();
    gameState.isAnswered = false;
    gameState.extendedTime = 0;
    gameState.timerCuePlayed = false;
    stopTimerSound();

    // ãƒ©ãƒ³ãƒ€ãƒ èŠ±è‰²ï¼ˆç­’/è¬/ç´¢ï¼‰
    gameState.tileType = pickRandomTileType();

    // ãƒœã‚¹ã¯ç¾åœ¨ã®é›£æ˜“åº¦ã‚’å¼•ãç¶™ãï¼ˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã¯é¸æŠå€¤ã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯7-9ã§ãƒãƒ¼ãƒ‰ã®æƒ³å®šï¼‰
    const result = generateTenpaiHand(gameState.difficulty);
    if (!result) {
        alert('BOSSå•é¡Œã‚’ç”Ÿæˆã§ãã¾ã›ã‚“');
        return;
    }

    gameState.hand = result.hand;
    gameState.counts = result.counts;
    gameState.waitingTiles = result.waiting;

    document.body.classList.add('boss-stage');
    // ãƒœã‚¹ã‚¹ãƒ†ãƒ¼ã‚¸ã®ä¸Šéƒ¨è¡¨ç¤ºã¯ä½¿ã‚ãªã„ï¼ˆèƒŒæ™¯åŠ¹æœã§ååˆ†ï¼‰
    document.getElementById('boss-indicator').classList.add('hidden');
    const resultSection = document.getElementById('result-section');
    resultSection.classList.add('hidden');
    hideResultActions();

    updateQuestionDisplay();
    renderHand();
    renderPossibleTiles();

    if (resetTime) {
        // ãƒœã‚¹ã¯ç´¯ç©æ™‚é–“ã®ã¿ã€‚ãŸã ã—ç´¯ç©ãŒå°‘ãªã„å ´åˆã¯å„ãƒ¢ãƒ¼ãƒ‰ã®åŸºæœ¬ç§’æ•°ã‚’ä¸‹é™ã«ã™ã‚‹
        const baseTime = getMaxTime();
        gameState.timeLeft = Math.max(gameState.timeBonus, baseTime);
    }
    startTimer();
}

function updateQuestionDisplay() {
    const questionNum = document.getElementById('question-number');
    const stageInfo = document.getElementById('stage-info');

    const diffKey = gameState.difficulty || 'easy';
    const diffName = t(diffKey);
    const diffDesc = t(`${diffKey}Desc`);

    const diffBadgeClass = diffKey === 'easy'
        ? 'difficulty-badge difficulty-badge--easy'
        : diffKey === 'medium'
            ? 'difficulty-badge difficulty-badge--medium'
            : 'difficulty-badge difficulty-badge--hard';

    const diffInfoHtml = `<span class="font-bold">${t('difficulty')}</span> ` +
        `<span class="${diffBadgeClass}">${diffName}</span>` +
        (diffDesc ? ` <span class="opacity-80">(${diffDesc})</span>` : '');

    // é›£æ˜“åº¦ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆä¸»ã«ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®è¦–èªæ€§å‘ä¸Šï¼‰
    if (questionNum) {
        questionNum.classList.remove('difficulty-accent--easy', 'difficulty-accent--medium', 'difficulty-accent--hard');
        if (!gameState.isBossStage && (gameState.mode === 'casual' || gameState.mode === 'story' || gameState.mode === 'survival')) {
            questionNum.classList.add(`difficulty-accent--${diffKey}`);
        }
    }

    if (gameState.isBossStage) {
        questionNum.textContent = t('bossStage');
    } else {
        questionNum.textContent = `${t('stage')} ${gameState.currentStage}`;
    }
    stageInfo.innerHTML = `<small>${diffInfoHtml}</small>`;

    updateLivesDisplay();
    updateInteractionState();
}

function renderHand() {
    const container = document.getElementById('hand-tiles');
    container.innerHTML = '';
    const sorted = [...gameState.hand].sort((a, b) => a - b);
    sorted.forEach(tile => {
        const tileInfo = getTileInfo(gameState.tileType, tile);
        const div = document.createElement('div');
        div.className = 'hand-tile rounded-lg tile-shadow flex items-center justify-center';
        div.style.cssText = 'width: 48px; height: 68px; font-size: 36px;';
        div.appendChild(createTileImage(tileInfo));
        div.title = tileInfo.name;
        container.appendChild(div);
    });
}

function renderPossibleTiles() {
    const container = document.getElementById('possible-tiles');
    container.innerHTML = '';
    for (let tile = 1; tile <= 9; tile++) {
        const tileInfo = getTileInfo(gameState.tileType, tile);
        const div = document.createElement('div');
        div.className = 'selectable-tile rounded-xl tile-shadow tile-hover flex items-center justify-center cursor-pointer';
        div.style.cssText = 'width: 64px; height: 88px; font-size: 48px;';
        div.dataset.tile = tile;
        div.appendChild(createTileImage(tileInfo));
        div.title = tileInfo.name;

        // æ‰‹ç‰Œå†…ã§åŒç‰ŒãŒ4æšä½¿ã‚ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ç‰Œã¯é¸æŠä¸å¯ã«ã™ã‚‹
        const exhausted = (gameState.counts && gameState.counts[tile] >= 4);
        if (exhausted) {
            div.classList.add('tile-disabled');
            div.setAttribute('aria-disabled', 'true');
        } else {
            div.addEventListener('click', () => toggleTileSelection(tile, div));
        }
        container.appendChild(div);
    }
}

function toggleTileSelection(tile, element) {
    if (!isActiveQuestion()) return;

    playSound('tap');
    if (gameState.selectedTiles.has(tile)) {
        gameState.selectedTiles.delete(tile);
        element.classList.remove('selected');
    } else {
        gameState.selectedTiles.add(tile);
        element.classList.add('selected');
    }

    updateInteractionState();
}

function checkAnswer({ force = false } = {}) {
    if (gameState.isAnswered) return;
    if (!force && !isActiveQuestion()) return;
    gameState.isAnswered = true;
    stopTimer();
    const selected = Array.from(gameState.selectedTiles);
    const correct = gameState.waitingTiles;
    const isCorrect = selected.length === correct.length && selected.every(tile => correct.includes(tile));
    if (isCorrect) handleCorrectAnswer();
    else handleIncorrectAnswer();
    updateInteractionState();
}

function handleCorrectAnswer() {
    gameState.correctCount++;

    playSound('correct');
    
    // æ™‚é–“ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—ï¼ˆå…ƒã®æ™‚é–“ã®ã¿ã€‚å»¶é•·æ™‚é–“ã¯å«ã‚ãªã„ï¼‰
    // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ãƒœã‚¹ç”¨ã«ç´¯ç©ã™ã‚‹ï¼ˆãƒœã‚¹è‡ªä½“ã§ã¯ç´¯ç©ã—ãªã„ï¼‰
    if (!gameState.isBossStage && (gameState.mode === 'casual' || gameState.mode === 'story')) {
        const maxTimeForStage = getMaxTime(); // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®å…ƒã®æœ€å¤§æ™‚é–“
        const actualBonus = Math.min(gameState.timeLeft, maxTimeForStage); // å…ƒã®æ™‚é–“åˆ†ã¾ã§ã‚’ä¸Šé™ã«åŠ ç®—
        gameState.timeBonus += actualBonus;
    }
    
    if (gameState.mode === 'survival') {
        let recovery = 0;
        if (gameState.difficulty === 'easy') recovery = 5;
        else if (gameState.difficulty === 'medium') recovery = 10;
        else if (gameState.difficulty === 'hard') recovery = 15;
        gameState.timeLeft += recovery;
    }
    showResult(true);
    highlightAnswers();
    
    // ãƒœã‚¹ã‚¯ãƒªã‚¢å¾Œã«å‹åˆ©è¡¨ç¤º
    if (gameState.isBossStage) {
        showResultOkAction({
            titleText: t('victory'),
            titleClassName: 'text-3xl font-black mb-3 text-green-300 text-center',
            bodyText: '',
            onOk: () => {
                playSound('victory');
                showVictory();
            }
        });
    }
}

function handleIncorrectAnswer() {
    playSound('incorrect');
    showResult(false);
    highlightAnswers();
    
    // ã‚µãƒã‚¤ãƒãƒ«ã¯ä¸æ­£è§£ã§å³çµ‚äº†
    if (gameState.mode === 'survival') {
        showGameOver(false);
        return;
    }
    
    // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ãƒ©ã‚¤ãƒ•åˆ¶
    if (gameState.mode === 'casual' || gameState.mode === 'story') {
        gameState.lives--;
        updateLivesDisplay();
        
        if (gameState.lives <= 0) {
            // ãƒ©ã‚¤ãƒ•ãŒå°½ããŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
            showGameOver(false);
        } else {
            // ãƒ©ã‚¤ãƒ•ãŒæ®‹ã£ã¦ã„ã‚Œã° Continue ã‚’è¡¨ç¤º
            showContinueOption();
        }
    }
}

function showResult(isCorrect) {
    const section = document.getElementById('result-section');
    const message = document.getElementById('result-message');
    const nextBtn = document.getElementById('next-btn');
    section.classList.remove('hidden');
    section.classList.add('slide-down');
    message.textContent = isCorrect ? t('correct') : t('incorrect');
    message.className = isCorrect ? 'text-3xl font-bold text-green-300 mb-6' : 'text-3xl font-bold text-red-300 mb-6';

    hideResultActions();
    
    // ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³è¡¨ç¤ºæ¡ä»¶
    if (isCorrect && !gameState.isBossStage) {
        if (gameState.mode === 'survival') {
            nextBtn.classList.remove('hidden');
        } else if (gameState.mode === 'casual' || gameState.mode === 'story') {
            // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼šç¬¬1ã€œ9å•ã¯ã€Œæ¬¡ã¸ã€ã‚’è¡¨ç¤º
            nextBtn.classList.remove('hidden');
        }
    } else {
        nextBtn.classList.add('hidden');
    }
    
    // çµæœè¡¨ç¤ºä¸­ã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯ã—ã¦èª¤æ“ä½œã‚’é˜²ã
    updateInteractionState();
}

function highlightAnswers() {
    const container = document.getElementById('possible-tiles');
    const tiles = container.querySelectorAll('[data-tile]');
    const selected = Array.from(gameState.selectedTiles);
    const correct = gameState.waitingTiles;
    const correctSelected = selected.filter(t => correct.includes(t));
    const missed = correct.filter(t => !selected.includes(t));
    const wrong = selected.filter(t => !correct.includes(t));
    tiles.forEach(element => {
        const tile = parseInt(element.dataset.tile);
        element.classList.remove('selected');
        if (correctSelected.includes(tile)) element.classList.add('correct-selected');
        else if (missed.includes(tile)) element.classList.add('correct-missed');
        else if (wrong.includes(tile)) element.classList.add('incorrect-selected');
    });
    displayCorrectAnswer();
    displayHandBreakdown();
}

function displayCorrectAnswer() {
    const container = document.getElementById('correct-answer-display');
    container.innerHTML = `<p class="text-xl font-bold mb-4 text-center">${t('correctAnswer')}</p>`;
    const tilesDiv = document.createElement('div');
    tilesDiv.className = 'flex gap-3 flex-wrap justify-center';
    gameState.waitingTiles.forEach(tile => {
        const tileInfo = getTileInfo(gameState.tileType, tile);
        const div = document.createElement('div');
        div.className = 'hand-tile rounded-lg tile-shadow flex items-center justify-center';
        div.style.cssText = 'width: 64px; height: 88px; font-size: 48px;';
        div.appendChild(createTileImage(tileInfo));
        div.title = tileInfo.name;
        tilesDiv.appendChild(div);
    });
    container.appendChild(tilesDiv);
}

// å’Œäº†ç‰Œå‹ã‚’ç†ç‰Œã—ã¦è¿”ã™
function getWinningHandBreakdown(handArray) {
    const counts = {};
    for (let i = 1; i <= 9; i++) counts[i] = 0;
    handArray.forEach(tile => counts[tile]++);

    for (let head = 1; head <= 9; head++) {
        if (counts[head] >= 2) {
            const tempCounts = { ...counts };
            tempCounts[head] -= 2;
            const melds = [];
            if (findMeldBreakdown(tempCounts, melds)) {
                return {
                    head: [head, head],
                    melds: melds
                };
            }
        }
    }
    return null;
}

function findMeldBreakdown(counts, melds) {
    let totalTiles = 0;
    for(let i = 1; i <= 9; i++) {
        totalTiles += counts[i];
    }
    if (totalTiles === 0) {
        return true;
    }

    // æœ€åˆã®ç‰Œã‚’æ¢ã™
    let firstTile = 0;
    for (let i = 1; i <= 9; i++) {
        if (counts[i] > 0) {
            firstTile = i;
            break;
        }
    }

    // å„ªå…ˆçš„ã«åˆ»å­ã‚’è©¦ã™
    if (counts[firstTile] >= 3) {
        const tempCounts = { ...counts };
        tempCounts[firstTile] -= 3;
        melds.push([firstTile, firstTile, firstTile]);
        if (findMeldBreakdown(tempCounts, melds)) {
            return true;
        }
        melds.pop(); // ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯
    }

    // é †å­ã‚’è©¦ã™
    if (firstTile <= 7 && counts[firstTile] > 0 && counts[firstTile + 1] > 0 && counts[firstTile + 2] > 0) {
        const tempCounts = { ...counts };
        tempCounts[firstTile]--;
        tempCounts[firstTile + 1]--;
        tempCounts[firstTile + 2]--;
        melds.push([firstTile, firstTile + 1, firstTile + 2]);
        if (findMeldBreakdown(tempCounts, melds)) {
            return true;
        }
        melds.pop(); // ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯
    }
    
    return false;
}

function displayHandBreakdown() {
    const container = document.getElementById('hand-breakdown');
    container.innerHTML = '';
    const handTiles = [...gameState.hand];
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
    const mainTitle = document.createElement('p');
    mainTitle.className = 'font-bold text-2xl mb-6 text-center text-yellow-300';
    mainTitle.innerHTML = t('allBreakdown');
    container.appendChild(mainTitle);
    
    // å¾…ã¡ç‰Œã‚’åˆ†é¡ï¼šæœªé¸æŠï¼ˆå„ªå…ˆè¡¨ç¤ºï¼‰ã¨é¸æŠæ¸ˆã¿
    const selected = Array.from(gameState.selectedTiles);
    const missedTiles = gameState.waitingTiles.filter(tile => !selected.includes(tile));
    const selectedTiles = gameState.waitingTiles.filter(tile => selected.includes(tile));
    
    // æœªé¸æŠã®ç‰Œã‚’å„ªå…ˆè¡¨ç¤ºï¼ˆé»„è‰²ï¼‰
    const sortedWaitingTiles = [...missedTiles, ...selectedTiles];
    
    // ã™ã¹ã¦ã®å¾…ã¡ç‰Œã«ã¤ã„ã¦ç‰Œå‹ã‚’è¡¨ç¤º
    for (const tile of sortedWaitingTiles) {
        const tempHand = [...handTiles, tile];
        const breakdown = getWinningHandBreakdown(tempHand);
        if (breakdown) {
            const tileInfo = getTileInfo(gameState.tileType, tile);
            const isMissed = missedTiles.includes(tile);
            
            // å„å¾…ã¡ç‰Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const sectionDiv = document.createElement('div');
            sectionDiv.className = `breakdown-section ${isMissed ? 'missed-tile' : 'selected-tile'}`;
            
            const breakdownTitle = document.createElement('h3');
            breakdownTitle.style.color = isMissed ? '#fbbf24' : '#22c55e';
            breakdownTitle.textContent = `${t('winningTile')}`;
            breakdownTitle.appendChild(createInlineHandTile(tileInfo));
            breakdownTitle.appendChild(document.createTextNode(` ${tileInfo.name}`));
            sectionDiv.appendChild(breakdownTitle);

            const breakdownFlex = document.createElement('div');
            breakdownFlex.className = 'flex flex-wrap gap-4 justify-center';
            
            // é›€é ­
            const headContainer = createTileGroup(breakdown.head, t('head'));
            breakdownFlex.appendChild(headContainer);

            // é¢å­
            for (const meld of breakdown.melds) {
                const meldContainer = createTileGroup(meld, t('meld'));
                breakdownFlex.appendChild(meldContainer);
            }
            sectionDiv.appendChild(breakdownFlex);
            container.appendChild(sectionDiv);
        }
    }
}

function createTileGroup(tileNumbers, label) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'tile-group';
    
    // è©³ç´°ãªç‰Œã®ç¨®é¡ã‚’èª¬æ˜
    let detailText = '';
    if (tileNumbers.length === 2) {
        detailText = `${t('pair')}`;
    } else if (tileNumbers.length === 3) {
        if (tileNumbers[0] === tileNumbers[1] && tileNumbers[1] === tileNumbers[2]) {
            detailText = `${t('triplet')}`;
        } else {
            detailText = `${t('sequence')}`;
        }
    }

    const labelDiv = document.createElement('div');
    labelDiv.className = 'tile-group-label';
    labelDiv.textContent = detailText;
    
    const tilesDiv = document.createElement('div');
    tilesDiv.className = 'flex gap-1 justify-center';
    tileNumbers.forEach(tileNum => {
        const tileInfo = getTileInfo(gameState.tileType, tileNum);
        const tileDiv = document.createElement('div');
        tileDiv.className = 'hand-tile rounded-lg tile-shadow flex items-center justify-center';
        tileDiv.style.cssText = 'width: 32px; height: 45px; font-size: 28px;';
        tileDiv.appendChild(createTileImage(tileInfo));
        tileDiv.title = tileInfo.name;
        tilesDiv.appendChild(tileDiv);
    });

    groupContainer.appendChild(labelDiv);
    groupContainer.appendChild(tilesDiv);
    return groupContainer;
}

function updateLivesDisplay() {
    // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ã¿ãƒ©ã‚¤ãƒ•ã‚’è¡¨ç¤º
    const livesContainer = document.getElementById('lives-display');
    if (!livesContainer) return;
    
    if (gameState.mode === 'casual' || gameState.mode === 'story') {
        livesContainer.classList.remove('hidden');
        livesContainer.innerHTML = `<span class="font-bold">${t('lives')}</span> `;
        for (let i = 0; i < gameState.maxLives; i++) {
            if (i < gameState.lives) {
                livesContainer.innerHTML += 'â¤ï¸';
            } else {
                livesContainer.innerHTML += 'ğŸ–¤';
            }
        }
    } else {
        livesContainer.classList.add('hidden');
    }
}

function updateTimeExtensionButton() {
    let extensionBtn = document.getElementById('time-extension-btn');
    
    // ãƒœã‚¿ãƒ³ãŒç„¡ã‘ã‚Œã°ä½œæˆ
    if (!extensionBtn) {
        const slot = document.getElementById('time-extension-slot') || document.querySelector('.timer-container');
        if (!slot) return;

        const btnContainer = document.createElement('div');
        btnContainer.innerHTML = `
            <button id="time-extension-btn" class="time-extension-btn">
                <span id="time-extension-text"></span>
            </button>
        `;
        slot.appendChild(btnContainer);
        extensionBtn = document.getElementById('time-extension-btn');
        extensionBtn.addEventListener('click', useTimeExtension);
    }
    
    // ãƒœã‚¿ãƒ³è¡¨ç¤ºã¨çŠ¶æ…‹ã‚’æ›´æ–°
    const textSpan = document.getElementById('time-extension-text');

    const active = isActiveQuestion();
    const canUseExtension = gameState.timeExtensions > 0 && !gameState.isBossStage && active;

    if (canUseExtension) {
        extensionBtn.disabled = false;
        extensionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        textSpan.textContent = `${t('timeExtension')} ${t('timeExtensionDesc')} (${t('extensionsLeft')} ${gameState.timeExtensions})`;
    } else {
        extensionBtn.disabled = true;
        extensionBtn.classList.add('opacity-50', 'cursor-not-allowed');
        if (gameState.isBossStage) {
            textSpan.textContent = `${t('timeExtension')} (BOSS ${t('stage')})`;
        } else if (!active) {
            textSpan.textContent = `${t('timeExtension')} (${t('extensionsLeft')} ${gameState.timeExtensions})`;
        } else {
            textSpan.textContent = `${t('timeExtension')} (${t('extensionsLeft')} 0)`;
        }
    }

    // æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªã„ & å»¶é•·å¯èƒ½ãªã‚‰ã€ãƒœã‚¿ãƒ³ã‚’å°‘ã—ç›®ç«‹ãŸã›ã‚‹
    const shouldAttention = canUseExtension && gameState.timeLeft <= 5;
    extensionBtn.classList.toggle('attention', !!shouldAttention);
}

function useTimeExtension() {
    if (!isActiveQuestion()) return;
    if (gameState.timeExtensions <= 0 || gameState.isBossStage || gameState.isAnswered) return;

    playSound('select');
    
    gameState.timeExtensions--;
    gameState.timeLeft += 30;
    gameState.extendedTime += 30; // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã§ä½¿ã£ãŸå»¶é•·æ™‚é–“ã‚’è¨˜éŒ²

    // å»¶é•·ã§ 5ç§’ä»¥ä¸Šã«æˆ»ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ã¯æ­¢ã‚ã‚‹
    if (gameState.timeLeft > 5) {
        gameState.timerCuePlayed = false;
        stopTimerSound();
    }
    
    updateTimeExtensionButton();
    
    // ãƒ’ãƒ³ãƒˆæ¼”å‡ºã‚’è¡¨ç¤º
    const timerDisplay = document.getElementById('timer-display');
    timerDisplay.classList.add('time-extended');
    setTimeout(() => {
        timerDisplay.classList.remove('time-extended');
    }, 1000);
}

function showContinueOption() {
    // çµæœè¡¨ç¤ºã¯åŒã˜ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§å®Œçµã•ã›ã‚‹
    showResultLifeAction();
}

async function continueGame() {
    // ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ã¯ã€Œè§£ç­”æ¸ˆã¿ã€ã‹ã¤ã€Œé€²è¡Œä¸­ã§ã¯ãªã„ã€å ´åˆã®ã¿è¨±å¯
    if (!gameState.isAnswered) return;

    hideResultActions();

    // ç¶šè¡Œæ™‚ã«çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆå¤ã„å†…å®¹ã®ç©ã¿é‡ãªã‚Šã‚’é˜²ãï¼‰
    const resultSection = document.getElementById('result-section');
    if (resultSection) resultSection.classList.add('hidden');

    // åŒä¸€ã‚¹ãƒ†ãƒ¼ã‚¸ã§æ–°ã—ã„å•é¡Œã‚’å‡ºã™ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸æ•°ã¯å¢—ã‚„ã•ãªã„ï¼‰
    // ãƒœã‚¹ã®ãƒªãƒˆãƒ©ã‚¤ã¯æ®‹ã‚Šç§’æ•°ã‚’å¼•ãç¶™ãã€æ—¢å®šç§’æ•°ã¸ãƒªã‚»ãƒƒãƒˆã—ãªã„
    const stageTitle = gameState.isBossStage
        ? t('bossStage')
        : `${t('stage')} ${gameState.currentStage}`;
    const subtitle = `${t('difficulty')} ${getDifficultyBadgeHtml(gameState.difficulty)} <span class="opacity-80">(${t(`${gameState.difficulty}Desc`)})</span>`;
    await showStageIntro({ titleText: stageTitle, subtitleHtml: subtitle, durationMs: 3200 });

    if (gameState.isBossStage) {
        generateAndShowBossQuestion({ resetTime: false });
        return;
    }
    generateAndShowQuestion();
}

function giveUpGame() {
    // å³ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
    showGameOver(false);
}

function showVictory() {
    document.getElementById('game-screen').classList.add('hidden');
    const screen = document.getElementById('victory-screen');
    screen.classList.remove('hidden');
    // ã™ã¹ã¦ã®ãƒ¢ãƒ¼ãƒ‰ã§ currentStage ã‚’ä½¿ç”¨
    const finalQuestionsEl = document.getElementById('final-questions');
    if (finalQuestionsEl) finalQuestionsEl.textContent = String(gameState.currentStage);
    const finalCorrectEl = document.getElementById('final-correct');
    if (finalCorrectEl) finalCorrectEl.textContent = String(gameState.correctCount);

    const modeEl = document.getElementById('mode');
    if (modeEl) modeEl.textContent = getModeDisplayText(gameState.mode);

    const difficultyLabelEl = document.getElementById('final-difficulty-label');
    const difficultyEl = document.getElementById('final-difficulty');
    const showDifficulty = gameState.mode === 'casual' || gameState.mode === 'survival';
    if (difficultyLabelEl) difficultyLabelEl.textContent = `${t('difficulty')}:`;
    if (difficultyEl) {
        if (showDifficulty) {
            const diffKey = gameState.difficulty || 'easy';
            difficultyEl.innerHTML = `${getDifficultyBadgeHtml(diffKey)} <span class="opacity-80">(${t(`${diffKey}Desc`)})</span>`;
            difficultyLabelEl?.parentElement?.classList.remove('hidden');
        } else {
            difficultyLabelEl?.parentElement?.classList.add('hidden');
        }
    }

    const timeLeftEl = document.getElementById('final-time-left');
    if (timeLeftEl) timeLeftEl.textContent = String(Math.max(0, gameState.timeLeft || 0));

    const livesEl = document.getElementById('final-lives-left');
    const livesLabelEl = document.getElementById('final-lives-left-label');
    if (livesEl && livesLabelEl) {
        if (gameState.mode === 'casual' || gameState.mode === 'story') {
            livesEl.textContent = '';
            for (let i = 0; i < (gameState.maxLives || 3); i++) {
                livesEl.textContent += i < (gameState.lives || 0) ? 'â¤ï¸' : 'ğŸ–¤';
            }
            livesLabelEl.parentElement?.classList.remove('hidden');
        } else {
            // å¿µã®ãŸã‚ï¼ˆç¾çŠ¶ victory ã¯ boss ã‚¯ãƒªã‚¢æ™‚ã®ã¿ï¼‰
            livesLabelEl.parentElement?.classList.add('hidden');
        }
    }

    createConfetti();
    // 16:9 å›ºå®šãƒ•ãƒ¬ãƒ¼ãƒ è¨­è¨ˆï¼šãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ä½¿ã‚ãªã„
}

function showGameOver(timeUp) {
    const section = document.getElementById('result-section');
    const message = document.getElementById('result-message');
    const nextBtn = document.getElementById('next-btn');

    if (section && section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        section.classList.add('slide-down');
    }

    if (message) {
        message.textContent = timeUp ? t('timeUp') : t('incorrect');
        message.className = 'text-3xl font-bold text-red-300 mb-6';
    }

    if (nextBtn) nextBtn.classList.add('hidden');
    hideResultActions();
    showResultGameOverAction(timeUp);
    updateInteractionState();
}

function showGameOverOverlay(timeUp) {
    document.getElementById('game-screen').classList.add('hidden');
    const screen = document.getElementById('gameover-screen');
    screen.classList.remove('hidden');
    const message = document.getElementById('gameover-message');
    if (message) message.textContent = timeUp ? t('timeUp') : '';

    const finalScoreEl = document.getElementById('final-score');
    if (finalScoreEl) finalScoreEl.textContent = String(gameState.correctCount);

    const modeEl = document.getElementById('mode-gameover');
    if (modeEl) modeEl.textContent = getModeDisplayText(gameState.mode);

    const difficultyLabelEl = document.getElementById('final-difficulty-label-gameover');
    const difficultyEl = document.getElementById('final-difficulty-gameover');
    const showDifficulty = gameState.mode === 'casual' || gameState.mode === 'survival';
    if (difficultyLabelEl) difficultyLabelEl.textContent = `${t('difficulty')}:`;
    if (difficultyEl) {
        if (showDifficulty) {
            const diffKey = gameState.difficulty || 'easy';
            difficultyEl.innerHTML = `${getDifficultyBadgeHtml(diffKey)} <span class="opacity-80">(${t(`${diffKey}Desc`)})</span>`;
            difficultyLabelEl?.parentElement?.classList.remove('hidden');
        } else {
            difficultyLabelEl?.parentElement?.classList.add('hidden');
        }
    }
    // 16:9 å›ºå®šãƒ•ãƒ¬ãƒ¼ãƒ è¨­è¨ˆï¼šãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ä½¿ã‚ãªã„
}

function createConfetti() {
    const screen = document.getElementById('victory-screen');
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#FFD93D'];
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 3 + 's';
        confetti.style.animationDuration = (Math.random() * 2 + 3) + 's';
        screen.appendChild(confetti);
        setTimeout(() => confetti.remove(), 6000);
    }
}

function updateUILanguage() {
    document.getElementById('header-title').textContent = t('gameTitle');
    document.getElementById('header-subtitle').textContent = t('gameSubtitle');
    
    // è¨€èªé¸æŠç”»é¢
    document.getElementById('language-title').textContent = t('selectLanguage');
    document.getElementById('lang-ja-text').textContent = t('japanese');
    document.getElementById('lang-en-text').textContent = t('english');
    document.getElementById('lang-zh-text').textContent = t('chinese');
    
    // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
    document.getElementById('mode-title').textContent = t('selectMode');
    document.getElementById('casual-title').textContent = t('casualMode');
    document.getElementById('casual-desc').textContent = t('casualDesc');
    document.getElementById('story-title').textContent = t('storyMode');
    document.getElementById('story-desc').textContent = t('storyDesc');
    document.getElementById('survival-title').textContent = t('survivalMode');
    document.getElementById('survival-desc').textContent = t('survivalDesc');

    const tutorialBtnText = document.getElementById('tutorial-btn-text');
    if (tutorialBtnText) tutorialBtnText.textContent = t('tutorial');

    const modeBackText = document.getElementById('mode-back-text');
    if (modeBackText) modeBackText.textContent = t('back');
    
    // é›£æ˜“åº¦é¸æŠ
    document.getElementById('difficulty-title').textContent = t('selectDifficulty');
    document.getElementById('easy-title').textContent = t('easy');
    document.getElementById('easy-desc').textContent = t('easyDesc');
    document.getElementById('medium-title').textContent = t('medium');
    document.getElementById('medium-desc').textContent = t('mediumDesc');
    document.getElementById('hard-title').textContent = t('hard');
    document.getElementById('hard-desc').textContent = t('hardDesc');

    const difficultyBackText = document.getElementById('difficulty-back-text');
    if (difficultyBackText) difficultyBackText.textContent = t('back');
    
    // ã‚²ãƒ¼ãƒ ç”»é¢
    document.getElementById('hand-title').textContent = t('handTitle');
    document.getElementById('select-waiting-title').textContent = t('selectWaiting');
    document.getElementById('submit-text').textContent = t('submitAnswer');
    document.getElementById('next-text').textContent = t('nextQuestion');
    const resultMenuText = document.getElementById('result-menu-text');
    if (resultMenuText) resultMenuText.textContent = t('backToMenu');

    const resultContinueText = document.getElementById('result-continue-text');
    const resultBackText = document.getElementById('result-back-text');
    const resultOkText = document.getElementById('result-ok-text');
    if (resultContinueText) resultContinueText.textContent = t('continue');
    if (resultBackText) resultBackText.textContent = t('giveUp');
    if (resultOkText) resultOkText.textContent = t('ok');
    
    
    // å‹åˆ©/æ•—åŒ—ç”»é¢
    const resultOpen = !!document.getElementById('result-section') && !document.getElementById('result-section').classList.contains('hidden');
    document.getElementById('gameover-title').textContent = t('gameOver');
    const timeLeftLabel = document.getElementById('final-time-left-label');
    const livesLeftLabel = document.getElementById('final-lives-left-label');
    const modeLabel = document.getElementById('mode-label');
    if (modeLabel) modeLabel.textContent = t('modeLabel');
    const modeEl = document.getElementById('mode');
    if (modeEl) modeEl.textContent = getModeDisplayText(gameState.mode);

    const modeLabelGameOver = document.getElementById('mode-label-gameover');
    if (modeLabelGameOver) modeLabelGameOver.textContent = t('modeLabel');
    const modeElGameOver = document.getElementById('mode-gameover');
    if (modeElGameOver) modeElGameOver.textContent = getModeDisplayText(gameState.mode);

    const diffLabelVictory = document.getElementById('final-difficulty-label');
    if (diffLabelVictory) diffLabelVictory.textContent = `${t('difficulty')}:`;
    const diffLabelGameOver = document.getElementById('final-difficulty-label-gameover');
    if (diffLabelGameOver) diffLabelGameOver.textContent = `${t('difficulty')}:`;
    if (timeLeftLabel) timeLeftLabel.textContent = t('timeLeftLabel');
    if (livesLeftLabel) livesLeftLabel.textContent = t('livesLeftLabel');
    document.getElementById('final-score-label').textContent = t('finalScore');
    document.getElementById('play-again-victory').textContent = t('playAgain');
    document.getElementById('play-again-gameover').textContent = t('playAgain');
    document.getElementById('menu-victory').textContent = t('backToMenu');
    document.getElementById('menu-gameover').textContent = t('backToMenu');
    
    // ãƒ•ãƒƒã‚¿ãƒ¼
    document.getElementById('footer-text').innerHTML = `${t('footer')} &copy; 2026 Akira Akiyama`;

    // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
    const tutorialTitle = document.getElementById('tutorial-title');
    if (tutorialTitle) tutorialTitle.textContent = t('tutorialTitle');
    renderTutorialPage();
}

function resetGame() {
    stopTimer();
    stopTimerSound();
    gameState.mode = null;
    gameState.difficulty = null;
    gameState.currentQuestion = 0;
    gameState.currentStage = 0;
    gameState.correctCount = 0;
    gameState.timeBonus = 0;
    gameState.hand = [];
    gameState.counts = {};
    gameState.waitingTiles = [];
    gameState.selectedTiles.clear();
    gameState.isBossStage = false;
    gameState.isAnswered = false;
    gameState.isPaused = false;
    gameState.lives = 3;
    gameState.timeExtensions = gameState.maxTimeExtensions;
    gameState.extendedTime = 0;
    gameState.timeLeft = 0;
    gameState.maxTime = 0;
    gameState.timerCuePlayed = false;
    document.body.classList.remove('boss-stage');
    document.body.classList.remove('in-game');
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('victory-screen').classList.add('hidden');
    document.getElementById('gameover-screen').classList.add('hidden');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    const resultSection = document.getElementById('result-section');
    if (resultSection) resultSection.classList.add('hidden');
    hideResultActions();
    
    document.getElementById('mode-screen').classList.remove('hidden');
    updateInteractionState();
}

function selectLanguage(lang) {
    currentLang = lang;
    document.documentElement.lang = lang;
    document.title = t('gameTitle').replace(/ğŸ€„/g, '').trim();
    updateUILanguage();

    // è‹±èªã¸åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã€é€”ä¸­ã§ã‚‚è¬å­ãŒå‡ºãªã„ã‚ˆã†ã«ã™ã‚‹
    //ï¼ˆç”»åƒãŒæ¼¢å­—ç‰Œé¢ã®ãŸã‚ã€æµ·å¤–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¯åˆ¤èª­ã—ã¥ã‚‰ã„ï¼‰
    if (currentLang === 'en' && gameState?.tileType === 'man') {
        gameState.tileType = 'pin';
        const gameScreen = document.getElementById('game-screen');
        if (gameScreen && !gameScreen.classList.contains('hidden')) {
            try {
                renderHand();
                renderPossibleTiles();
            } catch {
                // ç”»é¢åˆ‡æ›¿ä¸­ã®æç”»å¤±æ•—ã¯ç„¡è¦–ã™ã‚‹
            }
        }
    }

    const languageScreen = document.getElementById('language-screen');
    const modeScreen = document.getElementById('mode-screen');
    languageScreen.style.opacity = '0';
    languageScreen.style.transform = 'scale(0.95)';
    setTimeout(() => {
        languageScreen.classList.add('hidden');
        languageScreen.style.opacity = '1';
        languageScreen.style.transform = 'scale(1)';
        modeScreen.classList.remove('hidden');
        modeScreen.classList.add('fade-in');
    }, 400);
}

function backToLanguageSelection() {
    const languageScreen = document.getElementById('language-screen');
    const modeScreen = document.getElementById('mode-screen');
    if (!languageScreen || !modeScreen) return;

    modeScreen.classList.add('hidden');
    languageScreen.classList.remove('hidden');
    languageScreen.classList.add('fade-in');
}

function backToModeSelection() {
    const difficultyScreen = document.getElementById('difficulty-screen');
    const modeScreen = document.getElementById('mode-screen');
    if (!difficultyScreen || !modeScreen) return;

    // é€”ä¸­ã¾ã§é¸ã‚“ã çŠ¶æ…‹ã‚’ç ´æ£„ã™ã‚‹
    gameState.mode = null;
    gameState.difficulty = null;

    difficultyScreen.classList.add('hidden');
    modeScreen.classList.remove('hidden');
    modeScreen.classList.add('fade-in');
}

function showPauseOverlay() {
    let overlay = document.getElementById('pause-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'pause-overlay';
        overlay.className = 'pause-overlay';
        overlay.innerHTML = `
            <div class="pause-content">
                <div class="text-6xl font-black mb-6">${t('paused')}</div>
                <div class="text-2xl opacity-80">${t('tapToResume')}</div>
            </div>
        `;
        overlay.addEventListener('click', resumeTimer);

        const root = document.getElementById('design-root');
        (root || document.body).appendChild(overlay);
    }
    overlay.classList.remove('hidden');
    overlay.classList.add('fade-in');
}

function hidePauseOverlay() {
    const overlay = document.getElementById('pause-overlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // åˆæœŸè¡¨ç¤ºã¯ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ç”»é¢ã®ã¿ã«ã™ã‚‹
    const preloadScreen = document.getElementById('preload-screen');
    const languageScreen = document.getElementById('language-screen');
    if (preloadScreen) preloadScreen.classList.remove('hidden');
    if (languageScreen) languageScreen.classList.add('hidden');

    initSounds();
    initTimerSound();
    applyUiScale();
    window.addEventListener('resize', applyUiScale);
    window.visualViewport?.addEventListener('resize', applyUiScale);

    // é€²æ—è¡¨ç¤ºä»˜ãã§ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
    const progressFill = document.getElementById('preload-progress-fill');
    const progressText = document.getElementById('preload-progress-text');
    preloadAssets({
        onProgress: ({ loaded, total }) => {
            const pct = total > 0 ? Math.round((loaded / total) * 100) : 0;
            if (progressFill) progressFill.style.width = `${pct}%`;
            if (progressText) progressText.textContent = `${pct}% (${loaded}/${total})`;
        }
    }).then(() => {
        if (preloadScreen) preloadScreen.classList.add('hidden');
        if (languageScreen) {
            languageScreen.classList.remove('hidden');
            languageScreen.classList.add('fade-in');
        }
    });

    // æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§éŸ³å£°ã‚’è§£æ”¾ï¼ˆiOS å¯¾ç­–ï¼‰
    document.addEventListener('pointerdown', unlockAudioOnce, { capture: true, once: true });
    document.addEventListener('touchstart', unlockAudioOnce, { capture: true, once: true, passive: true });

    document.getElementById('lang-ja').addEventListener('click', () => { playSound('select'); selectLanguage('ja'); });
    document.getElementById('lang-en').addEventListener('click', () => { playSound('select'); selectLanguage('en'); });
    document.getElementById('lang-zh').addEventListener('click', () => { playSound('select'); selectLanguage('zh'); });
    document.getElementById('casual-btn').addEventListener('click', () => { playSound('select'); startGameMode('casual'); });
    document.getElementById('story-btn').addEventListener('click', () => { playSound('select'); startGameMode('story'); });
    document.getElementById('survival-btn').addEventListener('click', () => { playSound('select'); startGameMode('survival'); });

    const modeBackBtn = document.getElementById('mode-back-btn');
    if (modeBackBtn) modeBackBtn.addEventListener('click', () => { playSound('tap'); backToLanguageSelection(); });

    const difficultyBackBtn = document.getElementById('difficulty-back-btn');
    if (difficultyBackBtn) difficultyBackBtn.addEventListener('click', () => { playSound('tap'); backToModeSelection(); });

    const tutorialBtn = document.getElementById('tutorial-btn');
    const tutorialScreen = document.getElementById('tutorial-screen');
    const tutorialPrevBtn = document.getElementById('tutorial-prev-btn');
    const tutorialNextBtn = document.getElementById('tutorial-next-btn');
    const tutorialCloseBtn = document.getElementById('tutorial-close-btn');

    function openTutorial() {
        if (!tutorialScreen) return;
        playSound('tap');
        tutorialPageIndex = 0;
        tutorialScreen.classList.remove('hidden');
        tutorialScreen.classList.add('fade-in');
        tutorialScreen.setAttribute('aria-hidden', 'false');
        updateUILanguage();
        renderTutorialPage();
    }

    function closeTutorial() {
        if (!tutorialScreen) return;
        playSound('tap');
        tutorialScreen.classList.add('hidden');
        tutorialScreen.setAttribute('aria-hidden', 'true');
    }

    if (tutorialBtn) tutorialBtn.addEventListener('click', openTutorial);

    if (tutorialScreen) {
        tutorialScreen.addEventListener('click', (e) => {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ï¼ˆèƒŒæ™¯ï¼‰ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            if (e.target === tutorialScreen) {
                closeTutorial();
            }
        });
    }

    if (tutorialPrevBtn) {
        tutorialPrevBtn.addEventListener('click', () => {
            playSound('tap');
            tutorialPageIndex = Math.max(0, tutorialPageIndex - 1);
            renderTutorialPage();
        });
    }

    if (tutorialNextBtn) {
        tutorialNextBtn.addEventListener('click', () => {
            const pages = getTutorialPages();
            const last = pages.length - 1;
            if (tutorialPageIndex >= last) {
                closeTutorial();
                return;
            }
            playSound('tap');
            tutorialPageIndex = Math.min(last, tutorialPageIndex + 1);
            renderTutorialPage();
        });
    }

    if (tutorialCloseBtn) tutorialCloseBtn.addEventListener('click', closeTutorial);
    document.getElementById('easy').addEventListener('click', () => { playSound('select'); startGameWithDifficulty('easy'); });
    document.getElementById('medium').addEventListener('click', () => { playSound('select'); startGameWithDifficulty('medium'); });
    document.getElementById('hard').addEventListener('click', () => { playSound('select'); startGameWithDifficulty('hard'); });
    document.getElementById('submit-btn').addEventListener('click', () => { playSound('select'); checkAnswer(); });
    document.getElementById('next-btn').addEventListener('click', () => { playSound('select'); startNewQuestion(); });

    // å‹åˆ©/ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã®ãƒœã‚¿ãƒ³
    const playAgainVictory = document.getElementById('play-again-victory');
    const menuVictory = document.getElementById('menu-victory');
    const playAgainGameOver = document.getElementById('play-again-gameover');
    const menuGameOver = document.getElementById('menu-gameover');
    if (playAgainVictory) playAgainVictory.addEventListener('click', () => { playSound('select'); restartCurrentRun(); });
    if (menuVictory) menuVictory.addEventListener('click', () => { playSound('select'); backToMenu(); });
    if (playAgainGameOver) playAgainGameOver.addEventListener('click', () => { playSound('select'); restartCurrentRun(); });
    if (menuGameOver) menuGameOver.addEventListener('click', () => { playSound('select'); backToMenu(); });
    
    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±/å¾©å¸°ã‚’ç›£è¦–
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±/æœ€å°åŒ–
            pauseTimer();
        } else {
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°
            if (gameState.isPaused && gameState.timerInterval) {
                // è‡ªå‹•å†é–‹ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯å¾…ã¡ï¼‰
            }
        }
    });
    
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±ï¼ˆåˆ¥ã‚¢ãƒ—ãƒªã¸åˆ‡æ›¿ï¼‰
    window.addEventListener('blur', () => {
        pauseTimer();
    });
    
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°
    window.addEventListener('focus', () => {
        // è‡ªå‹•å†é–‹ã—ãªã„ï¼ˆä¸€æ™‚åœæ­¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¯ãƒªãƒƒã‚¯å¾…ã¡ï¼‰
    });
});

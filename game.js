// è´ç‰Œã§GO! - ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯

const translations = {
    ja: {
        gameTitle: "ğŸ€„ è´ç‰Œã§GO! ğŸ€„",
        gameSubtitle: "éº»é›€è´ç‰Œãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚²ãƒ¼ãƒ ",
        selectMode: "ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„",
        casualMode: "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰",
        casualDesc: "9å• + BOSSã‚¹ãƒ†ãƒ¼ã‚¸\nå„å•45ç§’ã€3ãƒ©ã‚¤ãƒ•åˆ¶",
        storyMode: "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰",
        storyDesc: "åˆç´šâ†’ä¸­ç´šâ†’ä¸Šç´šå„3å• + BOSS\nå„å•30ç§’ã€3ãƒ©ã‚¤ãƒ•åˆ¶",
        survivalMode: "ã‚µãƒã‚¤ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰",
        survivalDesc: "60ç§’ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ\næ­£è§£ã™ã‚‹ã¨æ™‚é–“å›å¾©ã€ãƒ©ã‚¤ãƒ•ãªã—",
        selectDifficulty: "é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„",
        easy: "åˆç´š",
        easyDesc: "3é¢å¼µã¾ã§",
        medium: "ä¸­ç´š",
        mediumDesc: "6é¢å¼µã¾ã§",
        hard: "ä¸Šç´š",
        hardDesc: "9é¢å¼µã¾ã§",
        handTitle: "ğŸ´ æ‰‹ç‰Œ ğŸ´",
        selectWaiting: "ğŸ¯ å¾…ã¡ç‰Œã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ ğŸ¯",
        submitAnswer: "âœ¨ å›ç­”ã‚’ç¢ºèª âœ¨",
        correct: "ğŸ‰ æ­£è§£ã§ã™ï¼ç´ æ™´ã‚‰ã—ã„ï¼ ğŸ‰",
        incorrect: "âŒ æ®‹å¿µã€ä¸æ­£è§£ã§ã™ã€‚",
        timeUp: "â° æ™‚é–“åˆ‡ã‚Œã§ã™ï¼",
        correctAnswer: "ğŸ’¡ æ­£è§£ï¼š",
        nextQuestion: "â¡ï¸ æ¬¡ã®å•é¡Œ",
        question: "å•é¡Œ",
        bossStage: "ğŸ”¥ BOSS ã‚¹ãƒ†ãƒ¼ã‚¸ ğŸ”¥",
        bossChallenge: "ç´¯ç©æ™‚é–“ã§æŒ‘æˆ¦ï¼",
        bossComplete: "BOSSã‚¯ãƒªã‚¢ï¼",
        victory: "ğŸŠ å…¨å•ã‚¯ãƒªã‚¢ï¼ ğŸŠ",
        gameOver: "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼",
        finalQuestions: "å•é¡Œæ•°ï¼š",
        finalScore: "æ­£è§£æ•°ï¼š",
        timeLeftLabel: "æ®‹ã‚Šæ™‚é–“ï¼š",
        livesLeftLabel: "æ®‹ã‚Šãƒ©ã‚¤ãƒ•ï¼š",
        playAgain: "ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤",
        backToMenu: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹",
        footer: "è´ç‰Œã§GO!",
        selectLanguage: "è¨€èªã‚’é¸æŠ / Select Language / é¸æ“‡èªè¨€",
        japanese: "æ—¥æœ¬èª",
        english: "English",
        chinese: "ç¹é«”ä¸­æ–‡",
        allBreakdown: "ğŸ“‹ å’Œäº†ç‰Œå‹ã¯ä»¥ä¸‹ã®é€šã‚Šï¼š",
        winningTile: "ğŸ¯ å’Œäº†ç‰Œï¼š",
        head: "é›€é ­",
        meld: "é¢å­",
        // pair: "å¯¾å­ï¼š",
        // triplet: "åˆ»å­ï¼š",
        // sequence: "é †å­ï¼š",
        pair: "å¯¾å­",
        triplet: "åˆ»å­",
        sequence: "é †å­",
        pin: "ç­’",
        man: "è¬",
        sou: "ç´¢",
        lives: "ãƒ©ã‚¤ãƒ•ï¼š",
        loseLife: "ãƒ©ã‚¤ãƒ• -1",
        continue: "ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼",
        giveUp: "ã‚ãã‚‰ã‚ã‚‹",
        stage: "ã‚¹ãƒ†ãƒ¼ã‚¸",
        difficulty: "é›£æ˜“åº¦",
        maxWaits: "æœ€å¤§å¾…ã¡æ•°ï¼š",
        correctCount: "æ­£è§£æ•°ï¼š",
        paused: "â¸ï¸ ä¸€æ™‚åœæ­¢",
        tapToResume: "ã‚¿ãƒƒãƒ—ã—ã¦å†é–‹",
        timeExtension: "â±ï¸ é•·è€ƒ",
        timeExtensionDesc: "+30ç§’",
        extensionsLeft: "æ®‹ã‚Š",
        ok: "OK",

        storyHelpTitle: "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®é›£æ˜“åº¦",
        storyHelpBody: "åˆç´šï¼šæœ€å¤§3é¢å¼µï¼ˆå¾…ã¡ï¼‰\nä¸­ç´šï¼šæœ€å¤§6é¢å¼µï¼ˆå¾…ã¡ï¼‰\nä¸Šç´šï¼šæœ€å¤§9é¢å¼µï¼ˆå¾…ã¡ï¼‰\n\nã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯3ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«é›£æ˜“åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚"
    },
    en: {
        gameTitle: "ğŸ€„ Tenpai de GO! ğŸ€„",
        gameSubtitle: "Mahjong Tenpai Training Game",
        selectMode: "Select Game Mode",
        casualMode: "Casual Mode",
        casualDesc: "9 Questions + BOSS Stage\n45 sec each, 3 lives",
        storyMode: "Story Mode",
        storyDesc: "3 Questions each from Easyâ†’Mediumâ†’Hard + BOSS\n30 sec each, 3 lives",
        survivalMode: "Survival Mode",
        survivalDesc: "Start with 60 sec\nTime extension if correct, no lives",
        selectDifficulty: "Select Difficulty",
        easy: "Easy",
        easyDesc: "Up to 3 waits",
        medium: "Medium",
        mediumDesc: "Up to 6 waits",
        hard: "Hard",
        hardDesc: "Up to 9 waits",
        handTitle: "ğŸ´ Your Hand ğŸ´",
        selectWaiting: "ğŸ¯ Select All Waiting Tiles ğŸ¯",
        submitAnswer: "âœ¨ Check Answer âœ¨",
        correct: "ğŸ‰ Correct! Excellent! ğŸ‰",
        incorrect: "âŒ Incorrect!",
        timeUp: "â° Time's Up!",
        correctAnswer: "ğŸ’¡ Correct Answer:",
        nextQuestion: "â¡ï¸ Next Question",
        question: "Question",
        bossStage: "ğŸ”¥ BOSS STAGE ğŸ”¥",
        bossChallenge: "Use accumulated time!",
        bossComplete: "BOSS Defeated!",
        victory: "ğŸŠ VICTORY! ğŸŠ",
        gameOver: "GAME OVER",
        finalQuestions: "Questions:",
        finalScore: "Correct:",
        timeLeftLabel: "Time Left:",
        livesLeftLabel: "Lives Left:",
        playAgain: "Play Again",
        backToMenu: "Back to Menu",
        footer: "Tenpai de GO!",
        selectLanguage: "è¨€èªã‚’é¸æŠ / Select Language / é¸æ“‡èªè¨€",
        japanese: "Japanese",
        english: "English",
        chinese: "Traditional Chinese",
        allBreakdown: "ğŸ“‹ All Winning Hand Patterns as follows:",
        winningTile: "ğŸ¯ Winning Tile:",
        head: "Pair",
        meld: "Meld",
        // pair: "Pair: ",
        // triplet: "Triplet: ",
        // sequence: "Sequence: ",
        pair: "Pair",
        triplet: "Triplet",
        sequence: "Sequence",
        pin: "Pin",
        man: "Man",
        sou: "Sou",
        lives: "Lives:",
        loseLife: "Life -1",
        continue: "Continue",
        giveUp: "Give Up",
        stage: "Stage",
        difficulty: "Difficulty",
        maxWaits: "Max waits:",
        correctCount: "Correct:",
        paused: "â¸ï¸ PAUSED",
        tapToResume: "Tap to Resume",
        timeExtension: "â±ï¸ Time Extension",
        timeExtensionDesc: "+30s",
        extensionsLeft: "Left",
        ok: "OK",

        storyHelpTitle: "Story Mode Difficulty",
        storyHelpBody: "Easy: Up to 3 waits\nMedium: Up to 6 waits\nHard: Up to 9 waits\n\nDifficulty increases every 3 stages."
    },
    zh: {
        gameTitle: "ğŸ€„ è½ç‰ŒGO! ğŸ€„",
        gameSubtitle: "éº»é›€è½ç‰Œè¨“ç·´éŠæˆ²",
        selectMode: "é¸æ“‡éŠæˆ²æ¨¡å¼",
        casualMode: "ä¼‘é–’æ¨¡å¼",
        casualDesc: "9æ¢å•é¡Œ + BOSSé—œå¡\næ¯é¡Œ45ç§’ï¼Œ3æ¢ç”Ÿå‘½",
        storyMode: "é—–é—œæ¨¡å¼",
        storyDesc: "åˆç´šâ†’ä¸­ç´šâ†’é«˜ç´šå„3æ¢å•é¡Œ + BOSS\næ¯é¡Œ30ç§’ï¼Œ3æ¢ç”Ÿå‘½",
        survivalMode: "ç”Ÿå­˜æ¨¡å¼",
        survivalDesc: "ç”±60ç§’é–‹å§‹\nç­”å°å¯å›å¾©æ™‚é–“ï¼Œæ²’æœ‰ç”Ÿå‘½æ•¸",
        selectDifficulty: "é¸æ“‡é›£åº¦",
        easy: "åˆç´š",
        easyDesc: "æœ€å¤šè½3å¼µ",
        medium: "ä¸­ç´š",
        mediumDesc: "æœ€å¤šè½6å¼µ",
        hard: "é«˜ç´š",
        hardDesc: "æœ€å¤šè½9å¼µ",
        handTitle: "ğŸ´ æ‰‹ç‰Œ ğŸ´",
        selectWaiting: "ğŸ¯ é¸æ“‡æ‰€æœ‰è½çš„ç‰Œ ğŸ¯",
        submitAnswer: "âœ¨ ç¢ºèªç­”æ¡ˆ âœ¨",
        correct: "ğŸ‰ æ­£ç¢ºï¼å¤ªæ£’äº†ï¼ ğŸ‰",
        incorrect: "âŒ å¯æƒœï¼Œä¸æ­£ç¢ºã€‚",
        timeUp: "â° æ™‚é–“åˆ°äº†ï¼",
        correctAnswer: "ğŸ’¡ æ­£ç¢ºç­”æ¡ˆï¼š",
        nextQuestion: "â¡ï¸ ä¸‹ä¸€é¡Œ",
        question: "å•é¡Œ",
        bossStage: "ğŸ”¥ BOSS é—œå¡ ğŸ”¥",
        bossChallenge: "ç”¨ç´¯ç©æ™‚é–“æŒ‘æˆ°ï¼",
        bossComplete: "æ“Šæ•—BOSSï¼",
        victory: "ğŸŠ å…¨éƒ¨é€šé—œï¼ ğŸŠ",
        gameOver: "éŠæˆ²çµæŸ",
        finalQuestions: "å•é¡Œæ•¸ï¼š",
        finalScore: "æ­£ç¢ºæ•¸ï¼š",
        timeLeftLabel: "å‰©é¤˜æ™‚é–“ï¼š",
        livesLeftLabel: "å‰©é¤˜ç”Ÿå‘½ï¼š",
        playAgain: "å†ç©ä¸€æ¬¡",
        backToMenu: "è¿”å›é¸å–®",
        footer: "è½ç‰ŒGO!",
        selectLanguage: "è¨€èªã‚’é¸æŠ / Select Language / é¸æ“‡èªè¨€",
        japanese: "æ—¥æœ¬èª",
        english: "English",
        chinese: "ç¹é«”ä¸­æ–‡",
        allBreakdown: "ğŸ“‹ æ‰€æœ‰è½çš„ç‰Œçš„é£Ÿèƒ¡ç‰Œå‹å¦‚ä¸‹ï¼š",
        winningTile: "ğŸ¯ é£Ÿèƒ¡ç‰Œï¼š",
        head: "çœ¼",
        meld: "é¢å­",
        // pair: "çœ¼ï¼š",
        // triplet: "åˆ»å­ï¼š",
        // sequence: "é †å­ï¼š",
        pair: "çœ¼",
        triplet: "åˆ»å­",
        sequence: "é †å­",
        pin: "ç­’",
        man: "è¬",
        sou: "ç´¢",
        lives: "ç”Ÿå‘½ï¼š",
        loseLife: "ç”Ÿå‘½ -1",
        continue: "ç¹¼çºŒéŠæˆ²",
        giveUp: "æ”¾æ£„",
        stage: "é—œå¡",
        difficulty: "é›£åº¦",
        maxWaits: "æœ€å¤šè½ç‰Œæ•¸ï¼š",
        correctCount: "æ­£ç¢ºæ•¸ï¼š",
        paused: "â¸ï¸ å·²æš«åœ",
        tapToResume: "é»æ“Šç¹¼çºŒ",
        timeExtension: "â±ï¸ å»¶é•·",
        timeExtensionDesc: "+30ç§’",
        extensionsLeft: "å‰©é¤˜",
        ok: "OK",

        storyHelpTitle: "é—–é—œæ¨¡å¼é›£åº¦èªªæ˜",
        storyHelpBody: "åˆç´šï¼šæœ€å¤šè½3å¼µ\nä¸­ç´šï¼šæœ€å¤šè½6å¼µ\né«˜ç´šï¼šæœ€å¤šè½9å¼µ\n\né—–é—œæ¨¡å¼æ¯3é—œæœƒæå‡ä¸€æ¬¡é›£åº¦ã€‚"
    }
};

let currentLang = 'ja';
const t = (key) => translations[currentLang][key] || key;

let stageIntroTimeoutId = null;

function getDifficultyBadgeHtml(diffKey) {
    const key = diffKey || 'easy';
    const diffName = t(key);
    const diffBadgeClass = key === 'easy'
        ? 'difficulty-badge difficulty-badge--easy'
        : key === 'medium'
            ? 'difficulty-badge difficulty-badge--medium'
            : 'difficulty-badge difficulty-badge--hard';
    return `<span class="${diffBadgeClass}">${diffName}</span>`;
}

function hideStageIntro({ immediate = false } = {}) {
    const overlay = document.getElementById('stage-intro');
    if (!overlay) return;

    if (stageIntroTimeoutId) {
        clearTimeout(stageIntroTimeoutId);
        stageIntroTimeoutId = null;
    }

    if (immediate) {
        overlay.classList.add('hidden');
        overlay.classList.remove('is-leaving');
        overlay.setAttribute('aria-hidden', 'true');
        return;
    }

    overlay.classList.add('is-leaving');
    stageIntroTimeoutId = setTimeout(() => {
        overlay.classList.add('hidden');
        overlay.classList.remove('is-leaving');
        overlay.setAttribute('aria-hidden', 'true');
        stageIntroTimeoutId = null;
    }, 460);
}

function showStageIntro({ titleText, subtitleHtml, durationMs }) {
    const overlay = document.getElementById('stage-intro');
    const titleEl = document.getElementById('stage-intro-title');
    const subtitleEl = document.getElementById('stage-intro-subtitle');
    if (!overlay || !titleEl || !subtitleEl) return Promise.resolve();

    if (stageIntroTimeoutId) {
        clearTimeout(stageIntroTimeoutId);
        stageIntroTimeoutId = null;
    }

    // safety: ensure timer isn't running during intro
    stopTimer();

    titleEl.textContent = titleText || '';
    subtitleEl.innerHTML = subtitleHtml || '';

    overlay.classList.remove('hidden');
    overlay.classList.remove('is-leaving');
    overlay.setAttribute('aria-hidden', 'false');

    const ms = Math.min(5000, Math.max(3000, durationMs ?? 3800));

    return new Promise((resolve) => {
        stageIntroTimeoutId = setTimeout(() => {
            hideStageIntro();
            resolve();
        }, ms);
    });
}

function isDebugScaleEnabled() {
    try {
        return new URLSearchParams(window.location.search).get('debug') === '1';
    } catch {
        return false;
    }
}

function ensureScaleDebugOverlay() {
    if (!isDebugScaleEnabled()) return null;
    let overlay = document.getElementById('scale-debug');
    if (overlay) return overlay;

    overlay = document.createElement('div');
    overlay.id = 'scale-debug';
    overlay.className = 'scale-debug';
    document.body.appendChild(overlay);
    return overlay;
}

function applyUiScale() {
    const stage = document.getElementById('scale-stage');
    if (!stage) return;

    const baseWidth = 1280;
    const baseHeight = 720;

    const viewportWidth = window.visualViewport?.width ?? window.innerWidth;
    const viewportHeight = window.visualViewport?.height ?? window.innerHeight;

    // ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã® UI / ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã€å°‘ã—ä½™ç™½ã‚’ç¢ºä¿
    const safetyPadding = 8;
    const availableWidth = Math.max(0, viewportWidth - safetyPadding * 2);
    const availableHeight = Math.max(0, viewportHeight - safetyPadding * 2);

    // å¸¸ã«ã€Œ16:9 ã®è¨­è¨ˆç”»é¢ï¼ˆ1280x720ï¼‰ã‚’æ­ªã‚ãšã€ãã®ã¾ã¾ç”»é¢å†…ã«åã‚ã‚‹ã€
    // ï¼ç¸¦æ¨ªã©ã¡ã‚‰ã‹å°ã•ã„æ–¹ã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆè£åˆ‡ã‚Šã¯ã—ãªã„ï¼‰
    const scale = Math.min(availableWidth / baseWidth, availableHeight / baseHeight);
    // æ¥µå°ç”»é¢å‘ã‘ã«æœ€å°å€¤ã¯ç¶­æŒ
    const clamped = Math.max(0.05, scale);

    document.documentElement.style.setProperty('--ui-scale', clamped.toFixed(4));

    // Optional debug overlay for sizing issues
    const overlay = ensureScaleDebugOverlay();
    if (overlay) {
        stage.classList.add('debug-outline');
        const rect = stage.getBoundingClientRect();
        overlay.textContent = [
            `visualViewport: ${Math.round(viewportWidth)}x${Math.round(viewportHeight)} (css px)`,
            `available: ${Math.round(availableWidth)}x${Math.round(availableHeight)} (padding ${safetyPadding}*2)`,
            `scale: ${clamped.toFixed(4)}  DPR: ${window.devicePixelRatio || 1}`,
            `stage rect: ${Math.round(rect.width)}x${Math.round(rect.height)} (px)`,
            `stage base: ${baseWidth}x${baseHeight} (design)`,
        ].join('\n');
    } else {
        stage.classList.remove('debug-outline');
    }
}

function hideResultActions() {
    const actions = document.getElementById('result-actions');
    if (!actions) return;

    actions.classList.add('hidden');

    const title = document.getElementById('result-actions-title');
    const body = document.getElementById('result-actions-body');
    if (title) title.textContent = '';
    if (body) body.textContent = '';

    const continueBtn = document.getElementById('result-continue-btn');
    const backBtn = document.getElementById('result-back-btn');
    const okBtn = document.getElementById('result-ok-btn');
    if (continueBtn) continueBtn.classList.add('hidden');
    if (backBtn) backBtn.classList.add('hidden');
    if (okBtn) okBtn.classList.add('hidden');
}

let pendingOkAction = null;

function showResultOkAction({ titleText, titleClassName, bodyText = '', okText = null, onOk }) {
    const actions = document.getElementById('result-actions');
    if (!actions) return;

    const title = document.getElementById('result-actions-title');
    const body = document.getElementById('result-actions-body');
    const continueBtn = document.getElementById('result-continue-btn');
    const backBtn = document.getElementById('result-back-btn');
    const okBtn = document.getElementById('result-ok-btn');
    const okTextSpan = document.getElementById('result-ok-text');

    pendingOkAction = typeof onOk === 'function' ? onOk : null;

    if (title) {
        title.textContent = titleText || '';
        title.className = titleClassName || 'text-3xl font-black mb-3 text-center';
    }
    if (body) body.textContent = bodyText || '';

    if (continueBtn) continueBtn.classList.add('hidden');
    if (backBtn) backBtn.classList.add('hidden');

    if (okTextSpan) okTextSpan.textContent = okText || t('ok');
    if (okBtn) {
        okBtn.classList.remove('hidden');
        okBtn.disabled = false;
        okBtn.onclick = () => {
            if (!pendingOkAction) return;
            okBtn.disabled = true;
            const action = pendingOkAction;
            pendingOkAction = null;
            action();
        };
    }

    actions.classList.remove('hidden');
}

function showResultLifeAction() {
    const actions = document.getElementById('result-actions');
    if (!actions) return;

    const title = document.getElementById('result-actions-title');
    const body = document.getElementById('result-actions-body');
    if (title) {
        title.textContent = t('loseLife');
        title.className = 'text-3xl font-black mb-3 text-yellow-300 text-center';
    }
    if (body) {
        const lives = Math.max(0, gameState.lives);
        const maxLives = Math.max(0, gameState.maxLives || 3);

        let heartsHtml = '<div class="result-lives" aria-label="lives">';
        for (let i = 0; i < maxLives; i++) {
            if (i < lives) {
                heartsHtml += '<span class="life-heart">â¤ï¸</span>';
                continue;
            }

            // â¤ï¸/ğŸ–¤ ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€å¤±ã£ãŸåˆ†ã‚’åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹
            if (i === lives) {
                heartsHtml += '<span id="result-pending-loss-heart" class="life-heart heart-toggle pending-loss">'
                    + '<span class="heart-on">â¤ï¸</span>'
                    + '<span class="heart-off">ğŸ–¤</span>'
                    + '</span>';
                continue;
            }

            heartsHtml += '<span class="life-heart">ğŸ–¤</span>';
        }
        heartsHtml += '</div>';

        body.innerHTML = heartsHtml;
    }

    const continueBtn = document.getElementById('result-continue-btn');
    const backBtn = document.getElementById('result-back-btn');
    const okBtn = document.getElementById('result-ok-btn');
    const continueText = document.getElementById('result-continue-text');
    const backText = document.getElementById('result-back-text');
    if (continueText) continueText.textContent = t('continue');
    if (backText) backText.textContent = t('giveUp');

    if (okBtn) okBtn.classList.add('hidden');

    if (continueBtn) {
        continueBtn.classList.remove('hidden');
        continueBtn.disabled = false;
        continueBtn.onclick = () => {
            playSound('continue');
            // ç¶šè¡Œå‰ã«ã€å¤±ã£ãŸãƒ©ã‚¤ãƒ•ãŒæ¶ˆãˆã‚‹æ¼”å‡ºã‚’å…¥ã‚Œã‚‹
            continueBtn.disabled = true;
            const pending = document.getElementById('result-pending-loss-heart');
            if (!pending) {
                continueGame();
                return;
            }
            pending.classList.remove('pending-loss');
            pending.classList.add('removing');
            setTimeout(() => {
                pending.className = 'life-heart';
                pending.textContent = 'ğŸ–¤';
                continueGame();
            }, 360);
        };
    }
    if (backBtn) {
        backBtn.classList.remove('hidden');
        backBtn.disabled = false;
        backBtn.onclick = () => {
            giveUpGame();
        };
    }

    actions.classList.remove('hidden');
}

function showResultGameOverAction(timeUp) {
    showResultOkAction({
        titleText: t('gameOver'),
        titleClassName: 'text-3xl font-black mb-3 text-red-300 text-center',
        bodyText: '',
        onOk: () => {
            playSound('gameover');
            showGameOverOverlay(timeUp);
        }
    });
}

const tileImages = {
    pin: {
        1: 'Pin1.png',
        2: 'Pin2.png',
        3: 'Pin3.png',
        4: 'Pin4.png',
        5: 'Pin5.png',
        6: 'Pin6.png',
        7: 'Pin7.png',
        8: 'Pin8.png',
        9: 'Pin9.png'
    },
    man: {
        1: 'Man1.png',
        2: 'Man2.png',
        3: 'Man3.png',
        4: 'Man4.png',
        5: 'Man5.png',
        6: 'Man6.png',
        7: 'Man7.png',
        8: 'Man8.png',
        9: 'Man9.png'
    },
    sou: {
        1: 'Sou1.png',
        2: 'Sou2.png',
        3: 'Sou3.png',
        4: 'Sou4.png',
        5: 'Sou5.png',    
        6: 'Sou6.png',
        7: 'Sou7.png',
        8: 'Sou8.png',
        9: 'Sou9.png'
    }
};
const tileNames = {
    ja: {
        pin: { 1: 'ä¸€ç­’ï¼ˆã‚¤ãƒ¼ãƒ”ãƒ³ï¼‰', 2: 'äºŒç­’ï¼ˆãƒªãƒ£ãƒ³ãƒ”ãƒ³ï¼‰', 3: 'ä¸‰ç­’ï¼ˆã‚µãƒ³ãƒ”ãƒ³ï¼‰', 4: 'å››ç­’ï¼ˆã‚¹ãƒ¼ãƒ”ãƒ³ï¼‰', 5: 'äº”ç­’ï¼ˆã‚¦ãƒ¼ãƒ”ãƒ³ï¼‰', 6: 'å…­ç­’ï¼ˆãƒ­ãƒ¼ãƒ”ãƒ³ï¼‰', 7: 'ä¸ƒç­’ï¼ˆãƒãƒ¼ãƒ”ãƒ³ï¼‰', 8: 'å…«ç­’ï¼ˆãƒ‘ãƒ¼ãƒ”ãƒ³ï¼‰', 9: 'ä¹ç­’ï¼ˆã‚­ãƒ¥ãƒ¼ãƒ”ãƒ³ï¼‰' },
        man: { 1: 'ä¸€è¬ï¼ˆã‚¤ãƒ¼ãƒãƒ³ï¼‰', 2: 'äºŒè¬ï¼ˆãƒªãƒ£ãƒ³ãƒãƒ³ï¼‰', 3: 'ä¸‰è¬ï¼ˆã‚µãƒ³ãƒãƒ³ï¼‰', 4: 'å››è¬ï¼ˆã‚¹ãƒ¼ãƒãƒ³ï¼‰', 5: 'äº”è¬ï¼ˆã‚¦ãƒ¼ãƒãƒ³ï¼‰', 6: 'å…­è¬ï¼ˆãƒ­ãƒ¼ãƒãƒ³ï¼‰', 7: 'ä¸ƒè¬ï¼ˆãƒãƒ¼ãƒãƒ³ï¼‰', 8: 'å…«è¬ï¼ˆãƒ‘ãƒ¼ãƒãƒ³ï¼‰', 9: 'ä¹è¬ï¼ˆã‚­ãƒ¥ãƒ¼ãƒãƒ³ï¼‰' },
        sou: { 1: 'ä¸€ç´¢ï¼ˆã‚¤ãƒ¼ã‚½ãƒ¼ï¼‰', 2: 'äºŒç´¢ï¼ˆãƒªãƒ£ãƒ³ã‚½ãƒ¼ï¼‰', 3: 'ä¸‰ç´¢ï¼ˆã‚µãƒ³ã‚½ãƒ¼ï¼‰', 4: 'å››ç´¢ï¼ˆã‚¹ãƒ¼ã‚½ãƒ¼ï¼‰', 5: 'äº”ç´¢ï¼ˆã‚¦ãƒ¼ã‚½ãƒ¼ï¼‰', 6: 'å…­ç´¢ï¼ˆãƒ­ãƒ¼ã‚½ãƒ¼ï¼‰', 7: 'ä¸ƒç´¢ï¼ˆãƒãƒ¼ã‚½ãƒ¼ï¼‰', 8: 'å…«ç´¢ï¼ˆãƒ‘ãƒ¼ã‚½ãƒ¼ï¼‰', 9: 'ä¹ç´¢ï¼ˆã‚­ãƒ¥ãƒ¼ã‚½ãƒ¼ï¼‰' }
    },
    en: {
        pin: { 1: '1-Pin', 2: '2-Pin', 3: '3-Pin', 4: '4-Pin', 5: '5-Pin', 6: '6-Pin', 7: '7-Pin', 8: '8-Pin', 9: '9-Pin' },
        man: { 1: '1-Man', 2: '2-Man', 3: '3-Man', 4: '4-Man', 5: '5-Man', 6: '6-Man', 7: '7-Man', 8: '8-Man', 9: '9-Man' },
        sou: { 1: '1-Sou', 2: '2-Sou', 3: '3-Sou', 4: '4-Sou', 5: '5-Sou', 6: '6-Sou', 7: '7-Sou', 8: '8-Sou', 9: '9-Sou' }
    },
    zh: {
        pin: { 1: 'ä¸€ç­’', 2: 'äºŒç­’', 3: 'ä¸‰ç­’', 4: 'å››ç­’', 5: 'äº”ç­’', 6: 'å…­ç­’', 7: 'ä¸ƒç­’', 8: 'å…«ç­’', 9: 'ä¹ç­’' },
        man: { 1: 'ä¸€è¬', 2: 'äºŒè¬', 3: 'ä¸‰è¬', 4: 'å››è¬', 5: 'äº”è¬', 6: 'å…­è¬', 7: 'ä¸ƒè¬', 8: 'å…«è¬', 9: 'ä¹è¬' },
        sou: { 1: 'ä¸€ç´¢', 2: 'äºŒç´¢', 3: 'ä¸‰ç´¢', 4: 'å››ç´¢', 5: 'äº”ç´¢', 6: 'å…­ç´¢', 7: 'ä¸ƒç´¢', 8: 'å…«ç´¢', 9: 'ä¹ç´¢' }
    }
};

const getTileInfo = (type, number) => {
    const safeType = tileImages[type] ? type : 'pin';
    const src = tileImages[safeType]?.[number] || tileImages.pin[number];
    const name = tileNames[currentLang]?.[safeType]?.[number] || `${number}-${t(safeType)}`;
    return {
        imgSrc: `assets/${src}`,
        name
    };
};

function pickRandomTileType() {
    // For English UI, avoid Man tiles because the tile face uses kanji.
    const types = currentLang === 'en' ? ['pin', 'sou'] : ['pin', 'man', 'sou'];
    return types[Math.floor(Math.random() * types.length)];
}

// ========== Sounds ==========
const soundConfig = {
    select: { src: 'assets/select.mp3', pool: 4 },
    tap: { src: 'assets/tap.mp3', pool: 6 },
    correct: { src: 'assets/correct.mp3', pool: 2 },
    incorrect: { src: 'assets/incorrect.mp3', pool: 2 },
    continue: { src: 'assets/continue.mp3', pool: 2 },
    gameover: { src: 'assets/gameover.mp3', pool: 2 },
    victory: { src: 'assets/victory.mp3', pool: 2 },
    timeup: { src: 'assets/timeup.mp3', pool: 2 }
};

const soundPools = new Map();

let audioUnlocked = false;

function unlockAudioOnce() {
    if (audioUnlocked) return;

    // iOS (Safari/Chrome) blocks audio playback unless it is initiated by a user gesture.
    // Prime all audio elements on the first interaction so later timer-driven sounds work.
    const audiosToPrime = [];
    for (const pool of soundPools.values()) {
        for (const audio of pool) audiosToPrime.push(audio);
    }
    if (timerAudio) audiosToPrime.push(timerAudio);

    let anySucceeded = false;

    for (const audio of audiosToPrime) {
        try {
            const originalVolume = audio.volume;
            audio.volume = 0;
            audio.currentTime = 0;
            const p = audio.play();

            // Immediately pause/reset; we only need a successful play() within a gesture.
            audio.pause();
            audio.currentTime = 0;
            audio.volume = originalVolume;

            if (p && typeof p.then === 'function') {
                anySucceeded = true;
                // Avoid unhandled rejections
                p.catch(() => {});
            } else {
                anySucceeded = true;
            }
        } catch {
            // ignore
        }
    }

    if (anySucceeded) audioUnlocked = true;
}

function initSounds() {
    for (const [name, cfg] of Object.entries(soundConfig)) {
        const poolSize = Math.max(1, cfg.pool || 1);
        const pool = [];
        for (let i = 0; i < poolSize; i++) {
            const audio = new Audio(cfg.src);
            audio.preload = 'auto';
            pool.push(audio);
        }
        soundPools.set(name, pool);
    }
}

function playSound(name) {
    const pool = soundPools.get(name);
    if (!pool || pool.length === 0) return;

    let audio = pool.find(a => a.paused || a.ended);
    if (!audio) audio = pool[0];

    try {
        audio.currentTime = 0;
        const p = audio.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
    } catch {
        // ignore
    }
}

// timer.mp3 ã¯ã€Œ5ç§’ä»¥å†…ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­ã«ãƒ«ãƒ¼ãƒ—å†ç”Ÿã€ã™ã‚‹å°‚ç”¨éŸ³
let timerAudio = null;

function initTimerSound() {
    timerAudio = new Audio('assets/timer.mp3');
    timerAudio.preload = 'auto';
    timerAudio.loop = true;
}

function startTimerSound() {
    if (!timerAudio) return;
    if (!timerAudio.paused) return;
    try {
        const p = timerAudio.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
    } catch {
        // ignore
    }
}

function pauseTimerSound() {
    if (!timerAudio) return;
    if (!timerAudio.paused) timerAudio.pause();
}

function stopTimerSound() {
    if (!timerAudio) return;
    timerAudio.pause();
    timerAudio.currentTime = 0;
}

function createTileImage(tileInfo) {
    const img = document.createElement('img');
    img.src = tileInfo.imgSrc;
    img.alt = tileInfo.name;
    img.draggable = false;
    img.className = 'tile-img';
    return img;
}

function createInlineHandTile(tileInfo) {
    const tile = document.createElement('span');
    tile.className = 'hand-tile tile-inline-hand rounded-lg tile-shadow';
    tile.title = tileInfo.name;
    tile.appendChild(createTileImage(tileInfo));
    return tile;
}

const gameState = {
    mode: null, difficulty: null, currentQuestion: 0, currentStage: 0, correctCount: 0,
    hand: [], counts: {}, waitingTiles: [], selectedTiles: new Set(), tileType: 'pin',
    timeLeft: 0, maxTime: 0, timeBonus: 0, timerInterval: null, isBossStage: false, isAnswered: false,
    lives: 3, maxLives: 3, isPaused: false,
    timeExtensions: 3, maxTimeExtensions: 3, extendedTime: 0, // ã‚¿ã‚¤ãƒ å»¶é•·ï¼ˆTime Extensionï¼‰ã®ä»•çµ„ã¿
    timerCuePlayed: false
};

// æ­£ç¢ºãªå’Œäº†åˆ¤å®šï¼ˆ4é¢å­1é›€é ­ï¼‰
function isWinningHand(counts) {
    for (let head = 1; head <= 9; head++) {
        if (counts[head] >= 2) {
            const newCounts = {...counts};
            newCounts[head] -= 2;
            if (canFormMentsu(newCounts)) {
                return true;
            }
        }
    }
    return false;
}

// é¢å­ï¼ˆåˆ»å­/é †å­ï¼‰ã‚’çµ„ã‚ã‚‹ã‹åˆ¤å®š
function canFormMentsu(counts) {
    let totalTiles = 0;
    for (let i = 1; i <= 9; i++) {
        totalTiles += counts[i];
    }
    
    if (totalTiles === 0) return true;
    if (totalTiles % 3 !== 0) return false;
    
    let firstTile = 0;
    for (let i = 1; i <= 9; i++) {
        if (counts[i] > 0) {
            firstTile = i;
            break;
        }
    }
    
    if (firstTile === 0) return true;
    
    const newCounts = { ...counts };
    
    // ã¾ãšåˆ»å­ï¼ˆåŒç‰Œ3æšï¼‰ã‚’è©¦ã™
    if (newCounts[firstTile] >= 3) {
        newCounts[firstTile] -= 3;
        if (canFormMentsu(newCounts)) {
            return true;
        }
        newCounts[firstTile] += 3;
    }
    
    // æ¬¡ã«é †å­ï¼ˆé€£ç¶š3æšï¼‰ã‚’è©¦ã™
    if (firstTile <= 7 && newCounts[firstTile] > 0 && newCounts[firstTile + 1] > 0 && newCounts[firstTile + 2] > 0) {
        newCounts[firstTile]--;
        newCounts[firstTile + 1]--;
        newCounts[firstTile + 2]--;
        if (canFormMentsu(newCounts)) {
            return true;
        }
    }
    
    return false;
}

// è´ç‰Œï¼ˆå¾…ã¡ç‰Œï¼‰ã‚’è¨ˆç®—
function calculateWinningTiles(counts) {
    const winningTiles = [];
    
    for (let tile = 1; tile <= 9; tile++) {
        if (counts[tile] >= 4) continue;
        const newCounts = {...counts};
        newCounts[tile]++;
        
        if (isWinningHand(newCounts)) {
            winningTiles.push(tile);
        }
    }
    return winningTiles;
}

// é›£æ˜“åº¦ã«å¿œã˜ã¦å¾…ã¡ã®æ•°ãŒæ¡ä»¶ã‚’æº€ãŸã™ã‹åˆ¤å®š
function isValidWinningTilesCount(count, difficulty, attempts) {
    if (difficulty === 'easy') {
        if (attempts <= 5) return count === 3;
        if (attempts <= 10) return count >= 2 && count <= 3;
        return count >= 1 && count <= 3;
    } else if (difficulty === 'medium') {
        if (attempts <= 20) return count === 6;
        if (attempts <= 40) return count >= 5 && count <= 6;
        if (attempts <= 80) return count >= 4 && count <= 6;
        if (attempts <= 160) return count >= 3 && count <= 6;
        if (attempts <= 320) return count >= 2 && count <= 6;
        return count >= 1 && count <= 6;
    } else { // ä¸Šç´š
        if (attempts <= 10) return count === 9;
        if (attempts <= 80) return count >= 8 && count <= 9;
        if (attempts <= 1280) return count >= 7 && count <= 9;
        if (attempts <= 2560) return count >= 6 && count <= 9;
        if (attempts <= 5120) return count >= 5 && count <= 9;
        if (attempts <= 10240) return count >= 4 && count <= 9;
        if (attempts <= 20480) return count >= 3 && count <= 9;
        if (attempts <= 40960) return count >= 2 && count <= 9;
        return count >= 1 && count <= 9;
    }
}

// è´ç‰Œæ‰‹ç‰Œã‚’ç”Ÿæˆ
function generateTenpaiHand(difficulty) {
    let attempts = 0;
    
    do {
        attempts++;
        
        // ç‰Œã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        gameState.counts = {};
        for (let i = 1; i <= 9; i++) {
            gameState.counts[i] = 0;
        }
        gameState.hand = [];
        
        // 13æšã‚’ç”Ÿæˆï¼ˆå„ç‰Œã¯æœ€å¤§4æšï¼‰
        while (gameState.hand.length < 13) {
            const tile = Math.floor(Math.random() * 9) + 1;
            if (gameState.counts[tile] < 4) {
                gameState.hand.push(tile);
                gameState.counts[tile]++;
            }
        }
        
        // è´ç‰Œã‚’è¨ˆç®—
        const winningTiles = calculateWinningTiles(gameState.counts);
        
        // é›£æ˜“åº¦æ¡ä»¶ã‚’æº€ãŸã™ã‹ç¢ºèª
        if (isValidWinningTilesCount(winningTiles.length, difficulty, attempts)) {
            return { hand: gameState.hand, waiting: winningTiles, counts: gameState.counts };
        }
        
        // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
        if (attempts > 1000000) {
            console.warn('æ¡ä»¶ã«åˆã†æ‰‹ç‰Œã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç¾åœ¨ã®çµæœã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
            return { hand: gameState.hand, waiting: winningTiles, counts: gameState.counts };
        }
        
    } while (true);
}

function startTimer() {
    stopTimer();
    // ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸ã®æœ€å¤§æ™‚é–“ã‚’ä¿å­˜
    gameState.maxTime = gameState.isBossStage ? Math.max(0, gameState.timeLeft) : getMaxTime();
    gameState.isPaused = false;
    updateTimerDisplay();
    gameState.timerInterval = setInterval(() => {
        if (!gameState.isPaused) {
            gameState.timeLeft--;
            updateTimerDisplay();
            if (gameState.timeLeft <= 0) {
                stopTimer();
                handleTimeUp();
            }
        }
    }, 1000);

    // timerInterval è¨­å®šå¾Œã«æ“ä½œçŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹ï¼ˆå…ˆã«æ›´æ–°ã™ã‚‹ã¨é¸æŠç‰ŒãŒãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ï¼‰
    updateInteractionState();
}

function stopTimer() {
    if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
    }

    // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢æ™‚ã¯ä¸€æ—¦ã€Œä¸€æ™‚åœæ­¢ã€ã€‚å›ç­”é€ä¿¡æ™‚ï¼ˆisAnswered=trueï¼‰ã¯å®Œå…¨åœæ­¢ã€‚
    if (gameState.isAnswered) {
        stopTimerSound();
    } else {
        pauseTimerSound();
    }

    gameState.isPaused = false;
    // æ™‚é–“åˆ‡è¿«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è§£é™¤
    document.body.classList.remove('time-critical');
    hidePauseOverlay();
    updateInteractionState();
}

function pauseTimer() {
    if (!gameState.timerInterval || gameState.isAnswered) return;
    gameState.isPaused = true;
    pauseTimerSound();
    showPauseOverlay();
    updateInteractionState();
}

function resumeTimer() {
    if (!gameState.timerInterval) return;
    gameState.isPaused = false;
    hidePauseOverlay();
    if (gameState.timerCuePlayed && gameState.timeLeft <= 5 && !gameState.isAnswered) {
        startTimerSound();
    }
    updateInteractionState();
}

function isActiveQuestion() {
    return !!gameState.timerInterval && !gameState.isAnswered && !gameState.isPaused;
}

function updateInteractionState() {
    const submitBtn = document.getElementById('submit-btn');
    const nextBtn = document.getElementById('next-btn');
    const possibleTiles = document.getElementById('possible-tiles');
    const resultSection = document.getElementById('result-section');

    const active = isActiveQuestion();
    const hasSelection = gameState.selectedTiles && gameState.selectedTiles.size > 0;

    if (submitBtn) {
        submitBtn.disabled = !active || !hasSelection;
    }

    if (nextBtn) {
        const nextVisible = !nextBtn.classList.contains('hidden');
        nextBtn.disabled = !nextVisible || !gameState.isAnswered || gameState.isBossStage;
    }

    if (possibleTiles) {
        possibleTiles.style.pointerEvents = active ? '' : 'none';
    }

    updateTimeExtensionButton();
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('timer-display');
    const timerBar = document.getElementById('timer-bar');
    if (!timerElement || !timerBar) return;
    
    // ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸ã® maxTime ã‚’ä½¿ã£ã¦å‰²åˆã‚’è¨ˆç®—
    const percentage = (gameState.timeLeft / gameState.maxTime) * 100;
    timerElement.textContent = gameState.timeLeft;
    
    // CSS transition ã§æ»‘ã‚‰ã‹ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    timerBar.style.transition = 'width 1s linear';
    timerBar.style.width = `${Math.max(0, percentage)}%`;
    
    timerElement.className = 'timer-value';
    timerBar.className = 'timer-bar';
    
    // æ™‚é–“ãŒå°‘ãªã„ã¨ãã«èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
    if (gameState.timeLeft <= 5) {
        timerElement.classList.add('timer-danger');
        timerBar.classList.add('timer-bar-danger');
        document.body.classList.add('time-critical');

        if (!gameState.timerCuePlayed && gameState.timeLeft === 5) {
            gameState.timerCuePlayed = true;
            if (!gameState.isPaused && !gameState.isAnswered) startTimerSound();
        }
    } else {
        // 5ç§’ä»¥ä¸Šã«æˆ»ã£ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ã¯åœæ­¢ï¼ˆå»¶é•·ãªã©ï¼‰
        if (gameState.timerCuePlayed) {
            gameState.timerCuePlayed = false;
            stopTimerSound();
        }
        document.body.classList.remove('time-critical');
        if (gameState.timeLeft <= 10) {
            timerElement.classList.add('timer-warning');
            timerBar.classList.add('timer-bar-warning');
        }
    }

    // æ®‹ã‚Šæ™‚é–“ã«å¿œã˜ã¦å»¶é•·ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚‚è¿½éšã•ã›ã‚‹ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
    updateTimeExtensionButton();
}

function getMaxTime() {
    if (gameState.mode === 'casual') return 45;
    if (gameState.mode === 'story') return 30;
    if (gameState.mode === 'survival') return 60;
    return 0;
}

function handleTimeUp() {
    if (gameState.isAnswered) return;

    // 1æšã§ã‚‚é¸ã‚“ã§ã„ã‚Œã°ã€Œè‡ªå‹•æå‡ºã€ã¨ã—ã¦æ‰±ã†ï¼ˆselect éŸ³ã¯é³´ã‚‰ã•ãªã„ï¼‰
    if (gameState.selectedTiles && gameState.selectedTiles.size > 0) {
        checkAnswer({ force: true });
        return;
    }

    gameState.isAnswered = true;
    updateInteractionState();

    // æ™‚é–“åˆ‡ã‚Œç¢ºå®šï¼šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ã¯åœæ­¢
    stopTimerSound();

    // æœªæå‡ºã®æ™‚é–“åˆ‡ã‚Œï¼šincorrect ã§ã¯ãªã timeup ã‚’é³´ã‚‰ã™
    playSound('timeup');
    
    // ã‚µãƒã‚¤ãƒãƒ«ã¯æ™‚é–“åˆ‡ã‚Œã§å³çµ‚äº†
    if (gameState.mode === 'survival') {
        highlightAnswers();
        const section = document.getElementById('result-section');
        const message = document.getElementById('result-message');
        const nextBtn = document.getElementById('next-btn');
        if (section) {
            section.classList.remove('hidden');
            section.classList.add('slide-down');
        }
        if (message) {
            message.textContent = t('timeUp');
            message.className = 'text-3xl font-bold text-red-300 mb-6';
        }
        if (nextBtn) nextBtn.classList.add('hidden');
        hideResultActions();
        showGameOver(true);
        return;
    }
    
    // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ãƒ©ã‚¤ãƒ•åˆ¶
    if (gameState.mode === 'casual' || gameState.mode === 'story') {
        gameState.lives--;
        updateLivesDisplay();
        
        if (gameState.lives <= 0) {
            highlightAnswers();
            const section = document.getElementById('result-section');
            const message = document.getElementById('result-message');
            const nextBtn = document.getElementById('next-btn');
            if (section) {
                section.classList.remove('hidden');
                section.classList.add('slide-down');
            }
            if (message) {
                message.textContent = t('timeUp');
                message.className = 'text-3xl font-bold text-red-300 mb-6';
            }
            if (nextBtn) nextBtn.classList.add('hidden');
            hideResultActions();
            showGameOver(true);
        } else {
            // æ­£è§£è¡¨ç¤ºå¾Œã« Continue ã‚’å‡ºã™
            highlightAnswers();
            const section = document.getElementById('result-section');
            const message = document.getElementById('result-message');
            const nextBtn = document.getElementById('next-btn');
            section.classList.remove('hidden');
            section.classList.add('slide-down');
            message.textContent = t('timeUp');
            message.className = 'text-3xl font-bold text-red-300 mb-6';
            if (nextBtn) nextBtn.classList.add('hidden');
            showContinueOption();
        }
    }
}

function backToMenu() {
    resetGame();
}

function restartCurrentRun() {
    // ãƒ¢ãƒ¼ãƒ‰æœªé¸æŠãªã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
    if (!gameState.mode) {
        resetGame();
        return;
    }

    stopTimer();

    const mode = gameState.mode;
    const previousDifficulty = gameState.difficulty;

    // ç”»é¢çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    document.getElementById('victory-screen').classList.add('hidden');
    document.getElementById('gameover-screen').classList.add('hidden');
    document.getElementById('mode-screen').classList.add('hidden');
    document.getElementById('difficulty-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.body.classList.remove('boss-stage');
    document.body.classList.add('in-game');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    const resultSection = document.getElementById('result-section');
    resultSection.classList.add('hidden');
    hideResultActions();

    // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆmode ã¯ä¿æŒã€casual/survival ã¯ difficulty ã‚’ä¿æŒã€‚story ã¯å¿…ãš easy ã‹ã‚‰ï¼‰
    gameState.currentQuestion = 0;
    gameState.currentStage = 0;
    gameState.correctCount = 0;
    gameState.timeBonus = 0;
    gameState.hand = [];
    gameState.counts = {};
    gameState.waitingTiles = [];
    gameState.selectedTiles.clear();
    gameState.isBossStage = false;
    gameState.isAnswered = false;
    gameState.lives = 3;
    gameState.timeExtensions = gameState.maxTimeExtensions;
    gameState.extendedTime = 0;

    if (mode === 'story') {
        gameState.difficulty = 'easy';
    } else {
        gameState.difficulty = previousDifficulty;
    }

    document.getElementById('submit-btn').disabled = false;
    updateLivesDisplay();
    updateInteractionState();
    startNewQuestion();
}

function startGameMode(mode) {
    gameState.mode = mode;
    gameState.lives = 3; // ãƒ©ã‚¤ãƒ•ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('mode-screen').classList.add('hidden');
    if (mode === 'story') {
        gameState.difficulty = 'easy';
        gameState.currentQuestion = 0;
        gameState.currentStage = 0;
        gameState.correctCount = 0;
        gameState.timeBonus = 0;
        gameState.timeExtensions = gameState.maxTimeExtensions; // ã‚¿ã‚¤ãƒ å»¶é•·ã‚’ãƒªã‚»ãƒƒãƒˆ
        gameState.extendedTime = 0;
        document.getElementById('difficulty-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.body.classList.add('in-game');
        updateLivesDisplay();
        startNewQuestion();
    } else {
        document.getElementById('difficulty-screen').classList.remove('hidden');
    }
}

function startGameWithDifficulty(difficulty) {
    gameState.difficulty = difficulty;
    gameState.currentQuestion = 0;
    gameState.currentStage = 0;
    gameState.correctCount = 0;
    gameState.timeBonus = 0;
    gameState.lives = 3; // ãƒ©ã‚¤ãƒ•ã‚’ãƒªã‚»ãƒƒãƒˆ
    gameState.timeExtensions = gameState.maxTimeExtensions; // ã‚¿ã‚¤ãƒ å»¶é•·ã‚’ãƒªã‚»ãƒƒãƒˆ
    gameState.extendedTime = 0;
    document.getElementById('difficulty-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.body.classList.add('in-game');
    if (gameState.mode === 'survival') gameState.timeLeft = 60; // ã‚µãƒã‚¤ãƒãƒ«ã®åˆæœŸæ™‚é–“
    updateLivesDisplay();
    startNewQuestion();
}

async function startNewQuestion() {
    // å•é¡Œé€²è¡Œä¸­ï¼ˆã¾ãŸã¯ä¸€æ™‚åœæ­¢ä¸­ï¼‰ã®èª¤æ“ä½œã§æ¬¡ã¸é€²ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹
    if (gameState.timerInterval && !gameState.isAnswered) return;

    // æ¬¡ã¸ç§»ã‚‹å‰ã«çµæœè¡¨ç¤ºã‚’é–‰ã˜ã‚‹
    const resultSection = document.getElementById('result-section');
    if (resultSection) resultSection.classList.add('hidden');
    hideResultActions();

    // ã™ã¹ã¦ã®ãƒ¢ãƒ¼ãƒ‰ã§ currentStage ã‚’é€²ã‚ã‚‹
    gameState.currentStage++;
    
    const isBossEntry = (gameState.mode === 'casual' || gameState.mode === 'story') && gameState.currentStage === 10;

    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦é›£æ˜“åº¦ã‚’èª¿æ•´ï¼ˆéå ´è¡¨ç¤ºã«ã‚‚åæ˜ ï¼‰
    if (gameState.mode === 'story' && !isBossEntry) {
        if (gameState.currentStage <= 3) gameState.difficulty = 'easy';
        else if (gameState.currentStage <= 6) gameState.difficulty = 'medium';
        else gameState.difficulty = 'hard';
    }

    gameState.isBossStage = !!isBossEntry;
    updateQuestionDisplay();

    const stageTitle = isBossEntry
        ? t('bossStage')
        : `${t('stage')} ${gameState.currentStage}`;
    const subtitle = `${t('difficulty')} ${getDifficultyBadgeHtml(gameState.difficulty)} <span class="opacity-80">(${t(`${gameState.difficulty}Desc`)})</span>`;

    await showStageIntro({ titleText: stageTitle, subtitleHtml: subtitle, durationMs: 3800 });

    // ãƒœã‚¹ï¼ˆç¬¬10ã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰ã«å…¥ã‚‹ã‹åˆ¤å®š
    if (isBossEntry) {
        startBossStage();
        return;
    }

    // æ–°ã—ã„å•é¡Œã‚’ç”Ÿæˆ
    generateAndShowQuestion();
}

// å•é¡Œã‚’ç”Ÿæˆã—ã¦è¡¨ç¤ºï¼ˆstartNewQuestion / continueGame å…±é€šï¼‰
function generateAndShowQuestion() {
    gameState.selectedTiles.clear();
    gameState.isAnswered = false;
    gameState.extendedTime = 0; // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®å»¶é•·æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
    gameState.timerCuePlayed = false;
    stopTimerSound();
    
    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦é›£æ˜“åº¦ã‚’èª¿æ•´
    if (gameState.mode === 'story') {
        if (gameState.currentStage <= 3) gameState.difficulty = 'easy';
        else if (gameState.currentStage <= 6) gameState.difficulty = 'medium';
        else gameState.difficulty = 'hard';
    }
    
    // ãƒ©ãƒ³ãƒ€ãƒ èŠ±è‰²ï¼ˆç­’/è¬/ç´¢ï¼‰
    gameState.tileType = pickRandomTileType();

    const result = generateTenpaiHand(gameState.difficulty);
    if (!result) { 
        alert('å•é¡Œã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        resetGame();
        return; 
    }
    
    gameState.hand = result.hand;
    gameState.counts = result.counts;
    gameState.waitingTiles = result.waiting;
    
    document.body.classList.remove('boss-stage');
    document.getElementById('boss-indicator').classList.add('hidden');
    const resultSection = document.getElementById('result-section');
    resultSection.classList.add('hidden');
    hideResultActions();
      
    updateQuestionDisplay();
    renderHand();
    renderPossibleTiles();
    
    // ã‚µãƒã‚¤ãƒãƒ«ã¯ç¬¬9å•ã§æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆã€‚ãã‚Œä»¥å¤–ã¯æ—¢å®šã®æœ€å¤§æ™‚é–“ã‚’ä½¿ç”¨
    if (gameState.mode !== 'survival' || gameState.currentQuestion === 9) {
        gameState.timeLeft = getMaxTime();
    }
    startTimer();
}

function startBossStage() {
    gameState.isBossStage = true;
    gameState.isAnswered = false;
    gameState.selectedTiles.clear();

    // æœªä½¿ç”¨ã®å»¶é•·å›æ•°ã¯ã€BOSS ã®æŒ‘æˆ¦æ™‚é–“ã«ã¾ã¨ã‚ã¦åŠ ç®—ã™ã‚‹
    // ï¼ˆBOSS ã§ã¯å»¶é•·ã‚’ä½¿ãˆãªã„è¨­è¨ˆã®ãŸã‚ã€ã“ã“ã§è‡ªå‹•å¤‰æ›ã—ã¦å…¬å¹³ã«ã™ã‚‹ï¼‰
    if (gameState.mode === 'casual' || gameState.mode === 'story') {
        const unusedExtensions = Math.max(0, gameState.timeExtensions || 0);
        if (unusedExtensions > 0) {
            gameState.timeBonus += unusedExtensions * 30;
            gameState.timeExtensions = 0;
        }
    }

    generateAndShowBossQuestion({ resetTime: true });
}

function generateAndShowBossQuestion({ resetTime = false } = {}) {
    gameState.selectedTiles.clear();
    gameState.isAnswered = false;
    gameState.extendedTime = 0;
    gameState.timerCuePlayed = false;
    stopTimerSound();

    // ãƒ©ãƒ³ãƒ€ãƒ èŠ±è‰²ï¼ˆç­’/è¬/ç´¢ï¼‰
    gameState.tileType = pickRandomTileType();

    // ãƒœã‚¹ã¯ç¾åœ¨ã®é›£æ˜“åº¦ã‚’å¼•ãç¶™ãï¼ˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã¯é¸æŠå€¤ã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯7-9ã§ãƒãƒ¼ãƒ‰ã®æƒ³å®šï¼‰
    const result = generateTenpaiHand(gameState.difficulty);
    if (!result) {
        alert('BOSSå•é¡Œã‚’ç”Ÿæˆã§ãã¾ã›ã‚“');
        return;
    }

    gameState.hand = result.hand;
    gameState.counts = result.counts;
    gameState.waitingTiles = result.waiting;

    document.body.classList.add('boss-stage');
    // BOSS STAGE ã®ç½®é ‚è¡¨ç¤ºã¯ä½¿ã‚ãªã„ï¼ˆèƒŒæ™¯åŠ¹æœã§ååˆ†ï¼‰
    document.getElementById('boss-indicator').classList.add('hidden');
    const resultSection = document.getElementById('result-section');
    resultSection.classList.add('hidden');
    hideResultActions();

    updateQuestionDisplay();
    renderHand();
    renderPossibleTiles();

    if (resetTime) {
        // BOSS ã¯ç´¯ç©æ™‚é–“ã®ã¿ã€‚ãŸã ã—ç´¯ç©ãŒå°‘ãªã„å ´åˆã¯å„ãƒ¢ãƒ¼ãƒ‰ã®åŸºæœ¬ç§’æ•°ã‚’ä¸‹é™ã«ã™ã‚‹
        const baseTime = getMaxTime();
        gameState.timeLeft = Math.max(gameState.timeBonus, baseTime);
    }
    startTimer();
}

function updateQuestionDisplay() {
    const questionNum = document.getElementById('question-number');
    const stageInfo = document.getElementById('stage-info');

    const totalStages = (gameState.mode === 'casual' || gameState.mode === 'story') ? 10 : null;

    const diffKey = gameState.difficulty || 'easy';
    const diffName = t(diffKey);
    const diffDesc = t(`${diffKey}Desc`);

    const diffBadgeClass = diffKey === 'easy'
        ? 'difficulty-badge difficulty-badge--easy'
        : diffKey === 'medium'
            ? 'difficulty-badge difficulty-badge--medium'
            : 'difficulty-badge difficulty-badge--hard';

    const diffInfoHtml = `<span class="font-bold">${t('difficulty')}</span> ` +
        `<span class="${diffBadgeClass}">${diffName}</span>` +
        (diffDesc ? ` <span class="opacity-80">(${diffDesc})</span>` : '');

    // difficulty accent (mainly for Story Mode readability)
    if (questionNum) {
        questionNum.classList.remove('difficulty-accent--easy', 'difficulty-accent--medium', 'difficulty-accent--hard');
        if (!gameState.isBossStage && (gameState.mode === 'casual' || gameState.mode === 'story' || gameState.mode === 'survival')) {
            questionNum.classList.add(`difficulty-accent--${diffKey}`);
        }
    }

    if (gameState.isBossStage) {
        questionNum.textContent = t('bossStage');
        stageInfo.innerHTML = `${t('stage')} ${gameState.currentStage}ã€€${diffInfoHtml}`;
    } else {
        questionNum.textContent = `${t('stage')} ${gameState.currentStage}`;
        stageInfo.innerHTML = diffInfoHtml;
    }
    updateLivesDisplay();
    updateInteractionState();
}

function renderHand() {
    const container = document.getElementById('hand-tiles');
    container.innerHTML = '';
    const sorted = [...gameState.hand].sort((a, b) => a - b);
    sorted.forEach(tile => {
        const tileInfo = getTileInfo(gameState.tileType, tile);
        const div = document.createElement('div');
        div.className = 'hand-tile rounded-lg tile-shadow flex items-center justify-center';
        div.style.cssText = 'width: 48px; height: 68px; font-size: 36px;';
        div.appendChild(createTileImage(tileInfo));
        div.title = tileInfo.name;
        container.appendChild(div);
    });
}

function renderPossibleTiles() {
    const container = document.getElementById('possible-tiles');
    container.innerHTML = '';
    for (let tile = 1; tile <= 9; tile++) {
        const tileInfo = getTileInfo(gameState.tileType, tile);
        const div = document.createElement('div');
        div.className = 'selectable-tile rounded-xl tile-shadow tile-hover flex items-center justify-center cursor-pointer';
        div.style.cssText = 'width: 64px; height: 88px; font-size: 48px;';
        div.dataset.tile = tile;
        div.appendChild(createTileImage(tileInfo));
        div.title = tileInfo.name;
        div.addEventListener('click', () => toggleTileSelection(tile, div));
        container.appendChild(div);
    }
}

function toggleTileSelection(tile, element) {
    if (!isActiveQuestion()) return;

    playSound('tap');
    if (gameState.selectedTiles.has(tile)) {
        gameState.selectedTiles.delete(tile);
        element.classList.remove('selected');
    } else {
        gameState.selectedTiles.add(tile);
        element.classList.add('selected');
    }

    updateInteractionState();
}

function checkAnswer({ force = false } = {}) {
    if (gameState.isAnswered) return;
    if (!force && !isActiveQuestion()) return;
    gameState.isAnswered = true;
    stopTimer();
    const selected = Array.from(gameState.selectedTiles);
    const correct = gameState.waitingTiles;
    const isCorrect = selected.length === correct.length && selected.every(tile => correct.includes(tile));
    if (isCorrect) handleCorrectAnswer();
    else handleIncorrectAnswer();
    updateInteractionState();
}

function handleCorrectAnswer() {
    gameState.correctCount++;

    playSound('correct');
    
    // æ™‚é–“ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—ï¼ˆå…ƒã®æ™‚é–“ã®ã¿ã€‚å»¶é•·æ™‚é–“ã¯å«ã‚ãªã„ï¼‰
    // timeBonus ã¯ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ãƒœã‚¹ç”¨ã€‚ãƒœã‚¹è‡ªä½“ã§ã¯ timeBonus ã‚’åŠ ç®—ã—ãªã„ã€‚
    if (!gameState.isBossStage && (gameState.mode === 'casual' || gameState.mode === 'story')) {
        const maxTimeForStage = getMaxTime(); // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®å…ƒã®æœ€å¤§æ™‚é–“
        const actualBonus = Math.min(gameState.timeLeft, maxTimeForStage); // å…ƒã®æ™‚é–“åˆ†ã¾ã§ã‚’ä¸Šé™ã«åŠ ç®—
        gameState.timeBonus += actualBonus;
    }
    
    if (gameState.mode === 'survival') {
        let recovery = 0;
        if (gameState.difficulty === 'easy') recovery = 10;
        else if (gameState.difficulty === 'medium') recovery = 15;
        else if (gameState.difficulty === 'hard') recovery = 20;
        gameState.timeLeft += recovery;
    }
    showResult(true);
    highlightAnswers();
    
    // ãƒœã‚¹ã‚¯ãƒªã‚¢å¾Œã«å‹åˆ©è¡¨ç¤º
    if (gameState.isBossStage) {
        showResultOkAction({
            titleText: t('victory'),
            titleClassName: 'text-3xl font-black mb-3 text-green-300 text-center',
            bodyText: '',
            onOk: () => {
                playSound('victory');
                showVictory();
            }
        });
    }
}

function handleIncorrectAnswer() {
    playSound('incorrect');
    showResult(false);
    highlightAnswers();
    
    // ã‚µãƒã‚¤ãƒãƒ«ã¯ä¸æ­£è§£ã§å³çµ‚äº†
    if (gameState.mode === 'survival') {
        showGameOver(false);
        return;
    }
    
    // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ãƒ©ã‚¤ãƒ•åˆ¶
    if (gameState.mode === 'casual' || gameState.mode === 'story') {
        gameState.lives--;
        updateLivesDisplay();
        
        if (gameState.lives <= 0) {
            // ãƒ©ã‚¤ãƒ•ãŒå°½ããŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
            showGameOver(false);
        } else {
            // ãƒ©ã‚¤ãƒ•ãŒæ®‹ã£ã¦ã„ã‚Œã° Continue ã‚’è¡¨ç¤º
            showContinueOption();
        }
    }
}

function showResult(isCorrect) {
    const section = document.getElementById('result-section');
    const message = document.getElementById('result-message');
    const nextBtn = document.getElementById('next-btn');
    section.classList.remove('hidden');
    section.classList.add('slide-down');
    message.textContent = isCorrect ? t('correct') : t('incorrect');
    message.className = isCorrect ? 'text-3xl font-bold text-green-300 mb-6' : 'text-3xl font-bold text-red-300 mb-6';

    hideResultActions();
    
    // ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³è¡¨ç¤ºæ¡ä»¶
    if (isCorrect && !gameState.isBossStage) {
        if (gameState.mode === 'survival') {
            nextBtn.classList.remove('hidden');
        } else if (gameState.mode === 'casual' || gameState.mode === 'story') {
            // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼šç¬¬1ã€œ9å•ã¯ã€Œæ¬¡ã¸ã€ã‚’è¡¨ç¤º
            nextBtn.classList.remove('hidden');
        }
    } else {
        nextBtn.classList.add('hidden');
    }
    
    // çµæœè¡¨ç¤ºä¸­ã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯ã—ã¦èª¤æ“ä½œã‚’é˜²ã
    updateInteractionState();
}

function highlightAnswers() {
    const container = document.getElementById('possible-tiles');
    const tiles = container.querySelectorAll('[data-tile]');
    const selected = Array.from(gameState.selectedTiles);
    const correct = gameState.waitingTiles;
    const correctSelected = selected.filter(t => correct.includes(t));
    const missed = correct.filter(t => !selected.includes(t));
    const wrong = selected.filter(t => !correct.includes(t));
    tiles.forEach(element => {
        const tile = parseInt(element.dataset.tile);
        element.classList.remove('selected');
        if (correctSelected.includes(tile)) element.classList.add('correct-selected');
        else if (missed.includes(tile)) element.classList.add('correct-missed');
        else if (wrong.includes(tile)) element.classList.add('incorrect-selected');
    });
    displayCorrectAnswer();
    displayHandBreakdown();
}

function displayCorrectAnswer() {
    const container = document.getElementById('correct-answer-display');
    container.innerHTML = `<p class="text-xl font-bold mb-4 text-center">${t('correctAnswer')}</p>`;
    const tilesDiv = document.createElement('div');
    tilesDiv.className = 'flex gap-3 flex-wrap justify-center';
    gameState.waitingTiles.forEach(tile => {
        const tileInfo = getTileInfo(gameState.tileType, tile);
        const div = document.createElement('div');
        div.className = 'hand-tile rounded-lg tile-shadow flex items-center justify-center';
        div.style.cssText = 'width: 64px; height: 88px; font-size: 48px;';
        div.appendChild(createTileImage(tileInfo));
        div.title = tileInfo.name;
        tilesDiv.appendChild(div);
    });
    container.appendChild(tilesDiv);
}

// å’Œäº†ç‰Œå‹ã‚’ç†ç‰Œã—ã¦è¿”ã™
function getWinningHandBreakdown(handArray) {
    const counts = {};
    for (let i = 1; i <= 9; i++) counts[i] = 0;
    handArray.forEach(tile => counts[tile]++);

    for (let head = 1; head <= 9; head++) {
        if (counts[head] >= 2) {
            const tempCounts = { ...counts };
            tempCounts[head] -= 2;
            const melds = [];
            if (findMeldBreakdown(tempCounts, melds)) {
                return {
                    head: [head, head],
                    melds: melds
                };
            }
        }
    }
    return null;
}

function findMeldBreakdown(counts, melds) {
    let totalTiles = 0;
    for(let i = 1; i <= 9; i++) {
        totalTiles += counts[i];
    }
    if (totalTiles === 0) {
        return true;
    }

    // æœ€åˆã®ç‰Œã‚’æ¢ã™
    let firstTile = 0;
    for (let i = 1; i <= 9; i++) {
        if (counts[i] > 0) {
            firstTile = i;
            break;
        }
    }

    // å„ªå…ˆçš„ã«åˆ»å­ã‚’è©¦ã™
    if (counts[firstTile] >= 3) {
        const tempCounts = { ...counts };
        tempCounts[firstTile] -= 3;
        melds.push([firstTile, firstTile, firstTile]);
        if (findMeldBreakdown(tempCounts, melds)) {
            return true;
        }
        melds.pop(); // ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯
    }

    // é †å­ã‚’è©¦ã™
    if (firstTile <= 7 && counts[firstTile] > 0 && counts[firstTile + 1] > 0 && counts[firstTile + 2] > 0) {
        const tempCounts = { ...counts };
        tempCounts[firstTile]--;
        tempCounts[firstTile + 1]--;
        tempCounts[firstTile + 2]--;
        melds.push([firstTile, firstTile + 1, firstTile + 2]);
        if (findMeldBreakdown(tempCounts, melds)) {
            return true;
        }
        melds.pop(); // ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯
    }
    
    return false;
}

function displayHandBreakdown() {
    const container = document.getElementById('hand-breakdown');
    container.innerHTML = '';
    const handTiles = [...gameState.hand];
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
    const mainTitle = document.createElement('p');
    mainTitle.className = 'font-bold text-2xl mb-6 text-center text-yellow-300';
    mainTitle.innerHTML = t('allBreakdown');
    container.appendChild(mainTitle);
    
    // å¾…ã¡ç‰Œã‚’åˆ†é¡ï¼šæœªé¸æŠï¼ˆå„ªå…ˆè¡¨ç¤ºï¼‰ã¨é¸æŠæ¸ˆã¿
    const selected = Array.from(gameState.selectedTiles);
    const missedTiles = gameState.waitingTiles.filter(tile => !selected.includes(tile));
    const selectedTiles = gameState.waitingTiles.filter(tile => selected.includes(tile));
    
    // æœªé¸æŠã®ç‰Œã‚’å„ªå…ˆè¡¨ç¤ºï¼ˆé»„è‰²ï¼‰
    const sortedWaitingTiles = [...missedTiles, ...selectedTiles];
    
    // ã™ã¹ã¦ã®å¾…ã¡ç‰Œã«ã¤ã„ã¦ç‰Œå‹ã‚’è¡¨ç¤º
    for (const tile of sortedWaitingTiles) {
        const tempHand = [...handTiles, tile];
        const breakdown = getWinningHandBreakdown(tempHand);
        if (breakdown) {
            const tileInfo = getTileInfo(gameState.tileType, tile);
            const isMissed = missedTiles.includes(tile);
            
            // å„å¾…ã¡ç‰Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const sectionDiv = document.createElement('div');
            sectionDiv.className = `breakdown-section ${isMissed ? 'missed-tile' : 'selected-tile'}`;
            
            const breakdownTitle = document.createElement('h3');
            breakdownTitle.style.color = isMissed ? '#fbbf24' : '#22c55e';
            breakdownTitle.textContent = `${t('winningTile')}`;
            breakdownTitle.appendChild(createInlineHandTile(tileInfo));
            breakdownTitle.appendChild(document.createTextNode(` ${tileInfo.name}`));
            sectionDiv.appendChild(breakdownTitle);

            const breakdownFlex = document.createElement('div');
            breakdownFlex.className = 'flex flex-wrap gap-4 justify-center';
            
            // é›€é ­
            const headContainer = createTileGroup(breakdown.head, t('head'));
            breakdownFlex.appendChild(headContainer);

            // é¢å­
            for (const meld of breakdown.melds) {
                const meldContainer = createTileGroup(meld, t('meld'));
                breakdownFlex.appendChild(meldContainer);
            }
            sectionDiv.appendChild(breakdownFlex);
            container.appendChild(sectionDiv);
        }
    }
}

function createTileGroup(tileNumbers, label) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'tile-group';
    
    // è©³ç´°ãªç‰Œã®ç¨®é¡ã‚’èª¬æ˜
    /*
    let detailText = '';
    if (tileNumbers.length === 2) {
        detailText = `${t('pair')}${tileNumbers[0]}${t('pin')}`;
    } else if (tileNumbers.length === 3) {
        if (tileNumbers[0] === tileNumbers[1] && tileNumbers[1] === tileNumbers[2]) {
            detailText = `${t('triplet')}${tileNumbers[0]}${t('pin')}Ã—3`;
        } else {
            detailText = `${t('sequence')}${tileNumbers[0]}-${tileNumbers[1]}-${tileNumbers[2]}${t('pin')}`;
        }
    }
    */

    // è©³ç´°ãªç‰Œã®ç¨®é¡ã‚’èª¬æ˜
    let detailText = '';
    if (tileNumbers.length === 2) {
        detailText = `${t('pair')}`;
    } else if (tileNumbers.length === 3) {
        if (tileNumbers[0] === tileNumbers[1] && tileNumbers[1] === tileNumbers[2]) {
            detailText = `${t('triplet')}`;
        } else {
            detailText = `${t('sequence')}`;
        }
    }

    const labelDiv = document.createElement('div');
    labelDiv.className = 'tile-group-label';
    labelDiv.textContent = detailText;
    
    const tilesDiv = document.createElement('div');
    tilesDiv.className = 'flex gap-1 justify-center';
    tileNumbers.forEach(tileNum => {
        const tileInfo = getTileInfo(gameState.tileType, tileNum);
        const tileDiv = document.createElement('div');
        tileDiv.className = 'hand-tile rounded-lg tile-shadow flex items-center justify-center';
        tileDiv.style.cssText = 'width: 32px; height: 45px; font-size: 28px;';
        tileDiv.appendChild(createTileImage(tileInfo));
        tileDiv.title = tileInfo.name;
        tilesDiv.appendChild(tileDiv);
    });

    groupContainer.appendChild(labelDiv);
    groupContainer.appendChild(tilesDiv);
    return groupContainer;
}

function updateLivesDisplay() {
    // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ã¿ãƒ©ã‚¤ãƒ•ã‚’è¡¨ç¤º
    const livesContainer = document.getElementById('lives-display');
    if (!livesContainer) return;
    
    if (gameState.mode === 'casual' || gameState.mode === 'story') {
        livesContainer.classList.remove('hidden');
        livesContainer.innerHTML = `<span class="font-bold">${t('lives')}</span> `;
        for (let i = 0; i < gameState.maxLives; i++) {
            if (i < gameState.lives) {
                livesContainer.innerHTML += 'â¤ï¸';
            } else {
                livesContainer.innerHTML += 'ğŸ–¤';
            }
        }
    } else {
        livesContainer.classList.add('hidden');
    }
}

function updateTimeExtensionButton() {
    let extensionBtn = document.getElementById('time-extension-btn');
    
    // ãƒœã‚¿ãƒ³ãŒç„¡ã‘ã‚Œã°ä½œæˆ
    if (!extensionBtn) {
        const slot = document.getElementById('time-extension-slot') || document.querySelector('.timer-container');
        if (!slot) return;

        const btnContainer = document.createElement('div');
        btnContainer.innerHTML = `
            <button id="time-extension-btn" class="time-extension-btn">
                <span id="time-extension-text"></span>
            </button>
        `;
        slot.appendChild(btnContainer);
        extensionBtn = document.getElementById('time-extension-btn');
        extensionBtn.addEventListener('click', useTimeExtension);
    }
    
    // ãƒœã‚¿ãƒ³è¡¨ç¤ºã¨çŠ¶æ…‹ã‚’æ›´æ–°
    const textSpan = document.getElementById('time-extension-text');

    const active = isActiveQuestion();
    const canUseExtension = gameState.timeExtensions > 0 && !gameState.isBossStage && active;

    if (canUseExtension) {
        extensionBtn.disabled = false;
        extensionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        textSpan.textContent = `${t('timeExtension')} ${t('timeExtensionDesc')} (${t('extensionsLeft')} ${gameState.timeExtensions})`;
    } else {
        extensionBtn.disabled = true;
        extensionBtn.classList.add('opacity-50', 'cursor-not-allowed');
        if (gameState.isBossStage) {
            textSpan.textContent = `${t('timeExtension')} (BOSS ${t('stage')})`;
        } else if (!active) {
            textSpan.textContent = `${t('timeExtension')} (${t('extensionsLeft')} ${gameState.timeExtensions})`;
        } else {
            textSpan.textContent = `${t('timeExtension')} (${t('extensionsLeft')} 0)`;
        }
    }

    // æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªã„ & å»¶é•·å¯èƒ½ãªã‚‰ã€ãƒœã‚¿ãƒ³ã‚’å°‘ã—ç›®ç«‹ãŸã›ã‚‹
    const shouldAttention = canUseExtension && gameState.timeLeft <= 5;
    extensionBtn.classList.toggle('attention', !!shouldAttention);
}

function useTimeExtension() {
    if (!isActiveQuestion()) return;
    if (gameState.timeExtensions <= 0 || gameState.isBossStage || gameState.isAnswered) return;

    playSound('select');
    
    gameState.timeExtensions--;
    gameState.timeLeft += 30;
    gameState.extendedTime += 30; // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã§ä½¿ã£ãŸå»¶é•·æ™‚é–“ã‚’è¨˜éŒ²

    // å»¶é•·ã§ 5ç§’ä»¥ä¸Šã«æˆ»ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ã¯æ­¢ã‚ã‚‹
    if (gameState.timeLeft > 5) {
        gameState.timerCuePlayed = false;
        stopTimerSound();
    }
    
    updateTimeExtensionButton();
    
    // ãƒ’ãƒ³ãƒˆæ¼”å‡ºã‚’è¡¨ç¤º
    const timerDisplay = document.getElementById('timer-display');
    timerDisplay.classList.add('time-extended');
    setTimeout(() => {
        timerDisplay.classList.remove('time-extended');
    }, 1000);
}

function showContinueOption() {
    // çµæœè¡¨ç¤ºã¯åŒã˜ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§å®Œçµã•ã›ã‚‹
    showResultLifeAction();
}

async function continueGame() {
    // ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ã¯ã€Œè§£ç­”æ¸ˆã¿ã€ã‹ã¤ã€Œé€²è¡Œä¸­ã§ã¯ãªã„ã€å ´åˆã®ã¿è¨±å¯
    if (!gameState.isAnswered) return;

    hideResultActions();

    // ç¶šè¡Œæ™‚ã«çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆå¤ã„å†…å®¹ã®ç©ã¿é‡ãªã‚Šã‚’é˜²ãï¼‰
    const resultSection = document.getElementById('result-section');
    if (resultSection) resultSection.classList.add('hidden');

    // åŒä¸€ã‚¹ãƒ†ãƒ¼ã‚¸ã§æ–°ã—ã„å•é¡Œã‚’å‡ºã™ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸æ•°ã¯å¢—ã‚„ã•ãªã„ï¼‰
    // ãƒœã‚¹ã®ãƒªãƒˆãƒ©ã‚¤ã¯æ®‹ã‚Šç§’æ•°ã‚’å¼•ãç¶™ãã€æ—¢å®šç§’æ•°ã¸ãƒªã‚»ãƒƒãƒˆã—ãªã„
    const stageTitle = gameState.isBossStage
        ? t('bossStage')
        : `${t('stage')} ${gameState.currentStage}`;
    const subtitle = `${t('difficulty')} ${getDifficultyBadgeHtml(gameState.difficulty)} <span class="opacity-80">(${t(`${gameState.difficulty}Desc`)})</span>`;
    await showStageIntro({ titleText: stageTitle, subtitleHtml: subtitle, durationMs: 3200 });

    if (gameState.isBossStage) {
        generateAndShowBossQuestion({ resetTime: false });
        return;
    }
    generateAndShowQuestion();
}

function giveUpGame() {
    // å³ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
    showGameOver(false);
}

function showVictory() {
    document.getElementById('game-screen').classList.add('hidden');
    const screen = document.getElementById('victory-screen');
    screen.classList.remove('hidden');
    // ã™ã¹ã¦ã®ãƒ¢ãƒ¼ãƒ‰ã§ currentStage ã‚’ä½¿ç”¨
    document.getElementById('final-questions').textContent = gameState.currentStage;
    document.getElementById('final-correct').textContent = gameState.correctCount;

    const timeLeftEl = document.getElementById('final-time-left');
    if (timeLeftEl) timeLeftEl.textContent = String(Math.max(0, gameState.timeLeft || 0));

    const livesEl = document.getElementById('final-lives-left');
    const livesLabelEl = document.getElementById('final-lives-left-label');
    if (livesEl && livesLabelEl) {
        if (gameState.mode === 'casual' || gameState.mode === 'story') {
            livesEl.textContent = '';
            for (let i = 0; i < (gameState.maxLives || 3); i++) {
                livesEl.textContent += i < (gameState.lives || 0) ? 'â¤ï¸' : 'ğŸ–¤';
            }
            livesLabelEl.parentElement?.classList.remove('hidden');
        } else {
            // å¿µã®ãŸã‚ï¼ˆç¾çŠ¶ victory ã¯ boss ã‚¯ãƒªã‚¢æ™‚ã®ã¿ï¼‰
            livesLabelEl.parentElement?.classList.add('hidden');
        }
    }

    createConfetti();
    // 16:9 å›ºå®šãƒ•ãƒ¬ãƒ¼ãƒ è¨­è¨ˆï¼šãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ä½¿ã‚ãªã„
}

function showGameOver(timeUp) {
    const section = document.getElementById('result-section');
    const message = document.getElementById('result-message');
    const nextBtn = document.getElementById('next-btn');

    if (section && section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        section.classList.add('slide-down');
    }

    if (message) {
        message.textContent = timeUp ? t('timeUp') : t('incorrect');
        message.className = 'text-3xl font-bold text-red-300 mb-6';
    }

    if (nextBtn) nextBtn.classList.add('hidden');
    hideResultActions();
    showResultGameOverAction(timeUp);
    updateInteractionState();
}

function showGameOverOverlay(timeUp) {
    document.getElementById('game-screen').classList.add('hidden');
    const screen = document.getElementById('gameover-screen');
    screen.classList.remove('hidden');
    const message = document.getElementById('gameover-message');
    message.textContent = timeUp ? t('timeUp') : '';
    document.getElementById('final-score').textContent = gameState.correctCount;
    // 16:9 å›ºå®šãƒ•ãƒ¬ãƒ¼ãƒ è¨­è¨ˆï¼šãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ä½¿ã‚ãªã„
}

function createConfetti() {
    const screen = document.getElementById('victory-screen');
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#FFD93D'];
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 3 + 's';
        confetti.style.animationDuration = (Math.random() * 2 + 3) + 's';
        screen.appendChild(confetti);
        setTimeout(() => confetti.remove(), 6000);
    }
}

function updateUILanguage() {
    document.getElementById('header-title').textContent = t('gameTitle');
    document.getElementById('header-subtitle').textContent = t('gameSubtitle');
    
    // è¨€èªé¸æŠç”»é¢
    document.getElementById('language-title').textContent = t('selectLanguage');
    document.getElementById('lang-ja-text').textContent = t('japanese');
    document.getElementById('lang-en-text').textContent = t('english');
    document.getElementById('lang-zh-text').textContent = t('chinese');
    
    // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
    document.getElementById('mode-title').textContent = t('selectMode');
    document.getElementById('casual-title').textContent = t('casualMode');
    document.getElementById('casual-desc').textContent = t('casualDesc');
    document.getElementById('story-title').textContent = t('storyMode');
    document.getElementById('story-desc').textContent = t('storyDesc');
    document.getElementById('survival-title').textContent = t('survivalMode');
    document.getElementById('survival-desc').textContent = t('survivalDesc');
    
    // é›£æ˜“åº¦é¸æŠ
    document.getElementById('difficulty-title').textContent = t('selectDifficulty');
    document.getElementById('easy-title').textContent = t('easy');
    document.getElementById('easy-desc').textContent = t('easyDesc');
    document.getElementById('medium-title').textContent = t('medium');
    document.getElementById('medium-desc').textContent = t('mediumDesc');
    document.getElementById('hard-title').textContent = t('hard');
    document.getElementById('hard-desc').textContent = t('hardDesc');
    
    // ã‚²ãƒ¼ãƒ ç”»é¢
    document.getElementById('hand-title').textContent = t('handTitle');
    document.getElementById('select-waiting-title').textContent = t('selectWaiting');
    document.getElementById('submit-text').textContent = t('submitAnswer');
    document.getElementById('next-text').textContent = t('nextQuestion');
    const resultMenuText = document.getElementById('result-menu-text');
    if (resultMenuText) resultMenuText.textContent = t('backToMenu');

    const resultContinueText = document.getElementById('result-continue-text');
    const resultBackText = document.getElementById('result-back-text');
    const resultOkText = document.getElementById('result-ok-text');
    if (resultContinueText) resultContinueText.textContent = t('continue');
    if (resultBackText) resultBackText.textContent = t('giveUp');
    if (resultOkText) resultOkText.textContent = t('ok');
    
    
    // å‹åˆ©/æ•—åŒ—ç”»é¢
    const resultOpen = !!document.getElementById('result-section') && !document.getElementById('result-section').classList.contains('hidden');
    document.getElementById('gameover-title').textContent = t('gameOver');
    document.getElementById('final-questions-label').textContent = t('finalQuestions');
    document.getElementById('final-correct-label').textContent = t('finalScore');
    const timeLeftLabel = document.getElementById('final-time-left-label');
    const livesLeftLabel = document.getElementById('final-lives-left-label');
    if (timeLeftLabel) timeLeftLabel.textContent = t('timeLeftLabel');
    if (livesLeftLabel) livesLeftLabel.textContent = t('livesLeftLabel');
    document.getElementById('final-score-label').textContent = t('finalScore');
    document.getElementById('play-again-victory').textContent = t('playAgain');
    document.getElementById('play-again-gameover').textContent = t('playAgain');
    document.getElementById('menu-victory').textContent = t('backToMenu');
    document.getElementById('menu-gameover').textContent = t('backToMenu');
    
    // ãƒ•ãƒƒã‚¿ãƒ¼
    document.getElementById('footer-text').innerHTML = `${t('footer')} &copy; 2025 Akira Akiyama`;
}

function showInfoOverlay({ titleText, bodyText }) {
    let overlay = document.getElementById('info-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'info-overlay';
        overlay.className = 'info-overlay hidden';
        overlay.innerHTML = `
            <div class="info-overlay-card">
                <div id="info-overlay-title" class="text-4xl font-black mb-4 text-center"></div>
                <div id="info-overlay-body" class="info-overlay-body text-xl mb-8 text-center"></div>
                <div class="flex justify-center">
                    <button id="info-overlay-ok" class="mode-btn action-btn"><span id="info-overlay-ok-text">OK</span></button>
                </div>
            </div>
        `;
        const root = document.getElementById('design-root');
        (root || document.body).appendChild(overlay);
    }

    const titleEl = document.getElementById('info-overlay-title');
    const bodyEl = document.getElementById('info-overlay-body');
    const okBtn = document.getElementById('info-overlay-ok');
    const okTextEl = document.getElementById('info-overlay-ok-text');

    if (titleEl) titleEl.textContent = titleText || '';
    if (bodyEl) bodyEl.textContent = bodyText || '';
    if (okTextEl) okTextEl.textContent = t('ok');

    overlay.classList.remove('hidden');
    overlay.classList.add('fade-in');

    if (okBtn) {
        okBtn.onclick = () => {
            overlay.classList.add('hidden');
        };
    }
}

function resetGame() {
    stopTimer();
    gameState.mode = null;
    gameState.difficulty = null;
    gameState.currentQuestion = 0;
    gameState.currentStage = 0;
    gameState.correctCount = 0;
    gameState.timeBonus = 0;
    gameState.hand = [];
    gameState.counts = {};
    gameState.waitingTiles = [];
    gameState.selectedTiles.clear();
    gameState.isBossStage = false;
    gameState.isAnswered = false;
    gameState.lives = 3;
    gameState.timeExtensions = gameState.maxTimeExtensions;
    document.body.classList.remove('boss-stage');
    document.body.classList.remove('in-game');
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('victory-screen').classList.add('hidden');
    document.getElementById('gameover-screen').classList.add('hidden');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    const resultSection = document.getElementById('result-section');
    if (resultSection) resultSection.classList.add('hidden');
    hideResultActions();
    
    document.getElementById('mode-screen').classList.remove('hidden');
    updateInteractionState();
}

function selectLanguage(lang) {
    currentLang = lang;
    document.documentElement.lang = lang;
    document.title = t('gameTitle').replace(/ğŸ€„/g, '').trim();
    updateUILanguage();

    // If user switches to English, avoid showing Man suit tiles mid-run.
    // (Images contain kanji, which is hard for many non-Japanese/Chinese players.)
    if (currentLang === 'en' && gameState?.tileType === 'man') {
        gameState.tileType = 'pin';
        const gameScreen = document.getElementById('game-screen');
        if (gameScreen && !gameScreen.classList.contains('hidden')) {
            try {
                renderHand();
                renderPossibleTiles();
            } catch {
                // ignore rendering failures during screen transitions
            }
        }
    }

    const languageScreen = document.getElementById('language-screen');
    const modeScreen = document.getElementById('mode-screen');
    languageScreen.style.opacity = '0';
    languageScreen.style.transform = 'scale(0.95)';
    setTimeout(() => {
        languageScreen.classList.add('hidden');
        languageScreen.style.opacity = '1';
        languageScreen.style.transform = 'scale(1)';
        modeScreen.classList.remove('hidden');
        modeScreen.classList.add('fade-in');
    }, 400);
}

function showPauseOverlay() {
    let overlay = document.getElementById('pause-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'pause-overlay';
        overlay.className = 'pause-overlay';
        overlay.innerHTML = `
            <div class="pause-content">
                <div class="text-6xl font-black mb-6">${t('paused')}</div>
                <div class="text-2xl opacity-80">${t('tapToResume')}</div>
            </div>
        `;
        overlay.addEventListener('click', resumeTimer);

        const root = document.getElementById('design-root');
        (root || document.body).appendChild(overlay);
    }
    overlay.classList.remove('hidden');
    overlay.classList.add('fade-in');
}

function hidePauseOverlay() {
    const overlay = document.getElementById('pause-overlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initSounds();
    initTimerSound();
    applyUiScale();
    window.addEventListener('resize', applyUiScale);
    window.visualViewport?.addEventListener('resize', applyUiScale);

    // Prime audio on the first user gesture (needed on iOS browsers)
    document.addEventListener('pointerdown', unlockAudioOnce, { capture: true, once: true });
    document.addEventListener('touchstart', unlockAudioOnce, { capture: true, once: true, passive: true });

    document.getElementById('lang-ja').addEventListener('click', () => { playSound('select'); selectLanguage('ja'); });
    document.getElementById('lang-en').addEventListener('click', () => { playSound('select'); selectLanguage('en'); });
    document.getElementById('lang-zh').addEventListener('click', () => { playSound('select'); selectLanguage('zh'); });
    document.getElementById('casual-btn').addEventListener('click', () => { playSound('select'); startGameMode('casual'); });
    document.getElementById('story-btn').addEventListener('click', () => { playSound('select'); startGameMode('story'); });
    document.getElementById('survival-btn').addEventListener('click', () => { playSound('select'); startGameMode('survival'); });

    const storyInfoBtn = document.getElementById('story-info-btn');
    if (storyInfoBtn) {
        storyInfoBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            playSound('tap');
            showInfoOverlay({ titleText: t('storyHelpTitle'), bodyText: t('storyHelpBody') });
        });
    }
    document.getElementById('easy').addEventListener('click', () => { playSound('select'); startGameWithDifficulty('easy'); });
    document.getElementById('medium').addEventListener('click', () => { playSound('select'); startGameWithDifficulty('medium'); });
    document.getElementById('hard').addEventListener('click', () => { playSound('select'); startGameWithDifficulty('hard'); });
    document.getElementById('submit-btn').addEventListener('click', () => { playSound('select'); checkAnswer(); });
    document.getElementById('next-btn').addEventListener('click', () => { playSound('select'); startNewQuestion(); });

    // å‹åˆ©/ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã®ãƒœã‚¿ãƒ³
    const playAgainVictory = document.getElementById('play-again-victory');
    const menuVictory = document.getElementById('menu-victory');
    const playAgainGameOver = document.getElementById('play-again-gameover');
    const menuGameOver = document.getElementById('menu-gameover');
    if (playAgainVictory) playAgainVictory.addEventListener('click', () => { playSound('select'); restartCurrentRun(); });
    if (menuVictory) menuVictory.addEventListener('click', () => { playSound('select'); backToMenu(); });
    if (playAgainGameOver) playAgainGameOver.addEventListener('click', () => { playSound('select'); restartCurrentRun(); });
    if (menuGameOver) menuGameOver.addEventListener('click', () => { playSound('select'); backToMenu(); });
    
    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±/å¾©å¸°ã‚’ç›£è¦–
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±/æœ€å°åŒ–
            pauseTimer();
        } else {
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°
            if (gameState.isPaused && gameState.timerInterval) {
                // è‡ªå‹•å†é–‹ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯å¾…ã¡ï¼‰
            }
        }
    });
    
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±ï¼ˆåˆ¥ã‚¢ãƒ—ãƒªã¸åˆ‡æ›¿ï¼‰
    window.addEventListener('blur', () => {
        pauseTimer();
    });
    
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°
    window.addEventListener('focus', () => {
        // è‡ªå‹•å†é–‹ã—ãªã„ï¼ˆä¸€æ™‚åœæ­¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¯ãƒªãƒƒã‚¯å¾…ã¡ï¼‰
    });
});
